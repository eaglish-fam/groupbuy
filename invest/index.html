<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æŠ•è³‡è¤‡åˆ©è¨ˆç®—å™¨ï½œä¸€æ¬¡æ€§ãƒ»å®šæœŸå®šé¡ãƒ»ä¸å®šæœŸç¾é‡‘æµãƒ»ç›®æ¨™åæ¨</title>
  <meta name="description" content="æ”¯æ´å°å¹£ã€åç›®/å¯¦è³ªå ±é…¬ã€æ‰‹çºŒè²»ã€ç¨…é‡‘ã€é€šè†¨ã€æ­¥é€²åŠ ç¢¼ã€XIRRã€ç›®æ¨™åæ¨ç­‰æƒ…å¢ƒçš„æŠ•è³‡è¤‡åˆ©è¨ˆç®—å™¨ã€‚" />
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html,body{height:100%;}
    /* å¡ç‰‡ */
    .card{ background:#fff; border-radius:1rem; box-shadow:0 1px 6px rgba(15,23,42,.08); padding:1rem; }
    @media (min-width:768px){ .card{ padding:1.5rem; } }

    /* æŒ‰éˆ• */
    .btn{ padding:.5rem .75rem; border-radius:.75rem; font-size:.875rem; font-weight:600; box-shadow:0 1px 4px rgba(0,0,0,.06); transition:transform .05s ease; }
    .btn:active{ transform:scale(0.98); }
    .btn-primary{ background:#2563EB; color:#fff; }
    .btn-primary:hover{ background:#1D4ED8; }
    .btn-ghost{ background:#F1F5F9; color:#334155; }
    .btn-ghost:hover{ background:#E2E8F0; }

    /* è¼¸å…¥æ¡† */
    .input{ width:100%; padding:.5rem .75rem; border:1px solid #CBD5E1; border-radius:.75rem; }
    .input:focus{ outline:none; box-shadow:0 0 0 2px rgba(37,99,235,.35); }

    .label{ font-size:.75rem; color:#64748B; }
    .value{ font-weight:600; }

    /* Tabï¼ˆå¡ç‰‡å¼ï¼‰ */
    .tab{ padding:.5rem .75rem; border-radius:.75rem; font-size:.875rem; font-weight:600; cursor:pointer; user-select:none; background:#F1F5F9; color:#334155; box-shadow:0 1px 3px rgba(0,0,0,.06); transition:background .15s, box-shadow .15s; }
    .tab:hover{ background:#E2E8F0; }
    .tab-active{ background:#2563EB; color:#fff; box-shadow:0 2px 6px rgba(37,99,235,.35); }
    .tab-inactive{ background:#F1F5F9; color:#334155; }

    /* KPI & è¡¨æ ¼ */
    .kpi{ display:grid; gap:.5rem; padding:.75rem; border-radius:.75rem; background:#F8FAFC; }
    .table{ width:100%; font-size:.875rem; border-collapse:separate; border-spacing:0 .25rem; }
    .table th{ text-align:left; color:#64748B; font-weight:600; padding: .25rem .25rem .5rem; }
    .table td{ padding:.25rem; }
  </style>
</head>
<body class="min-h-full bg-slate-100 text-slate-800">
  <header class="sticky top-0 z-20 backdrop-blur bg-white/75 border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center gap-4">
      <a href="/" class="text-xl md:text-2xl font-bold hover:opacity-90">æŠ•è³‡è¤‡åˆ©è¨ˆç®—å™¨</a>
      <div class="hidden md:block text-slate-500">ï½œä¸€æ¬¡æ€§ã€å®šæœŸå®šé¡ã€ä¸å®šæœŸã€æ­¥é€²åŠ ç¢¼ã€ç›®æ¨™åæ¨</div>
      <a href="/" class="btn btn-primary ml-auto hidden sm:inline-flex items-center gap-2"><span>ğŸ›’</span><span>å›åˆ°åœ˜è³¼é¦–é </span></a>
      <div class="flex items-center gap-2">
        <label class="text-sm text-slate-500">å¹£åˆ¥</label>
        <select id="currency" class="input !w-auto">
          <option value="TWD" selected>æ–°å°å¹£ï¼ˆNT$ï¼‰</option>
          <option value="USD">ç¾å…ƒï¼ˆUS$ï¼‰</option>
          <option value="NZD">ç´å¹£ï¼ˆNZ$ï¼‰</option>
          <option value="JPY">æ—¥åœ“ï¼ˆÂ¥ï¼‰</option>
          <option value="CNY">äººæ°‘å¹£ï¼ˆCNÂ¥ï¼‰</option>
          <option value="AUD">æ¾³å¹£ï¼ˆA$ï¼‰</option>
        </select>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 grid lg:grid-cols-12 gap-6">
    <!-- å·¦å´ï¼šè¼¸å…¥èˆ‡æ§åˆ¶ -->
    <section class="lg:col-span-5 card">
      <div class="md:hidden mb-3 w-full">
        <label class="label">è©¦ç®—æ¨¡å¼</label>
        <select id="modeSelect" class="input">
          <option value="lump">ğŸ’° ä¸€æ¬¡æ€§æŠ•å…¥</option>
          <option value="dca">ğŸ“… æ¯æœˆå®šæœŸå®šé¡</option>
          <option value="stepup">ğŸ“ˆ å®šæœŸä¸å®šé¡ï¼ˆæ­¥é€²åŠ ç¢¼ï¼‰</option>
          <option value="irregular">ğŸ—“ï¸ ä¸å®šæœŸ/ä¸å®šé¡</option>
          <option value="goal">ğŸ¯ ç›®æ¨™åæ¨</option>
        </select>
      </div>
      <div class="hidden md:flex flex-wrap gap-2 mb-4" id="tabs">
        <button data-tab="lump" class="tab tab-active">ğŸ’° ä¸€æ¬¡æ€§æŠ•å…¥</button>
        <button data-tab="dca" class="tab tab-inactive">ğŸ“… æ¯æœˆå®šæœŸå®šé¡</button>
        <button data-tab="stepup" class="tab tab-inactive">ğŸ“ˆ å®šæœŸä¸å®šé¡ï¼ˆæ­¥é€²åŠ ç¢¼ï¼‰</button>
        <button data-tab="irregular" class="tab tab-inactive">ğŸ—“ï¸ ä¸å®šæœŸ/ä¸å®šé¡</button>
        <button data-tab="goal" class="tab tab-inactive">ğŸ¯ ç›®æ¨™åæ¨</button>
      </div>

      <!-- å…±ç”¨åƒæ•¸ -->
      <div class="grid grid-cols-2 gap-3 mb-4">
        <div>
          <div class="label">å¹´åŒ–å ±é…¬ç‡ï¼ˆ%ï¼‰</div>
          <input id="annualReturn" type="number" step="0.01" value="8" class="input" />
        </div>
        <div>
          <div class="label">æŠ•è³‡æœŸé–“ï¼ˆå¹´ï¼‰</div>
          <input id="years" type="number" step="0.1" value="10" class="input" />
        </div>
        <div>
          <div class="label">è¤‡åˆ©é »ç‡</div>
          <select id="compoundFreq" class="input">
            <option value="1">æ¯å¹´</option>
            <option value="2">æ¯åŠå¹´</option>
            <option value="4">æ¯å­£</option>
            <option value="12" selected>æ¯æœˆ</option>
            <option value="365">æ¯æ—¥ï¼ˆè¿‘ä¼¼ï¼‰</option>
          </select>
        </div>
        <div>
          <div class="label">é€šè†¨ç‡ï¼ˆ%/å¹´ï¼Œè¨ˆç®—å¯¦è³ªï¼‰</div>
          <input id="inflation" type="number" step="0.01" value="2" class="input" />
        </div>
      </div>

      <details class="mb-4">
        <summary class="cursor-pointer text-sm text-slate-600">é€²éšé¸é …ï¼ˆæ‰‹çºŒè²» / ç¨…é‡‘ / èµ·å§‹æ—¥æœŸï¼‰</summary>
        <div class="mt-3 grid grid-cols-2 gap-3">
          <div>
            <div class="label">ç”³è³¼æ‰‹çºŒè²»ï¼ˆ%/æŠ•å…¥ï¼‰</div>
            <input id="feePct" type="number" step="0.01" value="0" class="input" />
          </div>
          <div>
            <div class="label">è´–å›æ‰‹çºŒè²»ï¼ˆ%/è³‡ç”¢ï¼‰</div>
            <input id="redeemPct" type="number" step="0.01" value="0" class="input" />
          </div>
          <div>
            <div class="label">å¹´åº¦ç®¡ç†è²»ï¼ˆ%/å¹´ï¼‰</div>
            <input id="mgmtPct" type="number" step="0.01" value="0" class="input" />
          </div>
          <div>
            <div class="label">è³‡æœ¬åˆ©å¾—ç¨…ï¼ˆ%/ç²åˆ©ï¼‰</div>
            <input id="taxPct" type="number" step="0.01" value="0" class="input" />
          </div>
          <div class="col-span-2">
            <div class="label">èµ·å§‹æ—¥æœŸï¼ˆä¸å®šæœŸç¾é‡‘æµèˆ‡XIRRä½¿ç”¨ï¼‰</div>
            <input id="startDate" type="date" class="input" />
          </div>
        </div>
      </details>

      <!-- å…§å®¹ï¼šä¸€æ¬¡æ€§æŠ•å…¥ -->
      <div id="panel-lump" class="space-y-3">
        <div>
          <div class="label">ä¸€æ¬¡æ€§æŠ•å…¥é‡‘é¡</div>
          <input id="lumpAmount" type="number" step="1000" value="300000" class="input" />
        </div>
        <div class="flex gap-2">
          <button class="btn btn-primary" onclick="runLump()">è¨ˆç®—</button>
          <button class="btn btn-ghost" onclick="resetInputs()">é‡ç½®</button>
        </div>
      </div>

      <!-- å…§å®¹ï¼šå®šæœŸå®šé¡ -->
      <div id="panel-dca" class="hidden space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="label">æ¯æœˆæŠ•å…¥é‡‘é¡</div>
            <input id="dcaAmount" type="number" step="100" value="10000" class="input" />
          </div>
          <div>
            <div class="label">æŠ•å…¥æ—¥ï¼ˆæ¯æœˆï¼‰</div>
            <input id="dcaDay" type="number" min="1" max="28" value="1" class="input" />
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-primary" onclick="runDCA()">è¨ˆç®—</button>
          <button class="btn btn-ghost" onclick="resetInputs()">é‡ç½®</button>
        </div>
      </div>

      <!-- å…§å®¹ï¼šæ­¥é€²åŠ ç¢¼ -->
      <div id="panel-stepup" class="hidden space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="label">åˆå§‹æ¯æœˆæŠ•å…¥</div>
            <input id="stepBase" type="number" step="100" value="8000" class="input" />
          </div>
          <div>
            <div class="label">æ¯å¹´åŠ ç¢¼ï¼ˆ%ï¼‰</div>
            <input id="stepPct" type="number" step="0.1" value="5" class="input" />
          </div>
          <div>
            <div class="label">åŠ ç¢¼é »ç‡</div>
            <select id="stepFreq" class="input">
              <option value="12" selected>æ¯å¹´ä¸€æ¬¡</option>
              <option value="6">æ¯åŠå¹´</option>
              <option value="3">æ¯å­£</option>
            </select>
          </div>
          <div>
            <div class="label">æœ€é«˜æ¯æœˆä¸Šé™</div>
            <input id="stepCap" type="number" step="100" value="0" class="input" placeholder="0=ä¸è¨­ä¸Šé™" />
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-primary" onclick="runStepUp()">è¨ˆç®—</button>
          <button class="btn btn-ghost" onclick="resetInputs()">é‡ç½®</button>
        </div>
      </div>

      <!-- å…§å®¹ï¼šä¸å®šæœŸä¸å®šé¡ -->
      <div id="panel-irregular" class="hidden space-y-3">
        <div class="kpi">
          <div class="text-sm text-slate-600">æ–°å¢ç¾é‡‘æµï¼ˆæŠ•å…¥ç‚ºæ­£ã€è´–å›ç‚ºè² ï¼‰ã€‚æœ€æœ«æ—¥è‡ªå‹•åŠ å…¥ã€ŒæœŸæœ«è³‡ç”¢ã€ç¾é‡‘æµä»¥è¨ˆç®— XIRRã€‚</div>
          <div class="flex gap-2">
            <button class="btn btn-ghost" onclick="addCashflowRow()">ï¼‹æ–°å¢ä¸€ç­†</button>
            <button class="btn btn-ghost" onclick="seedCashflows()">è¼‰å…¥ç¯„ä¾‹</button>
            <button class="btn btn-ghost" onclick="clearCashflows()">æ¸…ç©º</button>
          </div>
          <div class="overflow-auto border rounded-xl">
            <table class="table">
              <thead>
                <tr>
                  <th style="min-width:130px">æ—¥æœŸ</th>
                  <th style="min-width:130px">é‡‘é¡ï¼ˆæŠ•å…¥+ï¼è´–å›-ï¼‰</th>
                  <th>å‚™è¨»</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="cashflowBody"></tbody>
            </table>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="label">æœŸæœ«æ—¥æœŸï¼ˆè©•åƒ¹é»ï¼‰</div>
            <input id="endDate" type="date" class="input" />
          </div>
          <div>
            <div class="label">æœŸæœ«è³‡ç”¢å¸‚å€¼</div>
            <input id="endingValue" type="number" step="100" value="0" class="input" />
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-primary" onclick="runIrregular()">è¨ˆç®— & XIRR</button>
          <button class="btn btn-ghost" onclick="exportCashflows()">åŒ¯å‡ºCSV</button>
        </div>
      </div>

      <!-- å…§å®¹ï¼šç›®æ¨™åæ¨ -->
      <div id="panel-goal" class="hidden space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="label">ç›®æ¨™é‡‘é¡</div>
            <input id="goalTarget" type="number" step="1000" value="10000000" class="input" />
          </div>
          <div>
            <div class="label">åæ¨é …ç›®</div>
            <select id="goalSolveFor" class="input">
              <option value="monthly" selected>æ‰€éœ€æ¯æœˆæŠ•å…¥</option>
              <option value="years">æ‰€éœ€å¹´æ•¸</option>
            </select>
          </div>
          <div id="goalMonthlyBox">
            <div class="label">ï¼ˆè‹¥è§£å¹´æ•¸ï¼‰é è¨­æ¯æœˆæŠ•å…¥</div>
            <input id="goalMonthly" type="number" step="100" value="10000" class="input" />
          </div>
          <div id="goalYearsBox">
            <div class="label">ï¼ˆè‹¥è§£æ¯æœˆï¼‰é è¨­å¹´æ•¸</div>
            <input id="goalYears" type="number" step="0.5" value="15" class="input" />
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-primary" onclick="runGoal()">é–‹å§‹åæ¨</button>
          <button class="btn btn-ghost" onclick="resetInputs()">é‡ç½®</button>
        </div>
      </div>
    </section>

    <!-- å³å´ï¼šè¼¸å‡ºèˆ‡åœ–è¡¨ -->
    <section class="lg:col-span-7 card">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="kpi">
          <div class="text-slate-500 text-xs">æœŸæœ«è³‡ç”¢</div>
          <div id="outFinal" class="text-2xl font-bold">â€”</div>
          <div class="text-slate-500 text-xs">ï¼ˆå¯¦è³ªï¼‰<span id="outFinalReal">â€”</span></div>
        </div>
        <div class="kpi">
          <div class="text-slate-500 text-xs">ç¸½æŠ•å…¥ / ç¸½å ±é…¬</div>
          <div class="value"><span id="outTotalIn">â€”</span> ï¼ <span id="outGain">â€”</span></div>
          <div class="text-slate-500 text-xs">æœ‰æ•ˆå¹´åŒ–ï¼ˆCAGRï¼‰ï¼š<span id="outCAGR">â€”</span></div>
        </div>
        <div class="kpi">
          <div class="text-slate-500 text-xs">XIRRï¼ˆä¸å®šæœŸï¼‰æˆ–åç¾©å¹´åŒ–</div>
          <div id="outXIRR" class="value">â€”</div>
          <div class="text-slate-500 text-xs">å«æ‰‹çºŒè²»/ç®¡ç†è²»/ç¨…é‡‘å¾Œä¼°ç®—</div>
        </div>
        <div class="kpi">
          <div class="text-slate-500 text-xs">æœŸé–“èˆ‡æœŸæ•¸</div>
          <div class="value"><span id="outYears">â€”</span> å¹´ ï¼ <span id="outPeriods">â€”</span> æœŸ</div>
          <div class="text-slate-500 text-xs">è¤‡åˆ©é »ç‡ï¼š<span id="outFreq">â€”</span>ï¼å¹´</div>
        </div>
      </div>

      <div class="mt-6">
        <canvas id="chart" height="120"></canvas>
      </div>

      <div class="mt-6">
        <details>
          <summary class="text-sm text-slate-600 cursor-pointer">å±•é–‹æŸ¥çœ‹æ˜ç´°è¡¨ï¼ˆæœŸåˆ¥ / æŠ•å…¥ / åˆ©æ¯ / æ‰‹çºŒè²» / ç¨…é‡‘ / çµé¤˜ï¼‰</summary>
          <div class="overflow-auto mt-3 border rounded-xl">
            <table class="table">
              <thead>
                <tr>
                  <th>æœŸæ•¸</th><th>æ—¥æœŸ</th><th>æŠ•å…¥</th><th>åˆ©æ¯</th><th>è²»ç”¨</th><th>ç¨…é‡‘</th><th>æœŸæœ«é¤˜é¡</th>
                </tr>
              </thead>
              <tbody id="detailBody"></tbody>
            </table>
          </div>
        </details>
      </div>
    </section>
  </main>

  <footer class="max-w-6xl mx-auto px-4 pb-10 text-center text-xs text-slate-500">
    â€» æœ¬å·¥å…·ç‚ºæ•™è‚²ç”¨é€”ä¹‹è©¦ç®—ï¼Œå¯¦éš›æŠ•è³‡è«‹è‡ªè¡Œè©•ä¼°é¢¨éšªèˆ‡ç¨…å‹™è¦å®šã€‚ï¼ Â© 2025
  </footer>

<script>
// === å·¥å…·å‡½å¼ ===
const $ = (id) => document.getElementById(id);
const fmt = new Intl.NumberFormat('zh-Hant-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 });
function setCurrency(code){
  currentCurrency = code;
  numberFmt = new Intl.NumberFormat('zh-Hant-TW', { style: 'currency', currency: code, maximumFractionDigits: 0 });
  runLast(); 
}
let currentCurrency = 'TWD';
let numberFmt = new Intl.NumberFormat('zh-Hant-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 });

function toPct(x){
  if (x==null || isNaN(x)) return 'â€”';
  return (x*100).toFixed(2)+'%';
}
function pctToRate(v){ return (parseFloat(v)||0)/100; }
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
function addDays(d, days){ const nd=new Date(d); nd.setDate(nd.getDate()+days); return nd; }
function monthAdd(d, m){ const nd = new Date(d); nd.setMonth(nd.getMonth()+m); return nd; }
function ymd(d){ if(!d) return ''; const z=new Date(d); return z.toISOString().slice(0,10); }

function resetDetail(){ $('detailBody').innerHTML=''; }
function pushDetail(i, date, inAmt, interest, fees, tax, bal){
  const tr = document.createElement('tr');
  const cells = [i, ymd(date)||'â€”', numberFmt.format(inAmt), numberFmt.format(interest), numberFmt.format(fees), numberFmt.format(tax), numberFmt.format(bal)];
  tr.innerHTML = cells.map(c=>`<td>${c}</td>`).join('');
  $('detailBody').appendChild(tr);
}

function netGrowthRate(annualReturn, mgmtPct, compoundFreq){
  // ä»¥åç¾©å¹´åŒ– rï¼Œæ‰£é™¤å¹´åº¦ç®¡ç†è²»å¾Œçš„ç­‰æ•ˆæ¯æœŸåˆ©ç‡
  const r = annualReturn - mgmtPct; // ç°¡åŒ–ï¼šå°‡ç®¡ç†è²»è¦–ç‚ºå¾å ±é…¬æ‰£é™¤
  return Math.pow(1 + r, 1/compoundFreq) - 1;
}

function applyFeesAndTax(gain, feePct, taxPct){
  const tax = Math.max(0, gain) * taxPct; // åƒ…å°æ­£å‘ç²åˆ©èª²ç¨…
  const afterTaxGain = gain - tax;
  const fee = 0; // å–®ç­†äº¤æ˜“è²»å¦è¨ˆæ–¼æŠ•å…¥/è´–å›
  return { afterTaxGain, tax };
}

function inflateToReal(nominalFinal, inflation, years){
  const real = nominalFinal / Math.pow(1+inflation, years);
  return real;
}

// === åœ–è¡¨ ===
let chart;
function renderChart(labels, series){
  const ctx = $('chart');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: 'è³‡ç”¢é¤˜é¡', data: series, fill: false }] },
    options: { responsive: true, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false } }, scales: { x: { ticks: { maxRotation: 0 } }, y: { beginAtZero: true } } }
  });
}

function updateKPIs({finalValue, finalReal, totalIn, gain, cagr, periods, freq, years, xirr}){
  $('outFinal').textContent = numberFmt.format(finalValue);
  $('outFinalReal').textContent = numberFmt.format(finalReal);
  $('outTotalIn').textContent = numberFmt.format(totalIn);
  $('outGain').textContent = numberFmt.format(gain);
  $('outCAGR').textContent = isFinite(cagr) && cagr> -1 ? toPct(cagr) : 'â€”';
  $('outPeriods').textContent = periods;
  $('outFreq').textContent = freq;
  $('outYears').textContent = years.toFixed(2);
  $('outXIRR').textContent = (xirr!=null && isFinite(xirr)) ? toPct(xirr) : 'â€”';
}

// === ä¸€æ¬¡æ€§æŠ•å…¥ ===
function runLump(){
  resetDetail();
  const PV = parseFloat($('lumpAmount').value)||0;
  const rA = pctToRate($('annualReturn').value);
  const nY = parseFloat($('years').value)||0;
  const m = parseInt($('compoundFreq').value)||12;
  const infl = pctToRate($('inflation').value);
  const feeIn = pctToRate($('feePct').value);
  const redeem = pctToRate($('redeemPct').value);
  const mgmt = pctToRate($('mgmtPct').value);
  const tax = pctToRate($('taxPct').value);
  const start = $('startDate').value? new Date($('startDate').value): new Date();

  const eff = netGrowthRate(rA, mgmt, m);
  let bal = PV * (1 - feeIn);
  let totalIn = PV * (1 - feeIn);
  let labels=[], series=[];
  let date = new Date(start);

  for(let i=1;i<=nY*m;i++){
    const interest = bal * eff;
    const { afterTaxGain, tax:taxAmt } = applyFeesAndTax(interest, 0, tax);
    bal += afterTaxGain;
    const fees = 0; // ç„¡é¡å¤–äº¤æ˜“
    if(i % m === 0){ labels.push(date.getFullYear()+"å¹´"+((date.getMonth()+1))+'æœˆ'); series.push(bal); }
    pushDetail(i, date, 0, afterTaxGain, fees, taxAmt, bal);
    date = monthAdd(date, 12/m);
  }
  const finalValue = bal * (1 - redeem);
  const finalReal = inflateToReal(finalValue, infl, nY);
  const gain = finalValue - totalIn;
  const cagr = Math.pow(finalValue/Math.max(1,totalIn), 1/nY) - 1;

  renderChart(labels, series);
  updateKPIs({finalValue, finalReal, totalIn, gain, cagr, periods: nY*m, freq:m, years:nY});
}

// === å®šæœŸå®šé¡ï¼ˆæ¯æœˆï¼‰ ===
function runDCA(){
  resetDetail();
  const amt = parseFloat($('dcaAmount').value)||0;
  const rA = pctToRate($('annualReturn').value);
  const nY = parseFloat($('years').value)||0;
  const m = parseInt($('compoundFreq').value)||12;
  const infl = pctToRate($('inflation').value);
  const feeIn = pctToRate($('feePct').value);
  const redeem = pctToRate($('redeemPct').value);
  const mgmt = pctToRate($('mgmtPct').value);
  const tax = pctToRate($('taxPct').value);
  const start = $('startDate').value? new Date($('startDate').value): new Date();

  const eff = netGrowthRate(rA, mgmt, m);
  let bal = 0, totalIn=0;
  let labels=[], series=[];
  let date = new Date(start);

  for(let i=1;i<=nY*m;i++){
    // ç•¶æœŸæŠ•å…¥ï¼ˆä»¥æ¯æœŸæŠ•å…¥è¿‘ä¼¼ï¼Œè‹¥é¸æ¯æœˆè¤‡åˆ©å‰‡å‰›å¥½ï¼‰
    let contribution = (m===12? amt : amt*(12/m));
    const fee = contribution * feeIn;
    contribution -= fee;
    bal += contribution;
    totalIn += (contribution + fee);

    const interest = bal * eff;
    const { afterTaxGain, tax:taxAmt } = applyFeesAndTax(interest, 0, tax);
    bal += afterTaxGain;

    if(i % m === 0){ labels.push(date.getFullYear()+"å¹´"+((date.getMonth()+1))+'æœˆ'); series.push(bal); }
    pushDetail(i, date, contribution, afterTaxGain, fee, taxAmt, bal);
    date = monthAdd(date, 12/m);
  }
  const finalValue = bal * (1 - redeem);
  const finalReal = inflateToReal(finalValue, infl, nY);
  const gain = finalValue - totalIn;
  // è¿‘ä¼¼CAGRï¼ˆåŸºæ–¼åŠ æ¬Šå¹³å‡æŠ•å…¥æ™‚é–“ä¸ç²¾ç¢ºï¼‰
  const cagr = Math.pow(finalValue / Math.max(1,totalIn), 1/nY) - 1;

  renderChart(labels, series);
  updateKPIs({finalValue, finalReal, totalIn, gain, cagr, periods: nY*m, freq:m, years:nY});
}

// === æ­¥é€²åŠ ç¢¼ ===
function runStepUp(){
  resetDetail();
  let base = parseFloat($('stepBase').value)||0;
  const stepPct = pctToRate($('stepPct').value);
  const stepFreq = parseInt($('stepFreq').value)||12;
  const cap = parseFloat($('stepCap').value)||0;

  const rA = pctToRate($('annualReturn').value);
  const nY = parseFloat($('years').value)||0;
  const m = parseInt($('compoundFreq').value)||12;
  const infl = pctToRate($('inflation').value);
  const feeIn = pctToRate($('feePct').value);
  const redeem = pctToRate($('redeemPct').value);
  const mgmt = pctToRate($('mgmtPct').value);
  const tax = pctToRate($('taxPct').value);
  const start = $('startDate').value? new Date($('startDate').value): new Date();

  const eff = netGrowthRate(rA, mgmt, m);
  let bal = 0, totalIn=0;
  let labels=[], series=[];
  let date = new Date(start);

  for(let i=1;i<=nY*m;i++){
    // è¨ˆç®—æœ¬æœŸæŠ•å…¥
    let thisMonth = base;
    if (cap>0) thisMonth = Math.min(thisMonth, cap);
    let contribution = (m===12? thisMonth : thisMonth*(12/m));
    const fee = contribution * feeIn;
    contribution -= fee;
    bal += contribution; totalIn += (contribution + fee);

    const interest = bal * eff;
    const { afterTaxGain, tax:taxAmt } = applyFeesAndTax(interest, 0, tax);
    bal += afterTaxGain;

    if(i % stepFreq === 0){ base *= (1 + stepPct); }

    if(i % m === 0){ labels.push(date.getFullYear()+"å¹´"+((date.getMonth()+1))+'æœˆ'); series.push(bal); }
    pushDetail(i, date, contribution, afterTaxGain, fee, taxAmt, bal);
    date = monthAdd(date, 12/m);
  }

  const finalValue = bal * (1 - redeem);
  const finalReal = inflateToReal(finalValue, infl, nY);
  const gain = finalValue - totalIn;
  const cagr = Math.pow(finalValue / Math.max(1,totalIn), 1/nY) - 1;
  renderChart(labels, series);
  updateKPIs({finalValue, finalReal, totalIn, gain, cagr, periods: nY*m, freq:m, years:nY});
}

// === ä¸å®šæœŸ/ä¸å®šé¡ + XIRR ===
function rowTemplate(d, amt, note){
  return `<tr>
    <td><input type="date" class="input" value="${d||''}" /></td>
    <td><input type="number" class="input" value="${amt||0}" step="100" /></td>
    <td><input type="text" class="input" value="${note||''}" /></td>
    <td><button class="btn btn-ghost" onclick="this.closest('tr').remove()">åˆªé™¤</button></td>
  </tr>`
}
function addCashflowRow(){
  $('cashflowBody').insertAdjacentHTML('beforeend', rowTemplate('', 0, ''));
}
function seedCashflows(){
  const now = $('startDate').value? new Date($('startDate').value): new Date();
  const rows = [
    [ymd(now), 50000, 'æœŸåˆ'],
    [ymd(monthAdd(now, 3)), 10000, 'ç¬¬4å€‹æœˆ'],
    [ymd(monthAdd(now, 7)), 20000, 'ç¬¬8å€‹æœˆ'],
    [ymd(monthAdd(now, 13)), 15000, 'ç¬¬14å€‹æœˆ']
  ];
  clearCashflows();
  rows.forEach(r=> $('cashflowBody').insertAdjacentHTML('beforeend', rowTemplate(r[0], r[1], r[2])));
}
function clearCashflows(){ $('cashflowBody').innerHTML=''; }

function exportCashflows(){
  const rows = [...$('cashflowBody').querySelectorAll('tr')].map(tr=>{
    const [d,a,n] = tr.querySelectorAll('input');
    return { date:d.value, amount:parseFloat(a.value)||0, note:n.value };
  });
  let csv = 'date,amount,note\n' + rows.map(r=>`${r.date},${r.amount},${r.note.replaceAll(',', ' ')}\n`).join('');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'cashflows.csv'; a.click(); URL.revokeObjectURL(url);
}

function daysBetween(a,b){ return (new Date(b)-new Date(a))/(1000*60*60*24); }
function xirr(cashflows){
  // ç¾é‡‘æµé™£åˆ—ï¼š[{date: Date, amount: Number} ...]ï¼Œæ±‚å¹´åŒ– XIRR
  // Newton-Raphson with fallback to bisection.
  if (cashflows.length<2) return NaN;
  const yearDays = 365;
  function npv(rate){
    const t0 = new Date(cashflows[0].date);
    return cashflows.reduce((sum, cf)=>{
      const t = daysBetween(t0, cf.date)/yearDays;
      return sum + cf.amount / Math.pow(1+rate, t);
    }, 0);
  }
  // Bracket search
  let lo=-0.9999, hi=10; // -99.99% ~ 1000%
  for(let i=0;i<100;i++){
    const mid = (lo+hi)/2; const v = npv(mid);
    if(Math.abs(v)<1e-6) return mid;
    const vlo = npv(lo);
    if (Math.sign(v)===Math.sign(vlo)) lo=mid; else hi=mid;
  }
  return (lo+hi)/2;
}

function runIrregular(){
  resetDetail();
  const rA = pctToRate($('annualReturn').value);
  const infl = pctToRate($('inflation').value);
  const mgmt = pctToRate($('mgmtPct').value);

  const endDate = $('endDate').value? new Date($('endDate').value): new Date();
  const endingValue = parseFloat($('endingValue').value)||0;

  const effDaily = Math.pow(1 + (rA - mgmt), 1/365) - 1;

  const rows = [...$('cashflowBody').querySelectorAll('tr')].map(tr=>{
    const [d,a,n] = tr.querySelectorAll('input');
    return { date:new Date(d.value), amount:parseFloat(a.value)||0, note:n.value };
  }).filter(r=>r.date instanceof Date && !isNaN(r.date));

  rows.sort((a,b)=> a.date-b.date);
  let bal = 0, totalIn=0; let labels=[], series=[];
  let cursor = rows.length? new Date(rows[0].date): new Date();

  // æ»¾å­˜è‡³æœŸæœ«ï¼ˆæ¯æ—¥è¤‡åˆ©è¿‘ä¼¼ï¼‰
  rows.forEach((r, idx)=>{
    // æˆé•·åˆ°æ­¤ç¾é‡‘æµæ—¥
    const gap = Math.max(0, Math.floor(daysBetween(cursor, r.date)));
    for(let d=0; d<gap; d++){
      bal *= (1 + effDaily);
    }
    cursor = new Date(r.date);

    // è¨˜éŒ„ç´°ç›®ï¼ˆæˆé•·æ—¥ï¼‰
    pushDetail(`D${idx}`, cursor, 0, bal*0, 0, 0, bal);

    // æ³¨å…¥ç¾é‡‘æµï¼ˆæŠ•å…¥ç‚ºæ­£ï¼Œè´–å›ç‚ºè² ï¼‰
    bal += r.amount;
    if(r.amount>0) totalIn += r.amount;
    pushDetail(`C${idx}`, cursor, r.amount, 0, 0, 0, bal);

    if(idx===0){ labels.push(ymd(cursor)); series.push(bal); }
  });

  // æˆé•·è‡³æœŸæœ«
  const gapEnd = Math.max(0, Math.floor(daysBetween(cursor, endDate)));
  for(let d=0; d<gapEnd; d++){ bal *= (1 + effDaily); }
  labels.push(ymd(endDate)); series.push(bal);

  // ç”¨XIRRï¼šå°‡æŠ•å…¥ï¼ˆ+ï¼‰èˆ‡æœŸæœ«è³‡ç”¢è¦–ç‚ºè´–å›ï¼ˆ-ï¼‰
  const cf = rows.map(r=>({date:r.date, amount:-r.amount}));
  cf.push({date:endDate, amount:endingValue});
  const irr = xirr(cf);

  const finalValue = endingValue;
  const years = (rows.length? daysBetween(rows[0].date, endDate): 0)/365;
  const finalReal = inflateToReal(finalValue, infl, years);
  const gain = finalValue - totalIn;

  renderChart(labels, series);
  updateKPIs({finalValue, finalReal, totalIn, gain, cagr: irr, periods: rows.length, freq: 'â€”', years, xirr: irr});
}

// === ç›®æ¨™åæ¨ ===
function solveMonthlyForTarget(target, rA, years, m){
  const i = netGrowthRate(rA, 0, m);
  // FV = PMT * [((1+i)^(n)-1)/i]  ==> PMT
  const n = Math.round(years*m);
  if (i===0) return target / n;
  return target * i / (Math.pow(1+i, n) - 1);
}
function solveYearsForTarget(target, rA, monthly, m){
  const i = netGrowthRate(rA, 0, m);
  // ä»¥äºŒåˆ†æ³•æœå°‹å¹´æ•¸
  let lo=0, hi=100; // æœ€å¤š100å¹´
  for(let k=0;k<100;k++){
    const mid=(lo+hi)/2; const n=Math.round(mid*m);
    const fv = (i===0)? monthly*n : monthly*((Math.pow(1+i, n)-1)/i);
    if (fv>=target) hi=mid; else lo=mid;
  }
  return (lo+hi)/2;
}
function runGoal(){
  resetDetail();
  const target = parseFloat($('goalTarget').value)||0;
  const mode = $('goalSolveFor').value;
  const rA = pctToRate($('annualReturn').value);
  const m = parseInt($('compoundFreq').value)||12;

  if(mode==='monthly'){
    const years = parseFloat($('goalYears').value)||10;
    const pmt = solveMonthlyForTarget(target, rA, years, m);
    const totalIn = pmt * years * m;
    const finalValue = target;
    const infl = pctToRate($('inflation').value);
    const finalReal = inflateToReal(finalValue, infl, years);
    const cagr = Math.pow(finalValue/Math.max(1,totalIn), 1/years)-1;
    updateKPIs({finalValue, finalReal, totalIn, gain:finalValue-totalIn, cagr, periods: Math.round(years*m), freq:m, years});
    renderChart(['0','ç›®æ¨™'], [0, finalValue]);
  } else {
    const monthly = parseFloat($('goalMonthly').value)||0;
    const years = solveYearsForTarget(target, rA, monthly, m);
    const totalIn = monthly * years * m;
    const infl = pctToRate($('inflation').value);
    const finalReal = inflateToReal(target, infl, years);
    const cagr = Math.pow(target/Math.max(1,totalIn), 1/years)-1;
    updateKPIs({finalValue: target, finalReal, totalIn, gain:target-totalIn, cagr, periods: Math.round(years*m), freq:m, years});
    renderChart(['0','ç›®æ¨™'], [0, target]);
  }
}

// === äº‹ä»¶ ===
$('currency').addEventListener('change', e=>{ setCurrency(e.target.value); runLast(); });

// æ‰‹æ©Ÿæ¨¡å¼ä¸‹æ‹‰åŒæ­¥
const modeSelectEl = document.getElementById('modeSelect');
if (modeSelectEl){
  modeSelectEl.value = 'lump'; 
  modeSelectEl.addEventListener('change', (e)=>{
    const key = e.target.value;
    Object.values(panels).forEach(p=> p.classList.add('hidden'));
    panels[key].classList.remove('hidden');
    lastRunner = ({lump:runLump, dca:runDCA, stepup:runStepUp, irregular:runIrregular, goal:runGoal})[key];
    resetDetail();
    if(key!=='irregular') runLast();
  });
}

// åˆ‡æ›åˆ†é 
const panels = {
  lump: $('panel-lump'),
  dca: $('panel-dca'),
  stepup: $('panel-stepup'),
  irregular: $('panel-irregular'),
  goal: $('panel-goal'),
};
let lastRunner = runLump;
function runLast(){ lastRunner && lastRunner(); }

document.querySelectorAll('#tabs button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#tabs button').forEach(b=> b.className = 'tab tab-inactive');
    btn.className = 'tab tab-active';
    Object.values(panels).forEach(p=> p.classList.add('hidden'));
    const key = btn.dataset.tab; 
    panels[key].classList.remove('hidden');
    lastRunner = ({lump:runLump, dca:runDCA, stepup:runStepUp, irregular:runIrregular, goal:runGoal})[key];
    resetDetail();
    if(key!=='irregular') runLast();
    const sel = document.getElementById('modeSelect');
    if(sel) sel.value = key;
  });
});

function resetInputs(){
  ['annualReturn','years','compoundFreq','inflation','feePct','redeemPct','mgmtPct','taxPct','lumpAmount','dcaAmount','stepBase','stepPct','stepCap','goalTarget','goalMonthly','goalYears'].forEach(id=>{
    const el = $(id); if(!el) return; const v = el.getAttribute('value'); if(v!=null) el.value = v; else if(el.tagName==='SELECT') el.selectedIndex=0; else el.value='';
  });
  clearCashflows();
  $('endingValue').value = 0; $('endDate').value = '';
  runLast();
}

// åˆå§‹
runLump();
</script>
</body>
</html>
