<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ” Google Sheets é€£ç·šè¨ºæ–·å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #1a1a1a;
      margin-bottom: 8px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 24px;
    }
    button {
      background: #10b981;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 12px;
      margin-bottom: 12px;
    }
    button:hover {
      background: #059669;
    }
    button.secondary {
      background: #3b82f6;
    }
    button.secondary:hover {
      background: #2563eb;
    }
    .log {
      background: #1a1a1a;
      color: #0f0;
      padding: 16px;
      border-radius: 8px;
      font-family: "Monaco", "Courier New", monospace;
      font-size: 13px;
      line-height: 1.5;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .status {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-weight: 500;
    }
    .status.success {
      background: #d1fae5;
      color: #065f46;
      border: 2px solid #10b981;
    }
    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #ef4444;
    }
    .status.warning {
      background: #fef3c7;
      color: #78350f;
      border: 2px solid #f59e0b;
    }
    input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 12px;
    }
    input:focus {
      outline: none;
      border-color: #3b82f6;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }
    .info-box {
      background: #eff6ff;
      border: 2px solid #3b82f6;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    .info-box h3 {
      margin-top: 0;
      color: #1e40af;
    }
    .info-box ul {
      margin: 8px 0;
      padding-left: 24px;
    }
    .info-box li {
      margin: 6px 0;
      color: #1e3a8a;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ” Google Sheets é€£ç·šè¨ºæ–·å·¥å…·</h1>
    <p class="subtitle">å¿«é€Ÿè¨ºæ–·æ‚¨çš„ Google Sheets è³‡æ–™è¼‰å…¥å•é¡Œ</p>
    
    <label for="sheetId">Google Sheets IDï¼š</label>
    <input 
      type="text" 
      id="sheetId" 
      value="1-RuyD9eCkrDpgFFXGHRWaTF-LYKaDK-MxAw3uNMozeU"
      placeholder="è²¼ä¸Šæ‚¨çš„ Google Sheets ID">
    
    <button onclick="testConnection()">ğŸš€ é–‹å§‹è¨ºæ–·</button>
    <button class="secondary" onclick="testPublished()">ğŸ“„ æ¸¬è©¦ç™¼ä½ˆ URL</button>
    <button class="secondary" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºè¨˜éŒ„</button>
  </div>

  <div class="card" id="statusCard" style="display: none;"></div>

  <div class="card">
    <h2>ğŸ“‹ è¨ºæ–·è¨˜éŒ„</h2>
    <div id="log" class="log">ç­‰å¾…æ¸¬è©¦...</div>
  </div>

  <div class="card">
    <div class="info-box">
      <h3>ğŸ’¡ å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ³•</h3>
      <ul>
        <li><strong>HTTP 403/404</strong>: Sheet æœªè¨­ç‚ºå…¬é–‹ â†’ ã€Œå…±ç”¨ã€â†’ã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººå¯æª¢è¦–ã€</li>
        <li><strong>CORS éŒ¯èª¤</strong>: ä½¿ç”¨ gviz API æ ¼å¼æˆ–ç™¼ä½ˆåˆ°ç¶²è·¯</li>
        <li><strong>æ”¶åˆ° HTML</strong>: æ¬Šé™æœªæ­£ç¢ºè¨­å®š â†’ å†æ¬¡æª¢æŸ¥å…±ç”¨è¨­å®š</li>
        <li><strong>ç©ºç™½å…§å®¹</strong>: Sheet å¯èƒ½æ˜¯ç©ºçš„æˆ–æ¬„ä½åç¨±ä¸ç¬¦</li>
      </ul>
    </div>
  </div>

  <script>
    const log = document.getElementById('log');
    const statusCard = document.getElementById('statusCard');

    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('zh-TW');
      const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
      log.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      log.scrollTop = log.scrollHeight;
    }

    function showStatus(message, type = 'success') {
      statusCard.style.display = 'block';
      statusCard.className = `card`;
      statusCard.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function clearLog() {
      log.textContent = 'è¨˜éŒ„å·²æ¸…ç©º...\n';
      statusCard.style.display = 'none';
    }

    async function testConnection() {
      clearLog();
      const sheetId = document.getElementById('sheetId').value.trim();
      
      if (!sheetId) {
        showStatus('âŒ è«‹è¼¸å…¥ Google Sheets ID', 'error');
        addLog('éŒ¯èª¤ï¼šæœªè¼¸å…¥ Sheet ID', 'error');
        return;
      }

      addLog(`é–‹å§‹æ¸¬è©¦ Sheet ID: ${sheetId}`);
      addLog('â”€'.repeat(60));

      // æ¸¬è©¦ 1: gviz API
      addLog('æ¸¬è©¦ 1: gviz API æ ¼å¼');
      const gvizUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;
      addLog(`URL: ${gvizUrl}`);

      try {
        const startTime = Date.now();
        const response = await fetch(gvizUrl, { 
          credentials: 'omit', 
          mode: 'cors',
          cache: 'no-cache'
        });
        const loadTime = Date.now() - startTime;

        addLog(`HTTP ç‹€æ…‹: ${response.status} ${response.statusText}`, 
          response.ok ? 'success' : 'error');
        addLog(`è¼‰å…¥æ™‚é–“: ${loadTime}ms`);
        addLog(`Content-Type: ${response.headers.get('content-type')}`);

        const text = await response.text();
        addLog(`å›æ‡‰é•·åº¦: ${text.length} å­—å…ƒ`);

        if (text.includes('<html') || text.includes('<!DOCTYPE')) {
          addLog('âš ï¸ æ”¶åˆ° HTML è€Œé CSVï¼', 'warning');
          addLog('é€™é€šå¸¸è¡¨ç¤ºæ¬Šé™è¨­å®šå•é¡Œ');
          addLog('å‰ 500 å­—å…ƒï¼š');
          addLog(text.substring(0, 500));
          showStatus('âŒ æ¬Šé™éŒ¯èª¤ï¼šè«‹å°‡ Sheet è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººå¯æª¢è¦–ã€', 'error');
        } else if (text.length === 0) {
          addLog('è­¦å‘Šï¼šå›æ‡‰æ˜¯ç©ºçš„', 'warning');
          showStatus('âš ï¸ Sheet å¯èƒ½æ˜¯ç©ºçš„æˆ–æ ¼å¼ä¸æ­£ç¢º', 'warning');
        } else {
          addLog('âœ… æˆåŠŸè¼‰å…¥ CSVï¼', 'success');
          addLog('å‰ 200 å­—å…ƒï¼š');
          addLog(text.substring(0, 200));
          
          // å˜—è©¦è§£æç¬¬ä¸€è¡Œï¼ˆæ¬„ä½åç¨±ï¼‰
          const firstLine = text.split('\n')[0];
          addLog(`æ¬„ä½åç¨±: ${firstLine}`);
          
          const lines = text.split('\n').filter(l => l.trim());
          addLog(`ç¸½è¡Œæ•¸: ${lines.length}`);
          
          showStatus(`âœ… é€£ç·šæˆåŠŸï¼å…± ${lines.length} è¡Œè³‡æ–™`, 'success');
        }

      } catch (error) {
        addLog(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
        showStatus(`âŒ é€£ç·šå¤±æ•—: ${error.message}`, 'error');
      }

      addLog('â”€'.repeat(60));

      // æ¸¬è©¦ 2: export API
      addLog('æ¸¬è©¦ 2: export API æ ¼å¼');
      const exportUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
      addLog(`URL: ${exportUrl}`);

      try {
        const response = await fetch(exportUrl, { credentials: 'omit' });
        addLog(`HTTP ç‹€æ…‹: ${response.status} ${response.statusText}`, 
          response.ok ? 'success' : 'error');

        const text = await response.text();
        if (text.includes('<html')) {
          addLog('âš ï¸ æ”¶åˆ° HTMLï¼ˆæ¬Šé™å•é¡Œï¼‰', 'warning');
        } else {
          addLog(`âœ… export API ä¹Ÿå¯ç”¨ï¼é•·åº¦: ${text.length}`, 'success');
        }
      } catch (error) {
        addLog(`export API å¤±æ•—: ${error.message}`, 'warning');
      }

      addLog('â”€'.repeat(60));
      addLog('è¨ºæ–·å®Œæˆï¼');
    }

    async function testPublished() {
      const sheetId = document.getElementById('sheetId').value.trim();
      if (!sheetId) {
        alert('è«‹å…ˆè¼¸å…¥ Sheet ID');
        return;
      }

      addLog('â”€'.repeat(60));
      addLog('æç¤ºï¼šå¦‚æœä»¥ä¸Šæ¸¬è©¦éƒ½å¤±æ•—ï¼Œè«‹ä½¿ç”¨ã€Œç™¼ä½ˆåˆ°ç¶²è·¯ã€åŠŸèƒ½ï¼š');
      addLog('1. åœ¨ Google Sheetsï¼šæª”æ¡ˆ â†’ ç™¼ä½ˆåˆ°ç¶²è·¯');
      addLog('2. é¸æ“‡ã€Œé€£çµã€â†’ã€ŒCSVã€æ ¼å¼');
      addLog('3. é»æ“Šã€Œç™¼ä½ˆã€');
      addLog('4. è¤‡è£½ç”¢ç”Ÿçš„ URL ä¸¦åœ¨æ­¤æ¸¬è©¦');
      
      const publishedUrl = prompt('è«‹è²¼ä¸Šã€Œç™¼ä½ˆåˆ°ç¶²è·¯ã€çš„ CSV URLï¼š');
      if (!publishedUrl) return;

      try {
        addLog(`æ¸¬è©¦ç™¼ä½ˆ URL: ${publishedUrl}`);
        const response = await fetch(publishedUrl);
        const text = await response.text();
        
        addLog(`ç‹€æ…‹: ${response.status}`, response.ok ? 'success' : 'error');
        addLog(`é•·åº¦: ${text.length}`);
        addLog('å‰ 200 å­—å…ƒï¼š');
        addLog(text.substring(0, 200));
        
        if (response.ok && text.length > 0) {
          showStatus('âœ… ç™¼ä½ˆ URL å¯ç”¨ï¼å»ºè­°ä½¿ç”¨æ­¤æ–¹å¼', 'success');
        }
      } catch (error) {
        addLog(`éŒ¯èª¤: ${error.message}`, 'error');
      }
    }

    // è‡ªå‹•åŸ·è¡Œä¸€æ¬¡æ¸¬è©¦
    window.addEventListener('load', () => {
      addLog('ğŸ‘‹ æ­¡è¿ä½¿ç”¨è¨ºæ–·å·¥å…·ï¼');
      addLog('é»æ“Šã€Œé–‹å§‹è¨ºæ–·ã€æŒ‰éˆ•ä¾†æ¸¬è©¦æ‚¨çš„ Google Sheets é€£ç·š');
      addLog('');
    });
  </script>
</body>
</html>
