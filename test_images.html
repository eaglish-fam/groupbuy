<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>圖片測試工具 - 鷹家買物社</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 p-8">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-amber-900 mb-6">🦅 鷹家買物社 - 圖片測試工具</h1>
    
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">📊 測試摘要</h2>
      <div id="summary" class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-blue-50 p-4 rounded">
          <div class="text-2xl font-bold text-blue-600" id="totalCount">-</div>
          <div class="text-sm text-gray-600">總產品數</div>
        </div>
        <div class="bg-green-50 p-4 rounded">
          <div class="text-2xl font-bold text-green-600" id="passCount">-</div>
          <div class="text-sm text-gray-600">圖片正常</div>
        </div>
        <div class="bg-red-50 p-4 rounded">
          <div class="text-2xl font-bold text-red-600" id="failCount">-</div>
          <div class="text-sm text-gray-600">圖片失敗</div>
        </div>
        <div class="bg-yellow-50 p-4 rounded">
          <div class="text-2xl font-bold text-yellow-600" id="noImageCount">-</div>
          <div class="text-sm text-gray-600">無圖片</div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <button id="startTest" class="bg-amber-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-amber-700">
        🚀 開始測試
      </button>
      <div id="progress" class="mt-4 hidden">
        <div class="w-full bg-gray-200 rounded-full h-4">
          <div id="progressBar" class="bg-amber-600 h-4 rounded-full transition-all" style="width: 0%"></div>
        </div>
        <p id="progressText" class="text-sm text-gray-600 mt-2">準備中...</p>
      </div>
    </div>

    <div id="results" class="space-y-4"></div>
  </div>

  <script>
    const CONFIG = {
      SHEET_ID: '1-RuyD9eCkrDpgFFXGHRWaTF-LYKaDK-MxAw3uNMozeU'
    };

    const ImageHelper = {
      normalizeGoogleDriveUrl(url) {
        if (!url || typeof url !== 'string') return null;
        if (url.includes('lh3.googleusercontent.com/d/')) return url;
        
        let fileId = null;
        const patterns = [
          /lh3\.googleusercontent\.com\/d\/([a-zA-Z0-9_-]+)/,
          /\/file\/d\/([a-zA-Z0-9_-]+)/,
          /\/d\/([a-zA-Z0-9_-]+)/,
          /[?&]id=([a-zA-Z0-9_-]+)/,
          /([a-zA-Z0-9_-]{25,})/
        ];
        
        for (const pattern of patterns) {
          const match = url.match(pattern);
          if (match && match[1] && match[1].length >= 25) {
            fileId = match[1];
            break;
          }
        }
        
        if (!fileId) return url;
        return `https://lh3.googleusercontent.com/d/${fileId}=w1200`;
      },

      getFallbackUrls(primaryUrl) {
        const fallbacks = [];
        if (!primaryUrl) return fallbacks;
        
        const fileId = this.extractFileId(primaryUrl);
        
        if (fileId) {
          if (!primaryUrl.includes('lh3.googleusercontent.com')) {
            fallbacks.push(`https://lh3.googleusercontent.com/d/${fileId}=w1200`);
          }
          fallbacks.push(`https://lh3.googleusercontent.com/d/${fileId}=w800`);
          fallbacks.push(`https://drive.google.com/thumbnail?id=${fileId}&sz=w800`);
          fallbacks.push(`https://drive.google.com/uc?export=view&id=${fileId}`);
        }
        
        if (primaryUrl && !fallbacks.includes(primaryUrl)) {
          fallbacks.unshift(primaryUrl);
        }
        
        return [...new Set(fallbacks)];
      },
      
      extractFileId(url) {
        if (!url) return null;
        const patterns = [
          /lh3\.googleusercontent\.com\/d\/([a-zA-Z0-9_-]+)/,
          /\/file\/d\/([a-zA-Z0-9_-]+)/,
          /\/d\/([a-zA-Z0-9_-]+)/,
          /[?&]id=([a-zA-Z0-9_-]+)/,
          /([a-zA-Z0-9_-]{25,})/
        ];
        
        for (const pattern of patterns) {
          const match = url.match(pattern);
          if (match && match[1] && match[1].length >= 25) {
            return match[1];
          }
        }
        return null;
      }
    };

    async function testImage(url) {
      return new Promise((resolve) => {
        const img = new Image();
        const timeout = setTimeout(() => {
          img.src = '';
          resolve(false);
        }, 5000);
        
        img.onload = () => {
          clearTimeout(timeout);
          resolve(true);
        };
        
        img.onerror = () => {
          clearTimeout(timeout);
          resolve(false);
        };
        
        img.src = url;
      });
    }

    async function runTests() {
      const startBtn = document.getElementById('startTest');
      const progress = document.getElementById('progress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const results = document.getElementById('results');
      
      startBtn.disabled = true;
      startBtn.textContent = '測試中...';
      progress.classList.remove('hidden');
      results.innerHTML = '';

      try {
        progressText.textContent = '正在載入資料...';
        const MAIN_CSV = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/export?format=csv`;
        const res = await fetch(MAIN_CSV, { credentials: 'omit' });
        const csv = await res.text();

        const products = [];
        Papa.parse(csv, {
          header: true,
          skipEmptyLines: true,
          transformHeader: h => (h || '').trim(),
          complete: r => {
            (r.data || []).forEach((row, i) => {
              const brand = (row['品牌'] || '').trim();
              if (!brand || brand.includes('---')) return;
              
              const url = (row['連結'] || '').trim();
              if (!url) return; // Skip products without URL
              
              let imageRaw = row['image'] || row['圖片網址'] || '';
              imageRaw = String(imageRaw).trim();
              
              if (!imageRaw || imageRaw === 'nan' || imageRaw === 'NaN') {
                imageRaw = '';
              }
              
              products.push({
                id: i,
                brand,
                url,
                image: imageRaw
              });
            });
          }
        });

        let passCount = 0;
        let failCount = 0;
        let noImageCount = 0;

        document.getElementById('totalCount').textContent = products.length;

        for (let i = 0; i < products.length; i++) {
          const product = products[i];
          const percent = ((i + 1) / products.length * 100).toFixed(0);
          progressBar.style.width = percent + '%';
          progressText.textContent = `測試中: ${product.brand} (${i + 1}/${products.length})`;

          let resultHTML = '';
          let statusClass = '';
          let statusIcon = '';
          let statusText = '';

          if (!product.image) {
            noImageCount++;
            statusClass = 'bg-yellow-50 border-yellow-200';
            statusIcon = '⚠️';
            statusText = '無圖片';
            resultHTML = `
              <div class="border-2 ${statusClass} rounded-lg p-4">
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <h3 class="font-bold text-lg">${statusIcon} ${product.brand}</h3>
                    <p class="text-sm text-gray-600 mt-1">${statusText}</p>
                  </div>
                  <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">無圖片</span>
                </div>
              </div>
            `;
          } else {
            const normalized = ImageHelper.normalizeGoogleDriveUrl(product.image);
            const fallbacks = ImageHelper.getFallbackUrls(normalized || product.image);
            
            let success = false;
            let workingUrl = null;
            
            for (const testUrl of fallbacks) {
              const result = await testImage(testUrl);
              if (result) {
                success = true;
                workingUrl = testUrl;
                break;
              }
            }

            if (success) {
              passCount++;
              statusClass = 'bg-green-50 border-green-200';
              statusIcon = '✅';
              statusText = '圖片載入成功';
            } else {
              failCount++;
              statusClass = 'bg-red-50 border-red-200';
              statusIcon = '❌';
              statusText = '所有 URL 都失敗';
            }

            resultHTML = `
              <div class="border-2 ${statusClass} rounded-lg p-4">
                <div class="flex items-start justify-between mb-3">
                  <div class="flex-1">
                    <h3 class="font-bold text-lg">${statusIcon} ${product.brand}</h3>
                    <p class="text-sm text-gray-600 mt-1">${statusText}</p>
                  </div>
                  ${success ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">OK</span>' : '<span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded">FAIL</span>'}
                </div>
                ${success ? `
                  <img src="${workingUrl}" alt="${product.brand}" class="w-full h-40 object-cover rounded mb-2">
                  <p class="text-xs text-gray-500 break-all">✅ ${workingUrl}</p>
                ` : `
                  <details class="text-xs">
                    <summary class="cursor-pointer text-red-600 font-medium mb-2">查看嘗試的 URLs (${fallbacks.length})</summary>
                    <div class="space-y-1 pl-4">
                      ${fallbacks.map(url => `<div class="text-gray-600 break-all">❌ ${url}</div>`).join('')}
                    </div>
                  </details>
                  <div class="mt-2 p-2 bg-red-100 rounded text-sm">
                    <strong>建議:</strong> 檢查圖片權限或重新上傳
                  </div>
                `}
              </div>
            `;
          }

          results.insertAdjacentHTML('beforeend', resultHTML);
          document.getElementById('passCount').textContent = passCount;
          document.getElementById('failCount').textContent = failCount;
          document.getElementById('noImageCount').textContent = noImageCount;
        }

        progressText.textContent = '測試完成!';
        startBtn.textContent = '✅ 測試完成';
        
      } catch (error) {
        progressText.textContent = '測試失敗: ' + error.message;
        startBtn.textContent = '❌ 測試失敗';
        results.innerHTML = `
          <div class="bg-red-50 border-2 border-red-200 rounded-lg p-6">
            <h3 class="font-bold text-red-800 mb-2">錯誤</h3>
            <p class="text-red-600">${error.message}</p>
          </div>
        `;
      }
    }

    document.getElementById('startTest').addEventListener('click', runTests);
  </script>
</body>
</html>
