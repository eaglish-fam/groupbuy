<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é·¹å®¶Funç”Ÿè²·ç‰©ç¤¾ - ç²¾é¸åœ˜è³¼ Â· å„ªè³ªå¥½ç‰©</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¦…</text></svg>">
  <meta property="og:title" content="ğŸ¦… é·¹å®¶Funç”Ÿè²·ç‰©ç¤¾">
  <meta property="og:description" content="ç²¾é¸åœ˜è³¼ Â· å„ªè³ªå¥½ç‰©">
  <meta property="og:type" content="website">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-white min-h-screen">
  <header class="bg-white/80 backdrop-blur-sm border-b border-amber-200 sticky top-0 z-20">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="text-center">
        <h1 class="text-2xl font-bold text-amber-900">ğŸ¦… é·¹å®¶Funç”Ÿè²·ç‰©ç¤¾</h1>
        <p class="text-sm text-amber-700">ç²¾é¸åœ˜è³¼ Â· å„ªè³ªå¥½ç‰©</p>
      </div>
      <div id="bannerSlot" class="max-w-4xl mx-auto mt-3 hidden"></div>
      <div id="sectionButtons" class="flex gap-2 justify-center overflow-x-auto pb-2 pt-3"></div>
      <div class="mt-3 max-w-3xl mx-auto">
        <div class="relative">
          <input id="searchInput" type="search" enterkeyhint="search" autocomplete="off" aria-label="æœå°‹å“ç‰Œ"
                 placeholder="æœå°‹å“ç‰Œåç¨±â€¦" class="w-full pl-3 pr-9 py-3 rounded-xl border-2 border-amber-200 focus:border-amber-400 focus:outline-none bg-white/80">
          <button id="clearBtn" title="æ¸…é™¤"
                  class="absolute right-2 top-1/2 -translate-y-1/2 hidden w-7 h-7 rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300">Ã—</button>
        </div>
      </div>
    </div>
  </header>

  <main id="content" class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex items-center justify-center min-h-[40vh]">
      <div class="text-center">
        <div class="text-4xl mb-4">ğŸ¦…</div>
        <div class="text-xl text-amber-900 font-bold">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
  </main>

  <div id="copyToast" class="fixed top-20 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-x-[200%] transition-all duration-300 z-50">âœ“ æŠ˜æ‰£ç¢¼å·²è¤‡è£½</div>

  <div id="videoModal" class="fixed inset-0 bg-black/75 z-50 hidden items-center justify-center p-4" onclick="closeVideoModal()">
    <div class="relative w-full max-w-4xl bg-white rounded-xl overflow-auto max-h-[90vh]" onclick="event.stopPropagation()">
      <button onclick="closeVideoModal()" class="absolute top-4 right-4 z-10 bg-red-600 text-white w-10 h-10 rounded-full hover:bg-red-700 text-xl font-bold">Ã—</button>
      <div id="videoContainer" class="w-full" style="aspect-ratio:16/9;"></div>
    </div>
  </div>

  <script>
    // ============ é…ç½® ============
    const CONFIG = {
      SHEET_ID: '1-RuyD9eCkrDpgFFXGHRWaTF-LYKaDK-MxAw3uNMozeU',
      BANNER_IMAGE_URL: "",
      BANNER_LINK_URL: "",
      REFRESH_INTERVAL: 5 * 60 * 1000,
      SEARCH_DEBOUNCE: 120
    };

    const STORAGE_KEYS = {
      search: 'eg_search',
      showExpired: 'eg_show_expired',
      month: 'eg_month'
    };

    // ============ ç‹€æ…‹ç®¡ç† ============
    const state = {
      searchTerm: '',
      groups: [],
      upcomingGroups: [],
      loading: true,
      error: null,
      showExpired: false,
      selectedCalendarMonth: 0
    };

    // ============ å·¥å…·å‡½æ•¸ ============
    const utils = {
      isURL: s => !!s && /^https?:\/\//i.test(s),
      isQA: s => !!s && s.includes('Q:') && s.includes('|A:'),
      normalizeBrand: s => (s || '').toLowerCase().replace(/\s+/g, '').trim(),
      isProbablyHTML: t => /<\/?html[\s>]/i.test(t) || /accounts\.google\.com/.test(t),
      formatCount: n => n > 99 ? '99+' : n > 9 ? '9+' : String(n),

      parseDateSafe(v) {
        if (!v) return null;
        if (typeof v === 'number') {
          const ms = Math.round((v - 25569) * 86400 * 1000);
          const d = new Date(ms);
          d.setHours(0, 0, 0, 0);
          return d;
        }
        const s = String(v).trim();
        const m = s.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);
        if (m) return new Date(+m[1], +m[2] - 1, +m[3]);
        const d = new Date(s);
        if (!isNaN(d)) {
          d.setHours(0, 0, 0, 0);
          return d;
        }
        return null;
      },

      getDaysLeft(endStr) {
        const end = this.parseDateSafe(endStr);
        if (!end) return null;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return Math.ceil((end - today) / 86400000);
      },

      isExpired(endStr) {
        const d = this.getDaysLeft(endStr);
        return d !== null && d < 0;
      },

      parseQA(qaString) {
        if (!qaString) return [];
        const norm = qaString
          .replace(/\r\n?/g, '\n')
          .replace(/[|ï½œ]\s*A\s*[ï¼š:]/g, '|A:')
          .replace(/Q\s*[ï¼š:]/g, 'Q:');
        const separated = norm.replace(/(\|A:[^\n]*?)\s+(?=Q:\s*)/g, '$1\n');
        const chunks = separated.split(/(?=Q:\s*)/g).map(s => s.trim()).filter(s => s.startsWith('Q:'));
        return chunks.map(chunk => {
          const m = chunk.match(/^Q:\s*(.*?)\s*\|A:\s*([\s\S]*?)$/);
          return m ? { q: m[1].trim(), a: m[2].trim() } : null;
        }).filter(Boolean);
      }
    };

    // ============ DOM å…ƒç´ ç·©å­˜ ============
    const elements = {
      content: document.getElementById('content'),
      searchInput: document.getElementById('searchInput'),
      clearBtn: document.getElementById('clearBtn'),
      sectionButtons: document.getElementById('sectionButtons'),
      copyToast: document.getElementById('copyToast'),
      videoModal: document.getElementById('videoModal'),
      videoContainer: document.getElementById('videoContainer'),
      bannerSlot: document.getElementById('bannerSlot')
    };

    // ============ Banner æ¸²æŸ“ ============
    function renderBanner() {
      if (!CONFIG.BANNER_IMAGE_URL) {
        elements.bannerSlot.innerHTML = "";
        elements.bannerSlot.classList.add('hidden');
        return;
      }
      let inner = `<img src="${CONFIG.BANNER_IMAGE_URL}" alt="banner" class="w-full max-h-56 object-cover rounded-xl border-2 border-amber-200 shadow-sm">`;
      if (CONFIG.BANNER_LINK_URL) {
        inner = `<a href="${CONFIG.BANNER_LINK_URL}" target="_blank" rel="noopener noreferrer">${inner}</a>`;
      }
      elements.bannerSlot.innerHTML = inner;
      elements.bannerSlot.classList.remove('hidden');
    }

    // ============ å½±ç‰‡è™•ç† ============
    const videoHandler = {
      loadedScripts: new Set(),

      addScriptOnce(id, src, onload) {
        if (this.loadedScripts.has(id)) {
          onload && onload();
          return;
        }
        const s = document.createElement('script');
        s.id = id;
        s.src = src;
        s.async = true;
        s.onload = () => {
          this.loadedScripts.add(id);
          onload && onload();
        };
        document.head.appendChild(s);
      },

      ensureFbRoot() {
        if (!document.getElementById('fb-root')) {
          const root = document.createElement('div');
          root.id = 'fb-root';
          document.body.appendChild(root);
        }
      },

      getRatioHint(url) {
        try {
          const u = new URL(url);
          const hash = (u.hash || '').toLowerCase();
          const qp = (u.searchParams.get('ratio') || '').toLowerCase();
          if (hash.includes('portrait') || qp === '9:16') return '9/16';
          if (hash.includes('landscape') || qp === '16:9') return '16/9';
        } catch {}
        return null;
      },

      buildVideoEmbed(url) {
        if (!url) return null;
        try {
          const u = new URL(url);
          const host = u.hostname.toLowerCase();

          // Google Drive
          if (host.includes('drive.google.com')) {
            const m = url.match(/[-\w]{25,}/);
            if (!m) return null;
            return {
              html: `<iframe src="https://drive.google.com/file/d/${m[0]}/preview" class="w-full h-full" frameborder="0" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`,
              ratio: this.getRatioHint(url) || '16/9'
            };
          }

          // YouTube
          if (host.includes('youtube.com') || host.includes('youtu.be')) {
            const id = (url.match(/youtu\.be\/([^?&/]+)/) || url.match(/[?&]v=([^?&/]+)/) || url.match(/shorts\/([^?&/]+)/) || [])[1];
            if (!id) return null;
            return {
              html: `<iframe src="https://www.youtube.com/embed/${id}?playsinline=1" class="w-full h-full" frameborder="0" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`,
              ratio: this.getRatioHint(url) || '9/16'
            };
          }

          // Instagram
          if (host.includes('instagram.com')) {
            const clean = u.origin + u.pathname.replace(/\/?$/, '/');
            return {
              html: `<blockquote class="instagram-media" data-instgrm-permalink="${clean}" data-instgrm-version="14" style="margin:0 auto; max-width:540px; width:100%"></blockquote>`,
              ratio: '9/16',
              after: () => this.addScriptOnce('ig-embed-js', 'https://www.instagram.com/embed.js', () => {
                window.instgrm?.Embeds?.process();
              })
            };
          }

          // Facebook
          if (host.includes('facebook.com') || host === 'fb.watch') {
            const isVideo = /\/watch\/|\/video|\/videos|fb\.watch/.test(url);
            return {
              html: isVideo ? `<div class="fb-video" data-href="${url}" data-allowfullscreen="true" data-width="auto"></div>` 
                            : `<div class="fb-post" data-href="${url}" data-width="auto"></div>`,
              ratio: null,
              after: () => {
                this.ensureFbRoot();
                this.addScriptOnce('fb-embed-js', 'https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v19.0', () => {
                  window.FB?.XFBML?.parse?.(elements.videoContainer);
                });
              }
            };
          }
        } catch {}
        return null;
      }
    };

    // ============ å…¨å±€å‡½æ•¸ï¼ˆä¾› HTML èª¿ç”¨ï¼‰============
    function scrollToSection(sectionId) {
      const el = document.getElementById(sectionId);
      if (!el) return;
      const header = document.querySelector('header');
      const headerH = header ? header.getBoundingClientRect().height : 0;
      const top = Math.max(0, el.getBoundingClientRect().top + window.pageYOffset - headerH - 8);
      window.scrollTo({ top, behavior: 'smooth' });
    }

    function openVideoModal(event, videoUrl) {
      event.stopPropagation();
      try {
        const host = new URL(videoUrl).hostname.toLowerCase();
        if (host.includes('youtube.com') || host.includes('youtu.be') || host.includes('drive.google.com')) {
          window.open(videoUrl, '_blank', 'noopener,noreferrer');
          return;
        }
      } catch {
        window.open(videoUrl, '_blank', 'noopener,noreferrer');
        return;
      }

      const embed = videoHandler.buildVideoEmbed(videoUrl);
      if (!embed) {
        window.open(videoUrl, '_blank', 'noopener,noreferrer');
        return;
      }

      elements.videoContainer.className = 'w-full flex justify-center items-center p-0';
      elements.videoContainer.style.removeProperty('aspect-ratio');

      const isPortrait = embed.ratio === '9/16';
      const wrapperClasses = isPortrait ? 'w-full mx-auto max-w-[560px] md:max-w-[640px]' : 'w-full mx-auto';

      if (embed.ratio && !isPortrait) {
        elements.videoContainer.style.aspectRatio = embed.ratio;
      }

      elements.videoContainer.innerHTML = `<div class="${wrapperClasses}">${embed.html}</div>`;
      elements.videoModal.classList.remove('hidden');
      elements.videoModal.classList.add('flex');

      embed.after?.();
    }

    function closeVideoModal() {
      elements.videoModal.classList.add('hidden');
      elements.videoModal.classList.remove('flex');
      elements.videoContainer.innerHTML = '';
    }

    function copyCoupon(ev, txt) {
      ev.stopPropagation();
      navigator.clipboard.writeText(txt).then(() => {
        elements.copyToast.style.opacity = '1';
        elements.copyToast.style.transform = 'translateX(0)';
        setTimeout(() => {
          elements.copyToast.style.opacity = '0';
          elements.copyToast.style.transform = 'translateX(200%)';
        }, 1600);
      }).catch(() => alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š' + txt));
    }

    function openNote(ev, url) {
      ev.stopPropagation();
      window.open(url, '_blank');
    }

    function showDayGroups(day) {
      const { currentMonth, currentYear, groupsByDateEnd, groupsByDateStart } = getCalendarData(state.selectedCalendarMonth);
      const endList = groupsByDateEnd[day] || [];
      const startList = groupsByDateStart[day] || [];

      const card = g => `
        <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-3 mb-2">
          <div class="font-bold text-amber-900">${g.brand || ''}</div>
          ${g.price ? `<div class="text-sm text-amber-700 mt-1">${g.price}</div>` : ''}
          ${g.url ? `<a href="${g.url}" target="_blank" rel="noopener noreferrer" class="inline-block mt-2 bg-amber-600 text-white px-3 py-1 rounded text-sm hover:bg-amber-700">å‰å¾€åœ˜è³¼</a>` : ''}
        </div>`;

      const modal = `
        <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="this.remove()">
          <div class="bg-white rounded-xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold text-amber-900">${currentYear}å¹´ ${currentMonth + 1}æœˆ ${day}æ—¥</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
            </div>
            ${startList.length ? `<h4 class="font-bold text-teal-700 mb-2">ç•¶æ—¥é–‹åœ˜ï¼ˆ${startList.length}ï¼‰</h4>${startList.map(card).join('')}` : ''}
            ${endList.length ? `<h4 class="font-bold text-red-700 mt-4 mb-2">ç•¶æ—¥æˆªæ­¢ï¼ˆ${endList.length}ï¼‰</h4>${endList.map(card).join('')}` : ''}
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', modal);
    }

    function toggleExpired() {
      state.showExpired = !state.showExpired;
      try {
        localStorage.setItem(STORAGE_KEYS.showExpired, String(state.showExpired));
      } catch {}
      renderContent();
    }

    function switchCalendarMonth(m) {
      state.selectedCalendarMonth = m;
      try {
        localStorage.setItem(STORAGE_KEYS.month, String(m));
      } catch {}
      renderContent();
    }

    // ============ æœå°‹åŠŸèƒ½ ============
    let isComposing = false;
    let searchDebounce;

    function applySearch(val) {
      state.searchTerm = val || '';
      try {
        localStorage.setItem(STORAGE_KEYS.search, state.searchTerm);
      } catch {}
      elements.clearBtn?.classList.toggle('hidden', state.searchTerm.length === 0);
      renderContent();
    }

    function initSearch() {
      try {
        const saved = localStorage.getItem(STORAGE_KEYS.search) || '';
        const savedShow = localStorage.getItem(STORAGE_KEYS.showExpired);
        const savedMonth = localStorage.getItem(STORAGE_KEYS.month);
        if (elements.searchInput && saved) {
          state.searchTerm = saved;
          elements.searchInput.value = saved;
          elements.clearBtn?.classList.remove('hidden');
        }
        if (savedShow != null) state.showExpired = savedShow === 'true';
        if (savedMonth != null) state.selectedCalendarMonth = parseInt(savedMonth, 10) || 0;
      } catch {}

      if (elements.searchInput) {
        elements.searchInput.addEventListener('compositionstart', () => isComposing = true);
        elements.searchInput.addEventListener('compositionend', e => {
          isComposing = false;
          applySearch(e.target.value);
        });
        elements.searchInput.addEventListener('input', e => {
          elements.clearBtn?.classList.toggle('hidden', e.target.value.length === 0);
          if (isComposing) return;
          clearTimeout(searchDebounce);
          searchDebounce = setTimeout(() => applySearch(e.target.value), CONFIG.SEARCH_DEBOUNCE);
        });
        elements.searchInput.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            applySearch(elements.searchInput.value);
          }
        });
      }

      elements.clearBtn?.addEventListener('click', () => {
        if (elements.searchInput) elements.searchInput.value = '';
        applySearch('');
        elements.searchInput?.focus();
      });
    }

    // ============ è¡Œäº‹æ›† ============
    function getCalendarData(monthOffset = 0) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const target = new Date(today.getFullYear(), today.getMonth() + monthOffset, 1);
      const curM = target.getMonth();
      const curY = target.getFullYear();

      const byEnd = {};
      const byStart = {};

      state.groups.forEach(g => {
        const end = utils.parseDateSafe(g.endDate);
        if (end && end.getMonth() === curM && end.getFullYear() === curY) {
          const d = end.getDate();
          (byEnd[d] || (byEnd[d] = [])).push(g);
        }
      });

      state.groups.forEach(g => {
        const st = utils.parseDateSafe(g.startDate);
        if (st && st >= today && st.getMonth() === curM && st.getFullYear() === curY) {
          const d = st.getDate();
          (byStart[d] || (byStart[d] = [])).push(g);
        }
      });

      state.upcomingGroups.forEach((ug, i) => {
        const ust = utils.parseDateSafe(ug.startDate);
        if (ust && ust >= today && ust.getMonth() === curM && ust.getFullYear() === curY) {
          const d = ust.getDate();
          (byStart[d] || (byStart[d] = [])).push({ id: 'u-' + i, brand: ug.brand, url: '' });
        }
      });

      return { currentMonth: curM, currentYear: curY, groupsByDateEnd: byEnd, groupsByDateStart: byStart };
    }

    function renderCalendar() {
      const cal = getCalendarData(state.selectedCalendarMonth);
      const { currentMonth: curM, currentYear: curY, groupsByDateEnd: byEnd, groupsByDateStart: byStart } = cal;

      const days = new Date(curY, curM + 1, 0).getDate();
      const first = new Date(curY, curM, 1).getDay();
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const isThisMonth = curM === today.getMonth() && curY === today.getFullYear();

      let html = '<div class="grid grid-cols-7 gap-2 select-none">';
      ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(n => {
        html += `<div class="text-center font-bold text-amber-900 py-2">${n}</div>`;
      });

      for (let i = 0; i < first; i++) html += '<div></div>';

      for (let d = 1; d <= days; d++) {
        const endList = byEnd[d] || [];
        const startList = byStart[d] || [];
        const hasEnd = endList.length > 0;
        const hasStart = startList.length > 0;

        const isToday = isThisMonth && d === today.getDate();
        const isPast = isThisMonth ? d < today.getDate() : state.selectedCalendarMonth < 0;

        let bg = 'bg-white';
        let text = 'text-gray-900';
        let border = 'border-amber-200';

        if (isPast) {
          bg = 'bg-gray-100';
          text = 'text-gray-400';
        } else if (isToday) {
          bg = 'bg-blue-100';
          text = 'text-blue-900 font-bold';
        } else if (hasEnd) {
          const left = Math.ceil((new Date(curY, curM, d) - today) / 86400000);
          if (left <= 3) {
            bg = 'bg-red-100 hover:bg-red-200';
            text = 'text-red-700 font-semibold';
            border = 'border-red-200';
          } else if (left <= 7) {
            bg = 'bg-orange-100 hover:bg-orange-200';
            text = 'text-orange-700 font-semibold';
            border = 'border-orange-200';
          } else {
            bg = 'bg-amber-100 hover:bg-amber-200';
            text = 'text-amber-700';
            border = 'border-amber-300';
          }
        } else if (hasStart) {
          bg = 'bg-teal-100 hover:bg-teal-200';
          text = 'text-teal-700 font-semibold';
          border = 'border-teal-200';
        }

        const clickable = hasEnd || hasStart ? `onclick="showDayGroups(${d})"` : '';
        html += `
          <div class="${bg} ${text} rounded-lg p-2 text-center border-2 ${border} ${clickable ? 'cursor-pointer transition-colors' : ''}" ${clickable}>
            <div class="text-sm">${d}</div>
            ${hasEnd || hasStart ? `
              <div class="mt-1 flex items-center justify-center gap-1">
                ${hasEnd ? `<span class="text-[10px] leading-none px-1.5 py-0.5 rounded bg-white/80 border border-red-300 text-red-700 min-w-[1.1rem] text-center">${utils.formatCount(endList.length)}</span>` : ''}
                ${hasStart ? `<span class="text-[10px] leading-none px-1.5 py-0.5 rounded bg-white/80 border border-teal-300 text-teal-700 min-w-[1.1rem] text-center">${utils.formatCount(startList.length)}</span>` : ''}
              </div>` : ''}
          </div>`;
      }
      html += '</div>';
      return html;
    }

    // ============ è³‡æ–™è¼‰å…¥ ============
    function showError(msg) {
      state.error = msg;
      state.loading = false;
      elements.content.innerHTML = `
        <div class="flex items-center justify-center min-h-[40vh]">
          <div class="text-center">
            <div class="text-4xl mb-4">âš ï¸</div>
            <div class="text-xl text-red-600 font-bold mb-4">${msg}</div>
            <button onclick="location.reload()" class="bg-amber-600 text-white px-6 py-2 rounded-lg hover:bg-amber-700">é‡æ–°æ•´ç†</button>
          </div>
        </div>`;
    }

    async function loadUpcomingFromTab() {
      try {
        const UPCOMING_CSV = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent('å³å°‡é–‹åœ˜')}`;
        const res = await fetch(UPCOMING_CSV, { credentials: 'omit' });
        const text = await res.text();
        if (utils.isProbablyHTML(text)) return [];

        const out = [];
        Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          transformHeader: h => (h || '').trim(),
          complete: r => {
            (r.data || []).forEach((row, i) => {
              const brand = (row['å“ç‰Œ'] || row['Brand'] || '').trim();
              if (!brand) return;
              out.push({
                id: 'u-tab-' + (i + 1),
                brand,
                startDate: row['é–‹åœ˜æ—¥æœŸ'] || row['StartDate'] || '',
                endDate: row['çµæŸæ—¥æœŸ'] || row['EndDate'] || '',
                image: row['åœ–ç‰‡ç¶²å€'] || row['Image'] || ''
              });
            });
          }
        });
        return out;
      } catch {
        return [];
      }
    }

    async function loadData() {
      try {
        const MAIN_CSV = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/export?format=csv`;
        const res = await fetch(MAIN_CSV, { credentials: 'omit' });
        const csv = await res.text();

        if (utils.isProbablyHTML(csv)) {
          showError('Google Sheet ç„¡æ³•å…¬é–‹è®€å–ã€‚è«‹å°‡æ¬Šé™æ”¹ç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººå¯æª¢è¦–ã€ï¼Œæˆ–ä½¿ç”¨ã€Œæª”æ¡ˆ â†’ ç™¼ä½ˆåˆ°ç¶²è·¯ä¸Šã€ã€‚');
          return;
        }

        const all = [];
        Papa.parse(csv, {
          header: true,
          skipEmptyLines: true,
          transformHeader: h => (h || '').trim(),
          complete: r => {
            (r.data || []).forEach((row, i) => {
              const brand = (row['å“ç‰Œ'] || row['Brand'] || '').trim();
              const url = (row['é€£çµ'] || row['URL'] || row['Link'] || '').trim();
              if (!brand || brand.includes('---') || brand.includes('===')) return;

              const typeRaw = String(row['é¡å‹'] || row['Type'] || '').toLowerCase();
              let category = 'short';
              if (/é•·æœŸ|long/.test(typeRaw)) category = 'long';
              else if (/æŠ˜æ‰£|coupon|affiliate/.test(typeRaw)) category = 'coupon';
              else if (/å³å°‡|upcoming/.test(typeRaw)) category = 'upcoming';

              all.push({
                id: i + 1,
                brand,
                url,
                startDate: row['é–‹åœ˜æ—¥æœŸ'] || row['StartDate'] || '',
                endDate: row['çµæŸæ—¥æœŸ'] || row['EndDate'] || '',
                category,
                price: row['åƒ¹æ ¼'] || row['Price'] || '',
                image: row['åœ–ç‰‡ç¶²å€'] || row['Image'] || '',
                description: row['å•†å“æè¿°'] || row['Description'] || '',
                stock: row['åº«å­˜ç‹€æ…‹'] || row['Stock'] || '',
                tag: row['æ¨™ç±¤'] || row['Tag'] || '',
                coupon: row['æŠ˜æ‰£ç¢¼'] || row['Coupon'] || row['DiscountCode'] || '',
                note: row['å‚™è¨»'] || row['Note'] || row['Remark'] || '',
                video: row['å½±ç‰‡ç¶²å€'] || row['Video'] || row['VideoURL'] || ''
              });
            });
          }
        });

        state.groups = all.filter(g => g.category !== 'upcoming' && !!g.url);

        const fromMain = all.filter(g => g.category === 'upcoming')
          .map(g => ({ id: 'u-main-' + g.id, brand: g.brand, startDate: g.startDate || '', endDate: g.endDate || '', image: g.image || '' }));
        const fromTab = await loadUpcomingFromTab();
        const seen = {};
        const merged = fromMain.concat(fromTab);
        state.upcomingGroups = [];
        merged.forEach(it => {
          const key = (it.brand || '') + '|' + (it.startDate || '') + '|' + (it.endDate || '');
          if (seen[key]) return;
          seen[key] = true;
          state.upcomingGroups.push(it);
        });

        state.loading = false;
        renderContent();
      } catch {
        showError('ç„¡æ³•é€£æ¥è³‡æ–™ä¾†æºï¼ˆç¶²è·¯æˆ–æ¬Šé™å•é¡Œï¼‰');
      }
    }

    // ============ å¡ç‰‡æ¸²æŸ“ ============
    function renderUpcomingSearchCard(g) {
      return `
        <div class="bg-gradient-to-br from-pink-50 to-rose-50 rounded-xl overflow-hidden border-2 border-pink-200 shadow-md transition-all hover:shadow-lg">
          ${g.image ? `<div class="w-full h-40 bg-gray-100"><img src="${g.image}" alt="${g.brand}" class="w-full h-full object-cover"></div>` : ''}
          <div class="p-5">
            <div class="flex items-center gap-2 mb-2">
              <span class="bg-pink-500 text-white px-2.5 py-0.5 rounded-full text-xs font-bold">æ•¬è«‹æœŸå¾…</span>
            </div>
            <h3 class="text-lg font-bold text-pink-900 mb-2">${g.brand || ''}</h3>
            ${g.startDate ? `<div class="text-sm text-pink-700 mb-1">ğŸ“… é è¨ˆé–‹åœ˜ï¼š${g.startDate}</div>` : ''}
            ${g.endDate ? `<div class="text-sm text-pink-700 mb-3">â° é è¨ˆçµæŸï¼š${g.endDate}</div>` : ''}
            <div class="bg-white border-2 border-pink-300 rounded-lg p-3 text-center">
              <p class="text-sm text-pink-800 font-medium">åœ˜è³¼å°šæœªé–‹å§‹ï¼Œè«‹å¯†åˆ‡é—œæ³¨</p>
            </div>
          </div>
        </div>`;
    }

    function renderGroupCard(g) {
      const daysLeft = utils.getDaysLeft(g.endDate);
      const expired = utils.isExpired(g.endDate);
      const noteIsURL = utils.isURL(g.note);
      const noteIsQA = utils.isQA(g.note);
      const qaList = noteIsQA ? utils.parseQA(g.note) : [];
      const openClass = expired ? 'from-gray-400 to-gray-500 hover:from-gray-400 hover:to-gray-500' : 'from-amber-600 to-pink-600 hover:from-amber-700 hover:to-pink-700';

      const countdown = g.category === 'short' && daysLeft !== null
        ? `<div class="flex items-center gap-2 text-sm mb-3">
             <span class="${daysLeft < 0 ? 'text-gray-500' : daysLeft <= 3 ? 'text-red-600 font-semibold' : 'text-amber-700'}">
               â± ${daysLeft > 0 ? 'å‰© ' + daysLeft + ' å¤©' : daysLeft === 0 ? 'ä»Šå¤©æˆªæ­¢' : 'çµæŸ ' + Math.abs(daysLeft) + ' å¤©'}
             </span>
           </div>`
        : '';

      return `
        <div class="bg-white rounded-xl overflow-hidden border-2 ${expired ? 'border-gray-300 opacity-60' : 'border-amber-200 hover:border-amber-400 hover:shadow-lg'} transition-all">
          ${g.image ? `<div class="w-full h-48 bg-gray-100"><img src="${g.image}" alt="${g.brand}" class="w-full h-full object-cover ${expired ? 'grayscale' : ''}"></div>` : ''}
          <div class="p-5">
            <h3 class="text-lg font-bold ${expired ? 'text-gray-500' : 'text-amber-900'} mb-2">${g.brand}</h3>
            <div class="flex flex-wrap gap-2 mb-3">
              ${expired ? '<span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full font-medium">å·²çµæŸ</span>' : ''}
              ${g.tag ? `<span class="text-xs bg-pink-100 text-pink-700 px-2 py-1 rounded-full font-medium">${g.tag}</span>` : ''}
              ${g.stock === 'å”®å®Œ' ? '<span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">å·²å”®å®Œ</span>' : ''}
              ${g.stock === 'å°‘é‡' ? '<span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full">å°‘é‡ç¾è²¨</span>' : ''}
            </div>
            ${g.description ? `<p class="text-sm ${expired ? 'text-gray-400' : 'text-gray-600'} mb-3">${g.description}</p>` : ''}
            ${g.price ? `<p class="text-lg font-bold ${expired ? 'text-gray-400' : 'text-amber-700'} mb-3">${g.price}</p>` : ''}
            ${countdown}
            ${g.note && !expired
              ? noteIsQA
                ? `<details class="mb-3 bg-indigo-50 border-2 border-indigo-200 rounded-lg p-3">
                     <summary class="cursor-pointer text-indigo-700 font-medium">å¸¸è¦‹å•é¡Œâ“ï¼ˆ${qaList.length}ï¼‰</summary>
                     ${qaList.map(qa => `<div class="mt-2 border-t border-indigo-200 pt-2"><p class="text-sm font-semibold text-indigo-900 mb-1">Q: ${qa.q}</p><p class="text-sm text-indigo-700">A: ${qa.a}</p></div>`).join('')}
                   </details>`
                : noteIsURL
                  ? `<div class="mb-3"><button onclick='openNote(event, "${g.note}")' class="w-full bg-blue-50 border-2 border-blue-200 text-blue-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-100 transition-colors">ğŸ“ æŸ¥çœ‹ä»‹ç´¹</button></div>`
                  : `<div class="mb-3 bg-blue-50 border-2 border-blue-200 rounded-lg p-3"><p class="text-xs text-blue-600 font-semibold mb-1">â„¹ï¸ è²¼å¿ƒèªªæ˜</p><p class="text-sm text-blue-900">${g.note}</p></div>`
              : ''}
            ${g.video && !expired ? `<div class="mb-3"><button onclick='openVideoModal(event, "${g.video}")' class="w-full bg-gradient-to-r from-red-50 to-pink-50 border-2 border-red-200 text-red-700 px-4 py-2 rounded-lg text-sm font-medium hover:from-red-100 hover:bg-blue-100 transition-colors">ğŸ¬ è§€çœ‹å½±ç‰‡</button></div>` : ''}
            ${g.coupon && !expired ? `<div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-3 mb-3"><div class="flex items-center justify-between"><div class="flex-1 min-w-0"><p class="text-xs text-green-700 font-semibold mb-1">ğŸŸï¸ å°ˆå±¬æŠ˜æ‰£ç¢¼</p><code class="text-base font-bold text-green-800 font-mono break-all">${g.coupon}</code></div><button onclick='copyCoupon(event, "${g.coupon}")' class="ml-3 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-medium">è¤‡è£½</button></div></div>` : ''}
            <a href="${g.url}" target="_blank" rel="noopener noreferrer" class="block w-full text-center text-white py-3 rounded-xl font-bold bg-gradient-to-r ${openClass}">${expired ? 'ä»å¯æŸ¥çœ‹ â†’' : 'ç«‹å³å‰å¾€ â†’'}</a>
          </div>
        </div>`;
    }

    function renderCouponCard(g) {
      const expired = utils.isExpired(g.endDate);
      const daysLeft = utils.getDaysLeft(g.endDate);
      const noteIsURL = utils.isURL(g.note);
      const noteIsQA = utils.isQA(g.note);
      const qaList = noteIsQA ? utils.parseQA(g.note) : [];

      return `
        <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl overflow-hidden border-2 ${expired ? 'border-gray-300 opacity-60' : 'border-purple-200 hover:border-purple-400 hover:shadow-xl'} transition-all">
          ${g.image ? `<div class="w-full h-40 bg-gray-100"><img src="${g.image}" alt="${g.brand}" class="w-full h-full object-cover ${expired ? 'grayscale' : ''}"></div>` : ''}
          <div class="p-6">
            <h3 class="text-xl font-bold ${expired ? 'text-gray-500' : 'text-purple-900'} mb-3 break-words">${g.brand}</h3>
            ${g.description ? `<p class="text-sm ${expired ? 'text-gray-400' : 'text-gray-600'} mb-4">${g.description}</p>` : ''}
            ${g.price ? `<p class="text-lg font-bold ${expired ? 'text-gray-400' : 'text-purple-700'} mb-4">${g.price}</p>` : ''}
            ${g.note && !expired
              ? noteIsQA
                ? `<details class="mb-4 bg-indigo-50 border-2 border-indigo-200 rounded-lg p-3"><summary class="cursor-pointer text-indigo-700 font-medium">å¸¸è¦‹å•é¡Œâ“ï¼ˆ${qaList.length}ï¼‰</summary>${qaList.map(qa => `<div class="mt-2 border-t border-indigo-200 pt-2"><p class="text-sm font-semibold text-indigo-900 mb-1">Q: ${qa.q}</p><p class="text-sm text-indigo-700">A: ${qa.a}</p></div>`).join('')}</details>`
                : noteIsURL
                  ? `<button onclick='openNote(event, "${g.note}")' class="w-full bg-blue-50 border-2 border-blue-200 text-blue-700 px-4 py-3 rounded-lg font-medium hover:bg-blue-100 transition-colors mb-4">ğŸ“ æŸ¥çœ‹ä»‹ç´¹</button>`
                  : `<div class="mb-4 bg-blue-50 border-2 border-blue-200 rounded-lg p-3"><p class="text-xs text-blue-600 font-semibold mb-1">â„¹ï¸ å‚™è¨»</p><p class="text-sm text-blue-900">${g.note}</p></div>`
              : ''}
            ${daysLeft !== null && !expired ? `<div class="flex items-center gap-2 text-sm mb-4"><span class="${daysLeft <= 7 ? 'text-red-600 font-semibold' : 'text-purple-700'}">â° ${daysLeft > 0 ? 'å‰© ' + daysLeft + ' å¤©' : 'ä»Šå¤©æˆªæ­¢'}</span></div>` : ''}
            ${g.coupon && !expired ? `<div class="bg-white border-2 border-purple-300 rounded-xl p-4 mb-4"><p class="text-xs text-purple-600 font-semibold mb-2">ğŸŸï¸ æŠ˜æ‰£ç¢¼</p><div class="flex items-center gap-3"><code class="text-xl md:text-2xl font-bold text-purple-900 font-mono break-all flex-1 min-w-0">${g.coupon}</code><button onclick='copyCoupon(event, "${g.coupon}")' class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium whitespace-nowrap flex-shrink-0">è¤‡è£½</button></div></div>` : ''}
            <a href="${g.url}" target="_blank" rel="noopener noreferrer" class="block w-full text-center text-white py-3 rounded-xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 ${expired ? 'opacity-80' : ''}">${expired ? 'ä»å¯æŸ¥çœ‹ â†’' : 'ç«‹å³å‰å¾€ â†’'}</a>
          </div>
        </div>`;
    }

    // ============ å…§å®¹æ¸²æŸ“ ============
    function renderContent() {
      if (state.loading) {
        elements.content.innerHTML = `
          <div class="flex items-center justify-center min-h-[40vh]">
            <div class="text-center">
              <div class="text-4xl mb-4">ğŸ¦…</div>
              <div class="text-xl text-amber-900 font-bold">è¼‰å…¥ä¸­...</div>
            </div>
          </div>`;
        return;
      }
      if (state.error) return;

      const q = (state.searchTerm || '').toLowerCase();
      const filtered = state.groups.filter(g => {
        const okSearch = !q || g.brand.toLowerCase().includes(q) || (g.tag || '').toLowerCase().includes(q) || (g.description || '').toLowerCase().includes(q);
        const okExpired = state.showExpired || !utils.isExpired(g.endDate);
        return okSearch && okExpired;
      });

      const longTerm = filtered.filter(g => g.category === 'long');
      const shortTerm = filtered.filter(g => g.category === 'short').sort((a, b) => {
        if (!a.endDate && !b.endDate) return 0;
        if (!a.endDate) return 1;
        if (!b.endDate) return -1;
        return utils.parseDateSafe(a.endDate) - utils.parseDateSafe(b.endDate);
      });
      const coupon = filtered.filter(g => g.category === 'coupon');
      const expiredCount = state.groups.filter(g => utils.isExpired(g.endDate)).length;

      const term = (state.searchTerm || '').trim().toLowerCase();
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const activeBrandSet = new Set(filtered.filter(g => !utils.isExpired(g.endDate)).map(g => utils.normalizeBrand(g.brand)));

      const rawUpcoming = term ? (state.upcomingGroups || []).filter(u => {
        const hit = (u.brand || '').toLowerCase().includes(term);
        const st = utils.parseDateSafe(u.startDate);
        const fut = !!st && st > today;
        const diff = !activeBrandSet.has(utils.normalizeBrand(u.brand));
        return hit && fut && diff;
      }) : [];

      const soonestByBrand = {};
      for (const u of rawUpcoming) {
        const key = utils.normalizeBrand(u.brand);
        const st = utils.parseDateSafe(u.startDate);
        if (!soonestByBrand[key] || st < utils.parseDateSafe(soonestByBrand[key].startDate)) {
          soonestByBrand[key] = u;
        }
      }
      const upcomingMatches = Object.values(soonestByBrand);

      const btn = (id, txt, cls) => `<button onclick="scrollToSection('${id}')" class="px-4 py-2 ${cls} rounded-lg font-medium whitespace-nowrap hover:opacity-90 text-sm">${txt}</button>`;
      elements.sectionButtons.innerHTML = (shortTerm.length ? btn('short-term', 'é™æ™‚åœ˜è³¼', 'bg-orange-100 text-orange-700') : '') +
        (longTerm.length ? btn('long-term', 'å¸¸é§åœ˜è³¼', 'bg-green-100 text-green-700') : '') +
        (coupon.length ? btn('coupon', 'æŠ˜æ‰£ç¢¼å„ªæƒ ', 'bg-purple-100 text-purple-700') : '') +
        btn('calendar', 'åœ˜è³¼è¡Œäº‹æ›†', 'bg-blue-100 text-blue-700');

      const m1 = today.getMonth() + 1;
      const m2 = (today.getMonth() + 1) % 12 + 1;
      const m3 = (today.getMonth() + 2) % 12 + 1;

      elements.content.innerHTML =
        `<div class="mb-6">
           ${expiredCount ? `<button onclick="toggleExpired()" class="px-4 py-2 rounded-lg font-medium ${state.showExpired ? 'bg-gray-600 text-white' : 'bg-white text-gray-700 border-2 border-gray-300'}">${state.showExpired ? 'éš±è—' : 'é¡¯ç¤º'}å·²çµæŸï¼ˆ${expiredCount}ï¼‰</button>` : ''}
         </div>` +

        (state.searchTerm && upcomingMatches.length && shortTerm.length === 0 && longTerm.length === 0 && coupon.length === 0 ? `
          <section id="upcoming-search" class="scroll-mt-24 md:scroll-mt-28 mb-8">
            <h2 class="text-2xl font-bold text-amber-900 mb-4 flex items-center gap-2">
              <span class="bg-pink-100 text-pink-700 px-3 py-1 rounded-full text-sm">é å‘Š</span>
              å³å°‡é–‹åœ˜ï¼ˆ${upcomingMatches.length}ï¼‰
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              ${upcomingMatches.map(renderUpcomingSearchCard).join('')}
            </div>
          </section>
        ` : '') +

        (shortTerm.length ? `<section id="short-term" class="scroll-mt-24 md:scroll-mt-28 mb-8">
           <h2 class="text-2xl font-bold text-amber-900 mb-4 flex items-center gap-2"><span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-sm">â³</span>é™æ™‚åœ˜è³¼</h2>
           <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${shortTerm.map(renderGroupCard).join('')}</div>
         </section>` : '') +

        (longTerm.length ? `<section id="long-term" class="scroll-mt-24 md:scroll-mt-28 mb-8">
           <h2 class="text-2xl font-bold text-amber-900 mb-4 flex items-center gap-2"><span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">ğŸ˜</span>å¸¸é§åœ˜è³¼</h2>
           <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${longTerm.map(renderGroupCard).join('')}</div>
         </section>` : '') +

        (coupon.length ? `<section id="coupon" class="scroll-mt-24 md:scroll-mt-28 mb-8">
           <h2 class="text-2xl font-bold text-amber-900 mb-4 flex items-center gap-2"><span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm">ğŸŸï¸</span>æŠ˜æ‰£ç¢¼å„ªæƒ </h2>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${coupon.map(renderCouponCard).join('')}</div>
         </section>` : '') +

        `<section id="calendar" class="scroll-mt-24 md:scroll-mt-28 mb-8">
           <h2 class="text-2xl font-bold text-amber-900 mb-4 flex items-center gap-2"><span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">ğŸ“…</span>åœ˜è³¼è¡Œäº‹æ›†</h2>
           <div class="bg-white rounded-xl p-4 border-2 border-amber-200">
             <div class="flex gap-2 mb-4 justify-center">
               <button onclick="switchCalendarMonth(0)" class="px-4 py-2 rounded-lg font-medium ${state.selectedCalendarMonth === 0 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">${m1}æœˆ</button>
               <button onclick="switchCalendarMonth(1)" class="px-4 py-2 rounded-lg font-medium ${state.selectedCalendarMonth === 1 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">${m2}æœˆ</button>
               <button onclick="switchCalendarMonth(2)" class="px-4 py-2 rounded-lg font-medium ${state.selectedCalendarMonth === 2 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">${m3}æœˆ</button>
             </div>
             ${renderCalendar()}
             <div class="mt-4 flex gap-4 text-xs text-gray-600 justify-center flex-wrap">
               <div class="flex items-center gap-1"><div class="w-4 h-4 bg-blue-100 border border-blue-300 rounded"></div><span>ä»Šå¤©</span></div>
               <div class="flex items-center gap-1"><div class="w-4 h-4 bg-red-100 border border-red-300 rounded"></div><span>3å¤©å…§æˆªæ­¢</span></div>
               <div class="flex items-center gap-1"><div class="w-4 h-4 bg-orange-100 border border-orange-300 rounded"></div><span>7å¤©å…§æˆªæ­¢</span></div>
               <div class="flex items-center gap-1"><span class="text-[10px] leading-none px-1.5 py-0.5 rounded bg-white border border-red-300 text-red-700">3</span><span>ï¼ ç•¶æ—¥æˆªæ­¢æ•¸</span></div>
               <div class="flex items-center gap-1"><span class="text-[10px] leading-none px-1.5 py-0.5 rounded bg-white border border-teal-300 text-teal-700">2</span><span>ï¼ ç•¶æ—¥é–‹åœ˜æ•¸</span></div>
             </div>
           </div>
         </section>` +

        (filtered.length === 0 && state.searchTerm ? `<div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-6 text-center"><p class="text-lg text-yellow-900 font-medium">æ‰¾ä¸åˆ°ã€Œ${state.searchTerm}ã€ç›¸é—œçš„åœ˜è³¼</p><p class="text-sm text-yellow-700 mt-2">è©¦è©¦å…¶ä»–é—œéµå­—ï¼Œæˆ–æ¸…ç©ºæœå°‹</p></div>` : '') +
        (filtered.length === 0 && !state.searchTerm ? `<div class="text-center py-12 text-amber-700"><p class="text-lg">ç›®å‰æ²’æœ‰åœ˜è³¼é …ç›®</p></div>` : '');
    }

    // ============ åˆå§‹åŒ– ============
    initSearch();
    renderBanner();
    loadData();
    setInterval(loadData, CONFIG.REFRESH_INTERVAL);
  </script>
</body>
</html>
