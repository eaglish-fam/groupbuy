<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é·¹å®¶Funç”Ÿè²·ç‰©ç¤¾ - ç²¾é¸åœ˜è³¼ Â· å„ªè³ªå¥½ç‰©</title>

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¦…</text></svg>">

  <!-- Open Graph -->
  <meta property="og:title" content="ğŸ¦… é·¹å®¶Funç”Ÿè²·ç‰©ç¤¾">
  <meta property="og:description" content="ç²¾é¸åœ˜è³¼ Â· å„ªè³ªå¥½ç‰©">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://eagle-groupbuy.netlify.app/">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gradient-to-br from-amber-50 via-orange-50 to-yellow-50 min-h-screen">
  <!-- Shellï¼šåªå»ºç«‹ä¸€æ¬¡ -->
  <header class="bg-white/80 backdrop-blur-sm border-b border-amber-200 sticky top-0 z-20">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="text-center">
        <h1 class="text-2xl font-bold text-amber-900">ğŸ¦… é·¹å®¶Funç”Ÿè²·ç‰©ç¤¾</h1>
        <p class="text-sm text-amber-700">ç²¾é¸åœ˜è³¼ Â· å„ªè³ªå¥½ç‰©</p>
      </div>

      <!-- å¿«é€Ÿå€æ®µæŒ‰éˆ• -->
      <div id="sectionButtons" class="flex gap-2 justify-center overflow-x-auto pb-2 pt-3"></div>

      <!-- æœå°‹åˆ—ï¼ˆå›ºå®šç¯€é»ï¼Œä¸é‡å»ºï¼‰ -->
      <div class="mt-3 flex gap-2 items-stretch max-w-3xl mx-auto">
        <div class="relative flex-1">
          <input id="searchInput" type="search" enterkeyhint="search" autocomplete="off" aria-label="æœå°‹å“ç‰Œ"
                 placeholder="æœå°‹å“ç‰Œåç¨±â€¦" class="w-full pl-3 pr-9 py-3 rounded-xl border-2 border-amber-200 focus:border-amber-400 focus:outline-none bg-white/80">
          <button id="clearBtn" title="æ¸…é™¤" class="absolute right-2 top-1/2 -translate-y-1/2 hidden w-7 h-7 rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300">Ã—</button>
        </div>
        <button id="searchBtn" class="px-4 py-3 bg-amber-600 text-white rounded-xl font-medium hover:bg-amber-700 whitespace-nowrap">æœå°‹</button>
      </div>
    </div>
  </header>

  <!-- å…§å®¹å€ï¼ˆåªé‡ç¹ªé€™å¡Šï¼‰ -->
  <main id="content" class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex items-center justify-center min-h-[40vh]">
      <div class="text-center">
        <div class="text-4xl mb-4">ğŸ¦…</div>
        <div class="text-xl text-amber-900 font-bold">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div id="copyToast" class="fixed top-20 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-x-[200%] transition-all duration-300 z-50">âœ“ æŠ˜æ‰£ç¢¼å·²è¤‡è£½</div>

  <!-- å½±ç‰‡ Modal -->
  <div id="videoModal" class="fixed inset-0 bg-black/75 z-50 hidden items-center justify-center p-4" onclick="closeVideoModal()">
    <div class="relative w-full max-w-4xl bg-white rounded-xl overflow-hidden" onclick="event.stopPropagation()">
      <button onclick="closeVideoModal()" class="absolute top-4 right-4 z-10 bg-red-600 text-white w-10 h-10 rounded-full hover:bg-red-700 text-xl font-bold">Ã—</button>
      <div id="videoContainer" class="w-full" style="aspect-ratio:16/9;"></div>
    </div>
  </div>

  <script>
    /* ===================== è¨­å®š ===================== */
    var SHEET_ID     = '1-RuyD9eCkrDpgFFXGHRWaTF-LYKaDK-MxAw3uNMozeU';
    var MAIN_CSV     = 'https://docs.google.com/spreadsheets/d/'+SHEET_ID+'/export?format=csv';
    var UPCOMING_CSV = 'https://docs.google.com/spreadsheets/d/'+SHEET_ID+'/gviz/tq?tqx=out:csv&sheet='+encodeURIComponent('å³å°‡é–‹åœ˜');

    var state = {
      searchTerm: '',
      groups: [],
      upcomingGroups: [],  // åªä¾›è¡Œäº‹æ›†ç”¨
      loading: true,
      error: null,
      showExpired: false,
      expandedQA: {},
      selectedCalendarMonth: 0
    };

    // çµ„å­—ä¿è­· & debounce
    var isComposing = false;
    var searchDebounce;
    var STORAGE_KEYS = {
      search: 'eg_search',
      showExpired: 'eg_show_expired',
      month: 'eg_month'
    };

    /* ===================== å°å·¥å…· ===================== */
    function isURL(s){ return !!s && /^https?:\/\//i.test(s); }
    function isQA(s){ return !!s && s.indexOf('Q:')>-1 && s.indexOf('|A:')>-1; }
    function parseQA(s){
      if(!s) return [];
      var lines = s.split('\n'), out=[];
      for(var i=0;i<lines.length;i++){
        var line=(lines[i]||'').trim(); if(!line) continue;
        var parts=line.split('|A:'); if(parts.length<2) continue;
        out.push({ q: parts[0].replace(/^Q:\s*/,'').trim(), a: parts[1].trim() });
      }
      return out;
    }
    function parseDateSafe(v){
      if(v==null || v==='') return null;
      if(typeof v==='number'){ var ms=Math.round((v-25569)*86400*1000); var d=new Date(ms); d.setHours(0,0,0,0); return d; }
      var s=String(v).trim();
      var m=s.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);
      if(m){ return new Date(+m[1], +m[2]-1, +m[3]); }
      var d2=new Date(s); if(!isNaN(d2)){ d2.setHours(0,0,0,0); return d2; }
      return null;
    }
    function getDaysLeft(endStr){
      var end=parseDateSafe(endStr); if(!end) return null;
      var today=new Date(); today.setHours(0,0,0,0);
      return Math.ceil((end - today)/86400000);
    }
    function isExpired(endStr){
      var d=getDaysLeft(endStr);
      return d!==null && d<0;
    }
    function isProbablyHTML(t){
      return /<\/?html[\s>]/i.test(t) || /accounts\.google\.com/.test(t);
    }
    function formatCount(n){ if(n>99) return '99+'; if(n>9) return '9+'; return String(n); }

    /* ===================== å½±ç‰‡ ===================== */
    function getGoogleDriveVideoId(url){ if(!url) return null; var m=url.match(/[-\w]{25,}/); return m?m[0]:null; }
    function openVideoModal(ev, url){
      ev.stopPropagation();
      var id=getGoogleDriveVideoId(url); if(!id){ alert('ç„¡æ³•è¼‰å…¥å½±ç‰‡'); return; }
      var embed='https://drive.google.com/file/d/'+id+'/preview';
      document.getElementById('videoContainer').innerHTML =
        '<iframe src="'+embed+'" class="w-full h-full" frameborder="0" allow="autoplay" allowfullscreen></iframe>';
      var m=document.getElementById('videoModal'); m.classList.remove('hidden'); m.classList.add('flex');
    }
    function closeVideoModal(){ var m=document.getElementById('videoModal'); m.classList.add('hidden'); m.classList.remove('flex'); document.getElementById('videoContainer').innerHTML=''; }

    /* ===================== æœå°‹ï¼ˆä¸é‡å»ºç¯€é»ï¼‰ ===================== */
    var $search = document.getElementById('searchInput');
    var $clear  = document.getElementById('clearBtn');
    var $searchBtn = document.getElementById('searchBtn');

    function applySearch(term){
      state.searchTerm = term || '';
      localStorage.setItem(STORAGE_KEYS.search, state.searchTerm);
      $clear.classList.toggle('hidden', state.searchTerm.length===0);
      renderContent();
    }

    function hookSearch(){
      // è¨˜æ†¶è¨­å®š
      try{
        var saved = localStorage.getItem(STORAGE_KEYS.search) || '';
        var savedShow = localStorage.getItem(STORAGE_KEYS.showExpired);
        var savedMonth = localStorage.getItem(STORAGE_KEYS.month);
        if(saved){ state.searchTerm = saved; $search.value = saved; $clear.classList.remove('hidden'); }
        if(savedShow!=null){ state.showExpired = savedShow==='true'; }
        if(savedMonth!=null){ state.selectedCalendarMonth = parseInt(savedMonth,10)||0; }
      }catch(e){}

      $search.addEventListener('compositionstart', function(){ isComposing = true; });
      $search.addEventListener('compositionend', function(e){ isComposing = false; applySearch(e.target.value); });
      $search.addEventListener('input', function(e){
        $clear.classList.toggle('hidden', e.target.value.length===0);
        if(isComposing) return;
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(function(){ applySearch(e.target.value); }, 250);
      });
      $search.addEventListener('keydown', function(e){
        if(e.key==='Enter'){ e.preventDefault(); applySearch($search.value); }
      });
      $searchBtn.addEventListener('click', function(){ applySearch($search.value); });
      $clear.addEventListener('click', function(){
        $search.value=''; applySearch('');
        $search.focus();
      });
    }

    /* ===================== è¡Œäº‹æ›† ===================== */
    function getCalendarData(monthOffset){
      if(typeof monthOffset==='undefined') monthOffset=0;
      var today=new Date(); today.setHours(0,0,0,0);
      var target=new Date(today.getFullYear(), today.getMonth()+monthOffset, 1);
      var curM=target.getMonth(), curY=target.getFullYear();

      var byEnd={}, byStart={};

      // ä¸»è¡¨ï¼šçµæŸ
      for(var i=0;i<state.groups.length;i++){
        var g=state.groups[i], end=parseDateSafe(g.endDate);
        if(end && end.getMonth()===curM && end.getFullYear()===curY){
          var d=end.getDate(); if(!byEnd[d]) byEnd[d]=[]; byEnd[d].push(g);
        }
      }
      // ä¸»è¡¨ï¼šæœªä¾†é–‹åœ˜
      for(var j=0;j<state.groups.length;j++){
        var g2=state.groups[j], st=parseDateSafe(g2.startDate);
        if(st && st>=today && st.getMonth()===curM && st.getFullYear()===curY){
          var d2=st.getDate(); if(!byStart[d2]) byStart[d2]=[]; byStart[d2].push(g2);
        }
      }
      // åˆ†é å³å°‡é–‹åœ˜ â†’ ä¹Ÿè¦–ç‚ºé–‹åœ˜
      for(var k=0;k<state.upcomingGroups.length;k++){
        var ug=state.upcomingGroups[k], ust=parseDateSafe(ug.startDate);
        if(ust && ust>=today && ust.getMonth()===curM && ust.getFullYear()===curY){
          var d3=ust.getDate(); if(!byStart[d3]) byStart[d3]=[];
          byStart[d3].push({ id:'u-'+k, brand: ug.brand, price:'', url:'', category:'upcoming' });
        }
      }
      return { currentMonth: curM, currentYear: curY, groupsByDateEnd: byEnd, groupsByDateStart: byStart };
    }

    function renderCalendar(){
      var cal=getCalendarData(state.selectedCalendarMonth);
      var curM=cal.currentMonth, curY=cal.currentYear, byEnd=cal.groupsByDateEnd, byStart=cal.groupsByDateStart;

      var days=new Date(curY, curM+1, 0).getDate();
      var first=new Date(curY, curM, 1).getDay();
      var today=new Date(); today.setHours(0,0,0,0);
      var isThisMonth=(curM===today.getMonth() && curY===today.getFullYear());

      var html='<div class="grid grid-cols-7 gap-2 select-none">';
      var names=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      for(var i=0;i<names.length;i++){ html+='<div class="text-center font-bold text-amber-900 py-2">'+names[i]+'</div>'; }
      for(var p=0;p<first;p++) html+='<div></div>';

      for(var d=1; d<=days; d++){
        var endList=byEnd[d]||[], startList=byStart[d]||[];
        var hasEnd=endList.length>0, hasStart=startList.length>0;

        var isToday=isThisMonth && (d===today.getDate());
        var isPast=isThisMonth ? (d<today.getDate()) : (state.selectedCalendarMonth<0);

        var bg='bg-white', text='text-gray-900', border='border-amber-200';
        if(isPast){ bg='bg-gray-100'; text='text-gray-400'; }
        else if(isToday){ bg='bg-blue-100'; text='text-blue-900 font-bold'; }
        else if(hasEnd){
          var deadline=new Date(curY, curM, d);
          var left=Math.ceil((deadline - today)/86400000);
          if(left<=3){ bg='bg-red-100 hover:bg-red-200'; text='text-red-700 font-semibold'; border='border-red-200'; }
          else if(left<=7){ bg='bg-orange-100 hover:bg-orange-200'; text='text-orange-700 font-semibold'; border='border-orange-200'; }
          else { bg='bg-amber-100 hover:bg-amber-200'; text='text-amber-700'; border='border-amber-300'; }
        }else if(hasStart){
          bg='bg-teal-100 hover:bg-teal-200'; text='text-teal-700 font-semibold'; border='border-teal-200';
        }

        var clickable=(hasEnd||hasStart)?'onclick="showDayGroups('+d+')"':'';
        html+='<div class="'+bg+' '+text+' rounded-lg p-2 text-center border-2 '+border+' '+(clickable?'cursor-pointer transition-colors':'')+'" '+clickable+'>'
            +   '<div class="text-sm">'+d+'</div>'
            +   ((hasEnd||hasStart)?(
                  '<div class="mt-1 flex items-center justify-center gap-1">'+
                  (hasEnd?  '<span class="text-[10px] leading-none px-1.5 py-0.5 rounded bg-white/80 border border-red-300 text-red-700 min-w-[1.1rem] text-center">'+formatCount(endList.length)+'</span>':'')+
                  (hasStart?'<span class="text-[10px] leading-none px-1.5 py-0.5 rounded bg-white/80 border border-teal-300 text-teal-700 min-w-[1.1rem] text-center">'+formatCount(startList.length)+'</span>':'')+
                  '</div>'
                ):'')
            + '</div>';
      }
      html+='</div>';
      return html;
    }

    function showDayGroups(day){
      var cal=getCalendarData(state.selectedCalendarMonth);
      var curM=cal.currentMonth, curY=cal.currentYear, byEnd=cal.groupsByDateEnd, byStart=cal.groupsByDateStart;
      var endList=byEnd[day]||[], startList=byStart[day]||[];

      function card(g){
        return '<div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-3 mb-2">'+
               '<div class="font-bold text-amber-900">'+g.brand+'</div>'+
               (g.price?'<div class="text-sm text-amber-700 mt-1">'+g.price+'</div>':'')+
               (g.url?'<a href="'+g.url+'" target="_blank" rel="noopener noreferrer" class="inline-block mt-2 bg-amber-600 text-white px-3 py-1 rounded text-sm hover:bg-amber-700">å‰å¾€åœ˜è³¼</a>':'')+
               '</div>';
      }

      var modal = '<div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="this.remove()">'+
                  '<div class="bg-white rounded-xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">'+
                  '<div class="flex justify-between items-center mb-4">'+
                  '<h3 class="text-xl font-bold text-amber-900">'+curY+'å¹´ '+(curM+1)+'æœˆ '+day+'æ—¥</h3>'+
                  '<button onclick="this.closest(\'.fixed\').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>'+
                  '</div>'+
                  (startList.length?'<h4 class="font-bold text-teal-700 mb-2">ç•¶æ—¥é–‹åœ˜ï¼ˆ'+startList.length+'ï¼‰</h4>'+startList.map(card).join(''):'')+
                  (endList.length?  '<h4 class="font-bold text-red-700 mt-4 mb-2">ç•¶æ—¥æˆªæ­¢ï¼ˆ'+endList.length+'ï¼‰</h4>'+endList.map(card).join('')  :'')+
                  '</div></div>';
      document.body.insertAdjacentHTML('beforeend', modal);
    }

    /* ===================== è³‡æ–™è¼‰å…¥ ===================== */
    function showError(msg){
      state.error = msg; state.loading = false;
      document.getElementById('content').innerHTML =
        '<div class="flex items-center justify-center min-h-[40vh]"><div class="text-center">'+
        '<div class="text-4xl mb-4">âš ï¸</div>'+
        '<div class="text-xl text-red-600 font-bold mb-4">'+msg+'</div>'+
        '<button onclick="location.reload()" class="bg-amber-600 text-white px-6 py-2 rounded-lg hover:bg-amber-700">é‡æ–°æ•´ç†</button>'+
        '</div></div>';
    }

    async function loadUpcomingFromTab(){
      try{
        var res=await fetch(UPCOMING_CSV, {credentials:'omit'});
        var text=await res.text();
        if(isProbablyHTML(text)) return [];
        var list=[];
        Papa.parse(text, {
          header:true, skipEmptyLines:true,
          transformHeader:function(h){ return (h||'').trim(); },
          complete:function(r){
            var data=r.data||[];
            for(var i=0;i<data.length;i++){
              var row=data[i]||{};
              var brand=(row['å“ç‰Œ']||row['Brand']||'').trim();
              if(!brand) continue;
              list.push({
                id:'u-tab-'+(i+1),
                brand: brand,
                startDate: row['é–‹åœ˜æ—¥æœŸ']||row['StartDate']||'',
                endDate:   row['çµæŸæ—¥æœŸ']||row['EndDate']||'',
                image:     row['åœ–ç‰‡ç¶²å€']||row['Image']||''
              });
            }
          }
        });
        return list;
      }catch(e){ return []; }
    }

    async function loadData(){
      try{
        var res=await fetch(MAIN_CSV, {credentials:'omit'});
        var csv=await res.text();
        if(isProbablyHTML(csv)){
          showError('Google Sheet ç„¡æ³•å…¬é–‹è®€å–ã€‚è«‹å°‡æ¬Šé™æ”¹ç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººå¯æª¢è¦–ã€ï¼Œæˆ–ä½¿ç”¨ã€Œæª”æ¡ˆ â†’ ç™¼ä½ˆåˆ°ç¶²è·¯ä¸Šã€ã€‚');
          return;
        }

        var all=[];
        Papa.parse(csv, {
          header:true, skipEmptyLines:true,
          transformHeader:function(h){ return (h||'').trim(); },
          complete:function(r){
            var data=r.data||[];
            for(var i=0;i<data.length;i++){
              var row=data[i]||{};
              var brand=(row['å“ç‰Œ']||row['Brand']||'').trim();
              var url  =(row['é€£çµ']||row['URL']||row['Link']||'').trim();
              if(!brand) continue;
              if(brand.indexOf('---')>-1 || brand.indexOf('===')>-1) continue;

              var typeRaw=String(row['é¡å‹']||row['Type']||'').toLowerCase();
              var category='short';
              if(/é•·æœŸ|long/.test(typeRaw)) category='long';
              else if(/æŠ˜æ‰£|coupon|affiliate/.test(typeRaw)) category='coupon';
              else if(/å³å°‡|upcoming/.test(typeRaw)) category='upcoming';

              all.push({
                id:i+1,
                brand:brand,
                url:url || '',
                startDate: row['é–‹åœ˜æ—¥æœŸ']||row['StartDate']||'',
                endDate:   row['çµæŸæ—¥æœŸ']||row['EndDate']||'',
                category:  category,
                price: row['åƒ¹æ ¼']||row['Price']||'',
                image: row['åœ–ç‰‡ç¶²å€']||row['Image']||'',
                description: row['å•†å“æè¿°']||row['Description']||'',
                stock: row['åº«å­˜ç‹€æ…‹']||row['Stock']||'',
                tag: row['æ¨™ç±¤']||row['Tag']||'',
                coupon: row['æŠ˜æ‰£ç¢¼']||row['Coupon']||row['DiscountCode']||'',
                note: row['å‚™è¨»']||row['Note']||row['Remark']||'',
                video: row['å½±ç‰‡ç¶²å€']||row['Video']||row['VideoURL']||''
              });
            }
          }
        });

        // æ¸²æŸ“ç”¨ï¼šé upcoming ä¸”æœ‰é€£çµ
        state.groups = all.filter(function(g){ return g.category!=='upcoming' && !!g.url; });

        // è¡Œäº‹æ›†ç”¨ upcomingï¼šä¸»è¡¨ + åˆ†é 
        var fromMain = all.filter(function(g){ return g.category==='upcoming'; })
                          .map(function(g){ return {id:'u-main-'+g.id, brand:g.brand, startDate:g.startDate||'', endDate:g.endDate||'', image:g.image||''}; });
        var fromTab = await loadUpcomingFromTab();
        var seen={}, merged=fromMain.concat(fromTab);
        state.upcomingGroups=[];
        for(var u=0;u<merged.length;u++){
          var it=merged[u], key=(it.brand||'')+'|'+(it.startDate||'')+'|'+(it.endDate||'');
          if(seen[key]) continue; seen[key]=true;
          state.upcomingGroups.push(it);
        }

        state.loading=false;
        renderContent();
      }catch(e){
        showError('ç„¡æ³•é€£æ¥è³‡æ–™ä¾†æºï¼ˆç¶²è·¯æˆ–æ¬Šé™å•é¡Œï¼‰');
      }
    }

    /* ===================== å¡ç‰‡ ===================== */
    function copyCoupon(ev, txt){
      ev.stopPropagation();
      navigator.clipboard.writeText(txt).then(function(){
        var t=document.getElementById('copyToast');
        t.style.opacity='1'; t.style.transform='translateX(0)';
        setTimeout(function(){ t.style.opacity='0'; t.style.transform='translateX(200%)'; }, 1600);
      }).catch(function(){ alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š'+txt); });
    }
    function openNote(ev, url){ ev.stopPropagation(); window.open(url, '_blank'); }

    function renderGroupCard(g){
      var daysLeft=getDaysLeft(g.endDate);
      var expired=isExpired(g.endDate);
      var noteIsURL=isURL(g.note);
      var noteIsQA=isQA(g.note);
      var qaList=noteIsQA?parseQA(g.note):[];
      var openClass = expired ? 'from-gray-400 to-gray-500 hover:from-gray-400 hover:to-gray-500' : 'from-amber-600 to-pink-600 hover:from-amber-700 hover:to-pink-700';

      var countdown='';
      if(g.category==='short' && daysLeft!==null){
        var label = (daysLeft>0)?('å‰© '+daysLeft+' å¤©'):(daysLeft===0?'ä»Šå¤©æˆªæ­¢':'çµæŸ '+Math.abs(daysLeft)+' å¤©');
        var cls   = (daysLeft<0)?'text-gray-500':(daysLeft<=3?'text-red-600 font-semibold':'text-amber-700');
        countdown = '<div class="flex items-center gap-2 text-sm mb-3"><span class="'+cls+'">â± '+label+'</span></div>';
      }

      return ''+
      '<div class="bg-white rounded-xl overflow-hidden border-2 '+(expired?'border-gray-300 opacity-60':'border-amber-200 hover:border-amber-400 hover:shadow-lg')+' transition-all">'+
        (g.image?'<div class="w-full h-48 bg-gray-100"><img src="'+g.image+'" alt="'+g.brand+'" class="w-full h-full object-cover '+(expired?'grayscale':'')+'"></div>':'')+
        '<div class="p-5">'+
          '<h3 class="text-lg font-bold '+(expired?'text-gray-500':'text-amber-900')+' mb-2">'+g.brand+'</h3>'+
          '<div class="flex flex-wrap gap-2 mb-3">'+
            (expired?'<span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full font-medium">å·²çµæŸ</span>':'')+
            (g.tag?'<span class="text-xs bg-pink-100 text-pink-700 px-2 py-1 rounded-full font-medium">'+g.tag+'</span>':'')+
            (g.stock==='å”®å®Œ'?'<span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">å·²å”®å®Œ</span>':'')+
            (g.stock==='å°‘é‡'?'<span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full">å°‘é‡ç¾è²¨</span>':'')+
          '</div>'+
          (g.description?'<p class="text-sm '+(expired?'text-gray-400':'text-gray-600')+' mb-3">'+g.description+'</p>':'')+
          (g.price?'<p class="text-lg font-bold '+(expired?'text-gray-400':'text-amber-700')+' mb-3">'+g.price+'</p>':'')+
          countdown+
          ((g.note && !expired)
            ? (noteIsQA
                ? '<details class="mb-3 bg-indigo-50 border-2 border-indigo-200 rounded-lg p-3"><summary class="cursor-pointer text-indigo-700 font-medium">â“ å¸¸è¦‹å•é¡Œï¼ˆ'+qaList.length+'ï¼‰</summary>'+
                  qaList.map(function(qa){ return '<div class="mt-2 border-t border-indigo-200 pt-2"><p class="text-sm font-semibold text-indigo-900 mb-1">Q: '+qa.q+'</p><p class="text-sm text-indigo-700">A: '+qa.a+'</p></div>'; }).join('')+
                  '</details>'
                : (noteIsURL
                    ? '<div class="mb-3"><button onclick=\'openNote(event, "'+g.note+'")\' class="w-full bg-blue-50 border-2 border-blue-200 text-blue-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-100 transition-colors">ğŸ“ æŸ¥çœ‹è©³ç´°ä»‹ç´¹</button></div>'
                    : '<div class="mb-3 bg-blue-50 border-2 border-blue-200 rounded-lg p-3"><p class="text-xs text-blue-600 font-semibold mb-1">â„¹ï¸ å‚™è¨»</p><p class="text-sm text-blue-900">'+g.note+'</p></div>')
              )
            : ''
          )+
          (g.video && !expired ? '<div class="mb-3"><button onclick=\'openVideoModal(event, "'+g.video+'")\' class="w-full bg-gradient-to-r from-red-50 to-pink-50 border-2 border-red-200 text-red-700 px-4 py-2 rounded-lg text-sm font-medium hover:from-red-100 hover:to-pink-100 transition-colors">ğŸ¬ è§€çœ‹å½±ç‰‡</button></div>' : '')+
          (g.coupon && !expired ? '<div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-3 mb-3"><div class="flex items-center justify-between"><div class="flex-1 min-w-0"><p class="text-xs text-green-700 font-semibold mb-1">ğŸŸï¸ å°ˆå±¬æŠ˜æ‰£ç¢¼</p><code class="text-base font-bold text-green-800 font-mono break-all">'+g.coupon+'</code></div><button onclick=\'copyCoupon(event, "'+g.coupon+'")\' class="ml-3 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-medium">è¤‡è£½</button></div></div>' : '')+
          '<a href="'+g.url+'" target="_blank" rel="noopener noreferrer" class="block w-full text-center text-white py-3 rounded-xl font-bold bg-gradient-to-r '+openClass+'">ç«‹å³å‰å¾€ â†’</a>'+
        '</div>'+
      '</div>';
    }

    function renderCouponCard(g){
      var expired=isExpired(g.endDate);
      var daysLeft=getDaysLeft(g.endDate);
      var noteIsURL=isURL(g.note);
      var noteIsQA=isQA(g.note);
      var qaList=noteIsQA?parseQA(g.note):[];

      return ''+
      '<div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl overflow-hidden border-2 '+(expired?'border-gray-300 opacity-60':'border-purple-200 hover:border-purple-400 hover:shadow-xl')+' transition-all">'+
        (g.image?'<div class="w-full h-40 bg-gray-100"><img src="'+g.image+'" alt="'+g.brand+'" class="w-full h-full object-cover '+(expired?'grayscale':'')+'"></div>':'')+
        '<div class="p-6">'+
          '<h3 class="text-xl font-bold '+(expired?'text-gray-500':'text-purple-900')+' mb-3 break-words">'+g.brand+'</h3>'+
          (g.description?'<p class="text-sm '+(expired?'text-gray-400':'text-gray-600')+' mb-4">'+g.description+'</p>':'')+
          (g.price?'<p class="text-lg font-bold '+(expired?'text-gray-400':'text-purple-700')+' mb-4">'+g.price+'</p>':'')+
          ((g.note && !expired)
            ? (noteIsQA
                ? '<details class="mb-4 bg-indigo-50 border-2 border-indigo-200 rounded-lg p-3"><summary class="cursor-pointer text-indigo-700 font-medium">â“ å¸¸è¦‹å•é¡Œï¼ˆ'+qaList.length+'ï¼‰</summary>'+
                  qaList.map(function(qa){ return '<div class="mt-2 border-t border-indigo-200 pt-2"><p class="text-sm font-semibold text-indigo-900 mb-1">Q: '+qa.q+'</p><p class="text-sm text-indigo-700">A: '+qa.a+'</p></div>'; }).join('')+
                  '</details>'
                : (noteIsURL
                    ? '<button onclick=\'openNote(event, "'+g.note+'")\' class="w-full bg-blue-50 border-2 border-blue-200 text-blue-700 px-4 py-3 rounded-lg font-medium hover:bg-blue-100 transition-colors mb-4">ğŸ“ æŸ¥çœ‹è©³ç´°ä»‹ç´¹</button>'
                    : '<div class="mb-4 bg-blue-50 border-2 border-blue-200 rounded-lg p-3"><p class="text-xs text-blue-600 font-semibold mb-1">â„¹ï¸ å‚™è¨»</p><p class="text-sm text-blue-900">'+g.note+'</p></div>'))
            : ''
          )+
          ((daysLeft!==null && !expired)?'<div class="flex items-center gap-2 text-sm mb-4"><span class="'+(daysLeft<=7?'text-red-600 font-semibold':'text-purple-700')+'">â° '+(daysLeft>0?('å‰© '+daysLeft+' å¤©'):'ä»Šå¤©æˆªæ­¢')+'</span></div>':'')+
          (g.coupon && !expired ? '<div class="bg-white border-2 border-purple-300 rounded-xl p-4 mb-4"><p class="text-xs text-purple-600 font-semibold mb-2">ğŸŸï¸ æŠ˜æ‰£ç¢¼</p><div class="flex items-center gap-3"><code class="text-xl md:text-2xl font-bold text-purple-900 font-mono break-all flex-1 min-w-0">'+g.coupon+'</code><button onclick=\'copyCoupon(event, "'+g.coupon+'")\' class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium whitespace-nowrap flex-shrink-0">è¤‡è£½</button></div></div>':'')+
          '<a href="'+g.url+'" target="_blank" rel="noopener noreferrer" class="block w-full text-center text-white py-3 rounded-xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 '+(expired?'opacity-80':'')+'">'+(expired?'ä»å¯æŸ¥çœ‹ â†’':'ç«‹å³å‰å¾€ â†’')+'</a>'+
        '</div>'+
      '</div>';
    }

    /* ===================== ä¸»å…§å®¹æ¸²æŸ“ï¼ˆåªæ›´æ–° #contentï¼‰ ===================== */
    function toggleExpired(){
      state.showExpired = !state.showExpired;
      try{ localStorage.setItem(STORAGE_KEYS.showExpired, String(state.showExpired)); }catch(e){}
      renderContent();
    }
    function switchCalendarMonth(m){
      state.selectedCalendarMonth = m;
      try{ localStorage.setItem(STORAGE_KEYS.month, String(m)); }catch(e){}
      renderContent();
    }

    function renderContent(){
      if(state.loading){
        document.getElementById('content').innerHTML =
          '<div class="flex items-center justify-center min-h-[40vh]"><div class="text-center"><div class="text-4xl mb-4">ğŸ¦…</div><div class="text-xl text-amber-900 font-bold">è¼‰å…¥ä¸­...</div></div></div>';
        return;
      }
      if(state.error){ return; }

      // ç¯©é¸
      var filtered = state.groups.filter(function(g){
        var okSearch = !state.searchTerm || g.brand.toLowerCase().indexOf(state.searchTerm.toLowerCase())>-1 ||
                       (g.tag||'').toLowerCase().indexOf(state.searchTerm.toLowerCase())>-1 ||
                       (g.description||'').toLowerCase().indexOf(state.searchTerm.toLowerCase())>-1;
        var okExpired = state.showExpired || !isExpired(g.endDate);
        return okSearch && okExpired;
      });

      var longTerm = filtered.filter(function(g){ return g.category==='long'; });
      var shortTerm = filtered.filter(function(g){ return g.category==='short'; }).sort(function(a,b){
        if(!a.endDate && !b.endDate) return 0;
        if(!a.endDate) return 1;
        if(!b.endDate) return -1;
        var A=parseDateSafe(a.endDate), B=parseDateSafe(b.endDate);
        return A - B;
      });
      var coupon = filtered.filter(function(g){ return g.category==='coupon'; });
      var expiredCount = state.groups.filter(function(g){ return isExpired(g.endDate); }).length;

      // ç”Ÿæˆå€æ®µæŒ‰éˆ•ï¼ˆå›ºå®šç¯€é»ï¼‰
      var $btns = document.getElementById('sectionButtons');
      $btns.innerHTML =
        (shortTerm.length?'<button onclick="document.getElementById(\'short-term\').scrollIntoView({behavior:\'smooth\',block:\'start\'});" class="px-4 py-2 bg-orange-100 text-orange-700 rounded-lg font-medium whitespace-nowrap hover:bg-orange-200 text-sm">é™æ™‚åœ˜è³¼</button>':'')+
        (longTerm.length? '<button onclick="document.getElementById(\'long-term\').scrollIntoView({behavior:\'smooth\',block:\'start\'});" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-medium whitespace-nowrap hover:bg-green-200 text-sm">é•·æœŸåœ˜è³¼</button>':'')+
        (coupon.length?   '<button onclick="document.getElementById(\'coupon\').scrollIntoView({behavior:\'smooth\',block:\'start\'});" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg font-medium whitespace-nowrap hover:bg-purple-200 text-sm">æŠ˜æ‰£ç¢¼å„ªæƒ </button>':'')+
        '<button onclick="document.getElementById(\'calendar\').scrollIntoView({behavior:\'smooth\',block:\'start\'});" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-medium whitespace-nowrap hover:bg-blue-200 text-sm">åœ˜è³¼è¡Œäº‹æ›†</button>';

      // ä¸‰å€‹æœˆä»½
      var today=new Date();
      var m1=today.getMonth()+1, m2=(today.getMonth()+1)%12 + 1, m3=(today.getMonth()+2)%12 + 1;

      // å…§å®¹
      document.getElementById('content').innerHTML =
        '<div class="mb-6">'+
          (expiredCount?'<button onclick="toggleExpired()" class="px-4 py-2 rounded-lg font-medium '+(state.showExpired?'bg-gray-600 text-white':'bg-white text-gray-700 border-2 border-gray-300')+'">'+(state.showExpired?'éš±è—':'é¡¯ç¤º')+'å·²çµæŸï¼ˆ'+expiredCount+'ï¼‰</button>':'')+
        '</div>'+

        (shortTerm.length?'<section id="short-term" class="mb-8"><h2 class="text-2xl font-bold text-amber-900 mb-4 flex items-center gap-2"><span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-sm">é™æ™‚</span>é™æ™‚åœ˜è³¼</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">'+shortTerm.map(renderGroupCard).join('')+'</div></section>':'')+
        (longTerm.length? '<section id="long-term" class="mb-8"><h2 class="text-2xl font-bold text-amber-900 mb-4 flex items-center gap-2"><span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">é•·æœŸ</span>å¸¸é§åœ˜è³¼</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">'+longTerm.map(renderGroupCard).join('')+'</div></section>':'')+
        (coupon.length?   '<section id="coupon" class="mb-8"><h2 class="text-2xl font-bold text-amber-900 mb-4 flex items-center gap-2"><span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm">ğŸŸï¸</span>æŠ˜æ‰£ç¢¼å„ªæƒ </h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4">'+coupon.map(renderCouponCard).join('')+'</div></section>':'')+

        '<section id="calendar" class="mb-8">'+
          '<h2 class="text-2xl font-bold text-amber-900 mb-4 flex items-center gap-2"><span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">ğŸ“…</span>åœ˜è³¼è¡Œäº‹æ›†</h2>'+
          '<div class="bg-white rounded-xl p-4 border-2 border-amber-200">'+
            '<div class="flex gap-2 mb-4 justify-center">'+
              '<button onclick="switchCalendarMonth(0)" class="px-4 py-2 rounded-lg font-medium '+(state.selectedCalendarMonth===0?'bg-blue-600 text-white':'bg-gray-100 text-gray-700 hover:bg-gray-200')+'">'+m1+'æœˆ</button>'+
              '<button onclick="switchCalendarMonth(1)" class="px-4 py-2 rounded-lg font-medium '+(state.selectedCalendarMonth===1?'bg-blue-600 text-white':'bg-gray-100 text-gray-700 hover:bg-gray-200')+'">'+m2+'æœˆ</button>'+
              '<button onclick="switchCalendarMonth(2)" class="px-4 py-2 rounded-lg font-medium '+(state.selectedCalendarMonth===2?'bg-blue-600 text-white':'bg-gray-100 text-gray-700 hover:bg-gray-200')+'">'+m3+'æœˆ</button>'+
            '</div>'+
            renderCalendar()+
            '<div class="mt-4 flex gap-4 text-xs text-gray-600 justify-center flex-wrap">'+
              '<div class="flex items-center gap-1"><div class="w-4 h-4 bg-blue-100 border border-blue-300 rounded"></div><span>ä»Šå¤©</span></div>'+
              '<div class="flex items-center gap-1"><div class="w-4 h-4 bg-red-100 border border-red-300 rounded"></div><span>3å¤©å…§æˆªæ­¢</span></div>'+
              '<div class="flex items-center gap-1"><div class="w-4 h-4 bg-orange-100 border border-orange-300 rounded"></div><span>7å¤©å…§æˆªæ­¢</span></div>'+
              '<div class="flex items-center gap-1"><div class="w-4 h-4 bg-amber-100 border border-amber-300 rounded"></div><span>æœ¬æœˆæˆªæ­¢</span></div>'+
              '<div class="flex items-center gap-1"><span class="text-[10px] leading-none px-1.5 py-0.5 rounded bg-white border border-red-300 text-red-700">3</span><span>ï¼ ç•¶æ—¥æˆªæ­¢æ•¸</span></div>'+
              '<div class="flex items-center gap-1"><span class="text-[10px] leading-none px-1.5 py-0.5 rounded bg-white border border-teal-300 text-teal-700">2</span><span>ï¼ ç•¶æ—¥é–‹åœ˜æ•¸</span></div>'+
            '</div>'+
          '</div>'+
        '</section>'+

        ((filtered.length===0 && state.searchTerm)?'<div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-6 text-center"><p class="text-lg text-yellow-900 font-medium">æ‰¾ä¸åˆ°ã€Œ'+state.searchTerm+'ã€ç›¸é—œçš„åœ˜è³¼</p><p class="text-sm text-yellow-700 mt-2">è©¦è©¦å…¶ä»–é—œéµå­—ï¼Œæˆ–æ¸…é™¤æœå°‹æ¢ä»¶</p></div>':'')+
        ((filtered.length===0 && !state.searchTerm)?'<div class="text-center py-12 text-amber-700"><p class="text-lg">ç›®å‰æ²’æœ‰åœ˜è³¼é …ç›®</p></div>':'');
    }

    /* ===================== å•Ÿå‹• ===================== */
    hookSearch();
    loadData();
    setInterval(loadData, 5*60*1000);
  </script>
</body>
</html>
