<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è²¡å‹™è‡ªç”±è·¯å¾‘è©¦ç®—ï½œFIRE Playground</title>
<style>
  /* ==========================================
     SECTION 1: BASE STYLES & VARIABLES
     ========================================== */
  :root{
    --bg:#0f172a;--panel:#111827;--ink:#e5e7eb;--muted:#9ca3af;--line:#1f2937;
    --blue:#60a5fa;--teal:#22d3ee;--orange:#fb923c;--green:#34d399;--asset:#cbd5e1;
    --sur:#8b5cf6;--life:#a78bfa;--fire:#ef4444;--fat:#f59e0b;
    --need:#10b981;--want:#f59e0b;--save:#3b82f6;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC;line-height:1.5}
  header{padding:16px 12px 8px;border-bottom:1px solid var(--line)}
  header h1{margin:0 0 6px 0;font-size:20px;text-align:center}
  header p{margin:0;color:var(--muted);font-size:12px;text-align:center}
  main{max-width:1200px;margin:0 auto;padding:12px;display:grid;gap:12px;grid-template-columns:360px 1fr}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .panel h2{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);font-size:14px;color:#cbd5e1}
  .grid{display:grid;grid-template-columns:1fr;gap:8px;padding:10px}
  .row{display:grid;grid-template-columns:1.2fr 1fr;gap:8px;align-items:center}
  label{font-size:12px;color:var(--muted)}
  input[type="number"],select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #2b3443;background:#0b1220;color:var(--ink)}
  .actions{display:flex;gap:8px;flex-wrap:wrap;padding:0 10px 10px}
  button{cursor:pointer;border:1px solid var(--line);background:#0b1220;color:#e5e7eb;padding:8px 12px;border-radius:10px;font-size:12px}
  button.primary{background:#0ea5e9;border-color:#0284c7}
  button.success{background:#10b981;border-color:#059669}
  button.warning{background:#f59e0b;border-color:#d97706}
  .kpi{display:grid;grid-template-columns:1fr;gap:8px;padding:10px}
  .k{border:1px dashed #334155;border-radius:10px;padding:10px}
  .k.ok{border-color:#14532d;background:rgba(34,197,94,0.08)}
  .k.warn{border-color:#7f1d1d;background:rgba(239,68,68,0.06)}
  .k h3{margin:0 0 6px 0;font-size:13px}
  .k p{margin:2px 0;font-size:12px;color:#cbd5e1}
  .charts{display:grid;grid-template-columns:1fr;gap:12px;padding:10px}
  .chartbox{border:1px solid var(--line);border-radius:12px;padding:10px;position:relative}
  .chartbox h3{margin:0 0 6px 0;font-size:13px;color:#cbd5e1}
  .chart-wrapper{position:relative;width:100%;overflow:hidden}
  canvas{display:block;width:100%;height:380px;touch-action:pan-y}
  footer{max-width:1200px;margin:8px auto 20px;color:#9ca3af;text-align:center;font-size:12px}
  .back-home{text-align:center;margin:20px auto;max-width:1200px}
  .back-home a{display:inline-block;padding:12px 24px;background:#0ea5e9;color:white;text-decoration:none;border-radius:10px;font-size:14px;border:1px solid #0284c7}
  .back-home a:hover{background:#0284c7}
  .tooltip{position:fixed;background:rgba(17,24,39,0.95);border:1px solid var(--line);border-radius:8px;padding:8px 12px;font-size:11px;pointer-events:none;display:none;z-index:1000;color:var(--ink);white-space:nowrap;max-width:90vw}
  .tooltip-row{margin:2px 0}
  .tooltip-label{color:var(--muted);margin-right:8px}
  
  /* ==========================================
     SECTION 2: ACCORDION COMPONENTS
     ========================================== */
  .accordion{margin-top:12px}
  .accordion-item{border:1px solid var(--line);border-radius:10px;margin-bottom:8px;overflow:hidden}
  .accordion-header{padding:10px 12px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;background:rgba(15,23,42,0.5);transition:background 0.2s}
  .accordion-header:hover{background:rgba(15,23,42,0.8)}
  .accordion-header h3{margin:0;font-size:13px;display:flex;align-items:center;gap:6px}
  .accordion-icon{font-size:12px;transition:transform 0.2s}
  .accordion-item.open .accordion-icon{transform:rotate(90deg)}
  .accordion-content{max-height:0;overflow:hidden;transition:max-height 0.3s ease-out}
  .accordion-item.open .accordion-content{max-height:3000px;transition:max-height 0.5s ease-in}
  .accordion-body{padding:10px}
  
  /* ==========================================
     SECTION 3: EXPENSE CALCULATOR STYLES
     ========================================== */
  .expense-calculator{font-size:12px}
  .expense-category{border:1px solid var(--line);border-radius:8px;margin-bottom:10px;overflow:hidden}
  .expense-category-header{padding:8px 10px;background:rgba(15,23,42,0.6);display:flex;align-items:center;justify-content:space-between;cursor:pointer}
  .expense-category-header:hover{background:rgba(15,23,42,0.8)}
  .expense-category-title{display:flex;align-items:center;gap:6px;font-weight:600;font-size:13px}
  .expense-category.need .expense-category-title{color:var(--need)}
  .expense-category.want .expense-category-title{color:var(--want)}
  .expense-category-total{font-size:12px;color:var(--muted)}
  .expense-category-body{padding:10px;display:none}
  .expense-category.open .expense-category-body{display:block}
  .expense-category.open .category-arrow{transform:rotate(90deg)}
  .category-arrow{font-size:10px;transition:transform 0.2s}
  
  .expense-item{display:grid;grid-template-columns:1.2fr 1fr;gap:8px;align-items:center;margin-bottom:6px}
  .expense-item:last-child{margin-bottom:0}
  .expense-item label{font-size:11px;color:var(--muted)}
  .expense-item input{padding:6px 8px;font-size:11px}
  
  .expense-summary{background:rgba(15,23,42,0.4);border:1px solid var(--line);border-radius:8px;padding:12px;margin:12px 0}
  .expense-summary-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-size:12px}
  .expense-summary-row:last-child{margin-bottom:0;padding-top:8px;border-top:1px dashed var(--line);font-weight:600;font-size:13px}
  .expense-summary-label{color:var(--muted)}
  .expense-summary-value{font-weight:600}
  
  .expense-progress{margin-top:12px}
  .expense-progress-item{margin-bottom:10px}
  .expense-progress-label{display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px}
  .expense-progress-bar{height:6px;background:var(--line);border-radius:3px;overflow:hidden}
  .expense-progress-fill{height:100%;border-radius:3px;transition:width 0.3s}
  .expense-progress-fill.need{background:var(--need)}
  .expense-progress-fill.want{background:var(--want)}
  
  .scenario-buttons{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
  .scenario-buttons button{font-size:11px;padding:6px 10px}
  
  .expense-actions{display:flex;gap:8px;margin-top:12px}
  .expense-actions button{flex:1;font-size:12px;padding:8px}
  
  /* ==========================================
     SECTION 4: SUGGESTION CARDS
     ========================================== */
  .suggestions{display:grid;grid-template-columns:1fr;gap:10px;padding:10px 0}
  .suggestion-card{border:1px solid var(--line);border-radius:10px;padding:12px;background:rgba(15,23,42,0.3)}
  .suggestion-card.info{border-left:3px solid #3b82f6}
  .suggestion-card.warning{border-left:3px solid #f59e0b}
  .suggestion-card.success{border-left:3px solid #10b981}
  .suggestion-card h4{margin:0 0 8px 0;font-size:13px;display:flex;align-items:center;gap:6px}
  .suggestion-card p{margin:6px 0;font-size:12px;line-height:1.6;color:var(--muted)}
  .suggestion-card ul{margin:8px 0;padding-left:20px;font-size:12px;color:var(--muted)}
  .suggestion-card button{margin-top:8px;font-size:11px;padding:6px 12px}
  
  /* ==========================================
     SECTION 5: HELP & TOOLTIP COMPONENTS
     ========================================== */
  .help-icon{display:inline-block;width:16px;height:16px;border-radius:50%;background:#3b82f6;color:white;text-align:center;line-height:16px;font-size:11px;cursor:help;margin-left:4px}
  .help-icon:hover{background:#2563eb}
  .help-popup{position:absolute;background:rgba(17,24,39,0.98);border:1px solid var(--line);border-radius:8px;padding:10px;font-size:11px;line-height:1.5;max-width:250px;z-index:100;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.3)}
  .help-popup.show{display:block}
  
  /* ==========================================
     SECTION 6: SUMMARY & TIMELINE
     ========================================== */
  .summary-card{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:12px;text-align:center}
  .summary-card .main-result{font-size:16px;font-weight:600;margin-bottom:8px;line-height:1.6}
  .summary-card .main-result .emoji{font-size:20px;margin-right:6px}
  .summary-card .sub-text{font-size:12px;color:var(--muted)}
  
  .timeline{padding:16px 0;margin:12px 0}
  .timeline-track{position:relative;height:3px;background:var(--line);border-radius:2px;margin:20px 0}
  .timeline-points{position:relative;display:flex;justify-content:space-between;margin-top:-12px}
  .timeline-point{text-align:center;flex:1;position:relative}
  .timeline-point .dot{width:12px;height:12px;border-radius:50%;background:var(--muted);margin:0 auto 6px;border:2px solid var(--bg)}
  .timeline-point.achieved .dot{background:var(--green);box-shadow:0 0 8px var(--green)}
  .timeline-point.current .dot{background:var(--blue);box-shadow:0 0 8px var(--blue)}
  .timeline-point .label{font-size:10px;color:var(--muted);margin-top:4px}
  .timeline-point .year{font-size:11px;font-weight:600;margin-top:2px}
  
  /* ==========================================
     SECTION 7: RESPONSIVE DESIGN
     ========================================== */
  @media(max-width:900px){ 
    main{grid-template-columns:1fr}
    canvas{height:320px}
    .chartbox{padding:8px}
    .chartbox h3{font-size:12px}
    header h1{font-size:18px}
    header p{font-size:11px}
    .suggestions{grid-template-columns:1fr}
    .suggestion-card{padding:10px}
    .suggestion-card h4{font-size:12px}
    .help-popup{max-width:200px;font-size:10px}
    .expense-actions{flex-direction:column}
    .expense-actions button{width:100%}
  }
</style>
</head>
<body>
<header>
  <h1>è²¡å‹™è‡ªç”±è·¯å¾‘è©¦ç®—ï½œFIRE Playground</h1>
  <p>è¼¸å…¥å°å¹£é‡‘é¡èˆ‡åƒæ•¸ï¼Œç³»çµ±å³æ™‚è¨ˆç®—ï¼šã€Œç”Ÿå­˜/ç”Ÿæ´»/å·¥ä½œè‡ªç”±ã€èˆ‡ FIRE / FAT FIRE çš„é”æˆé–€æª»èˆ‡è¶¨å‹¢ã€‚</p>
</header>

<main>
  <!-- ==========================================
       INPUT PANEL
       ========================================== -->
  <section class="panel">
    <h2>åŸºæœ¬åƒæ•¸</h2>
    <div class="grid">
      <div class="row">
        <label>ç›®å‰è³‡ç”¢æ·¨å€¼<span class="help-icon" data-help="assets">?</span></label>
        <input id="assets" type="number" step="10000" value="1500000"/>
      </div>
      <div class="row">
        <label>æ¯æœˆç¸½æ”¶å…¥<span class="help-icon" data-help="totalIncome">?</span></label>
        <input id="totalIncome" type="number" step="1000" value="105000"/>
      </div>
      <div class="row">
        <label>åŸºæœ¬ç”Ÿæ´»è²»ï¼ˆæœˆï¼‰<span class="help-icon" data-help="survival">?</span></label>
        <input id="survival" type="number" step="1000" value="25000"/>
      </div>
      <div class="row">
        <label>ç†æƒ³ç”Ÿæ´»è²»ï¼ˆæœˆï¼‰<span class="help-icon" data-help="lifestyle">?</span></label>
        <div style="display:flex;gap:6px;align-items:center">
          <input id="lifestyle" type="number" step="1000" value="50000" style="flex:1"/>
          <button id="openExpenseCalc" style="padding:6px 10px;font-size:11px" title="æ‰“é–‹æ”¯å‡ºè¦åŠƒ">ğŸ“‹</button>
        </div>
      </div>
      <div class="row">
        <label>æŠ•è³‡å¹´åŒ–å ±é…¬ %<span class="help-icon" data-help="returnRate">?</span></label>
        <input id="returnRate" type="number" step="0.1" value="6"/>
      </div>
      <div class="row">
        <label>æ¨¡æ“¬å¹´æ•¸</label>
        <input id="years" type="number" min="1" max="60" value="30"/>
      </div>
    </div>
    
    <!-- ==========================================
         ACCORDION: EXPENSE CALCULATOR
         ========================================== -->
    <div class="accordion">
      <div class="accordion-item" id="expenseAccordion">
        <div class="accordion-header">
          <h3><span class="accordion-icon">â–¶</span> ğŸ’³ æ”¯å‡ºè©³ç´°è¦åŠƒï¼ˆ50/30/20æ³•å‰‡ï¼‰</h3>
        </div>
        <div class="accordion-content">
          <div class="accordion-body">
            <div class="expense-calculator">
              <p style="font-size:11px;color:var(--muted);margin:0 0 12px 0">
                åŸºæ–¼è²¡å‹™è¦åŠƒé»ƒé‡‘æ³•å‰‡ï¼š50% å¿…è¦æ”¯å‡ºã€30% æƒ³è¦æ”¯å‡ºã€20% å„²è“„æŠ•è³‡ã€‚å¡«å¯«å®Œæˆå¾Œå¯å¥—ç”¨è‡³ä¸Šæ–¹ã€Œç†æƒ³ç”Ÿæ´»è²»ã€ã€‚
              </p>
              
              <!-- ç•¶å‰ç‹€æ…‹è²æ˜ -->
              <div style="margin-bottom:12px;padding:10px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:8px">
                <div style="font-size:12px;font-weight:600;margin-bottom:6px">ğŸ“ æˆ‘ç›®å‰çš„ç”Ÿæ´»ç‹€æ…‹</div>
                <div class="scenario-buttons" style="margin-bottom:0">
                  <button onclick="ExpenseCalc.setCurrentState('single')" id="state-single">ğŸ™ å–®èº«</button>
                  <button onclick="ExpenseCalc.setCurrentState('couple')" id="state-couple">ğŸ‘« å·²å©š</button>
                  <button onclick="ExpenseCalc.setCurrentState('family')" id="state-family" class="primary">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ è‚²å…’ä¸­</button>
                  <button onclick="ExpenseCalc.setCurrentState('empty')" id="state-empty">ğŸ‘« ç©ºå·¢æœŸ</button>
                  <button onclick="ExpenseCalc.setCurrentState('retire')" id="state-retire">ğŸ–ï¸ é€€ä¼‘</button>
                </div>
                <p style="font-size:10px;color:var(--muted);margin:6px 0 0 0">
                  ğŸ’¡ å…ˆé¸æ“‡æ‚¨ç›®å‰çš„ç‹€æ…‹ï¼Œä¸‹æ–¹å¡«å…¥çš„æ•¸å€¼å°±æ˜¯æ­¤ç‹€æ…‹çš„å¯¦éš›æ”¯å‡º
                </p>
              </div>
              
              <!-- å¿…è¦æ”¯å‡º (Needs) -->
              <div class="expense-category need open">
                <div class="expense-category-header" onclick="ExpenseCalc.toggleCategory(this)">
                  <div class="expense-category-title">
                    <span class="category-arrow">â–¶</span>
                    <span>ğŸ  å¿…è¦æ”¯å‡º (Needs)</span>
                  </div>
                  <div class="expense-category-total" id="needTotal">NT$ 0</div>
                </div>
                <div class="expense-category-body">
                  <div class="expense-item">
                    <label>æˆ¿ç§Ÿ/æˆ¿è²¸</label>
                    <input type="number" id="exp_rent" value="15000" oninput="ExpenseCalc.calculate()">
                  </div>
                  <div class="expense-item">
                    <label>ç®¡ç†è²»</label>
                    <input type="number" id="exp_management" value="2000" oninput="ExpenseCalc.calculate()">
                  </div>
                  <div class="expense-item">
                    <label>æ°´é›»ç“¦æ–¯</label>
                    <input type="number" id="exp_utilities" value="2000" oninput="ExpenseCalc.calculate()">
                  </div>
                  <div class="expense-item">
                    <label>ä¸‰é¤é£Ÿæ</label>
                    <input type="number" id="exp_groceries" value="6000" oninput="ExpenseCalc.calculate()">
                  </div>
                  <div class="expense-item">
                    <label>é€šå‹¤äº¤é€š</label>
                    <input type="number" id="exp_transport" value="2000" oninput="ExpenseCalc.calculate()">
                  </div>
                  <div class="expense-item">
                    <label>æ²¹è³‡/åœè»Š</label>
                    <input type="number" id="exp_fuel" value="3000" oninput="ExpenseCalc.calculate()">
                  </div>
                  <div class="expense-item">
                    <label>å‹å¥ä¿</label>
                    <input type="number" id="exp_health" value="1000" oninput="ExpenseCalc.calculate()">
                  </div>
                  <div class="expense-item">
                    <label>å•†æ¥­ä¿éšª</label>
                    <input type="number" id="exp_insurance" value="3000" oninput="ExpenseCalc.calculate()">
                  </div>
                  <div class="expense-item">
                    <label>è²¸æ¬¾å„Ÿé‚„</label>
                    <input type="number" id="exp_loan" value="0" oninput="ExpenseCalc.calculate()">
                  </div>
                </div>
              </div>
              
              <!-- æƒ³è¦æ”¯å‡º (Wants) -->
              <div class="expense-category want open">
                <div class="expense-category-header" onclick="ExpenseCalc.toggleCategory(this)">
                  <div class="expense-category-title">
                    <span class="category-arrow">â–¶</span>
                    <span>ğŸ­ æƒ³è¦æ”¯å‡º (Wants)</span>
                  </div>
                  <div class="expense-category-total" id="wantTotal">NT$ 0</div>
                </div>
                <div class="expense-category-body">
                  <div class="expense-item">
                    <label>å¤–é£Ÿé¤å»³</label>
                    <input type="number" id="exp_dining" value="4000" oninput="ExpenseCalc.calculate()">
                  </div>
                  <div class="expense-item">
                    <label>æ—…éŠä¼‘é–’</label>
                    <input type="number" id="exp_travel" value="5000" oninput="ExpenseCalc.calculate()">
                  </div>
                  <div class="expense-item">
                    <label>èšé¤çœ‹é›»å½±</label>
                    <input type="number" id="exp_entertainment" value="3000" oninput="ExpenseCalc.calculate()">
                  </div>
                  <div class="expense-item">
                    <label>æ²»è£è²»</label>
                    <input type="number" id="exp_clothing" value="2000" oninput="ExpenseCalc.calculate()">
                  </div>
                  <div class="expense-item">
                    <label>3C/èˆˆè¶£</label>
                    <input type="number" id="exp_hobbies" value="2000" oninput="ExpenseCalc.calculate()">
                  </div>
                  <div class="expense-item">
                    <label>ä¸²æµå½±éŸ³</label>
                    <input type="number" id="exp_streaming" value="500" oninput="ExpenseCalc.calculate()">
                  </div>
                  <div class="expense-item">
                    <label>å¥èº«æˆ¿/å…¶ä»–è¨‚é–±</label>
                    <input type="number" id="exp_subscriptions" value="500" oninput="ExpenseCalc.calculate()">
                  </div>
                </div>
              </div>
              
              <!-- æƒ…å¢ƒé æ¸¬åŠŸèƒ½å€ -->
              <div style="margin:16px 0;padding:12px;background:rgba(139,92,246,0.05);border:1px solid rgba(139,92,246,0.2);border-radius:8px">
                <div style="font-size:12px;font-weight:600;margin-bottom:8px">ğŸ”® æœªä¾†æƒ…å¢ƒé æ¸¬</div>
                <p style="font-size:10px;color:var(--muted);margin:0 0 8px 0">
                  æ ¹æ“šæ‚¨ç›®å‰çš„æ”¯å‡ºï¼Œé æ¸¬æœªä¾†ä¸åŒç”Ÿæ´»éšæ®µçš„å¯èƒ½èŠ±è²»
                </p>
                <div class="scenario-buttons">
                  <button onclick="ExpenseCalc.predictScenario('single')">ğŸ™ å–®èº«</button>
                  <button onclick="ExpenseCalc.predictScenario('couple')">ğŸ‘« å·²å©š</button>
                  <button onclick="ExpenseCalc.predictScenario('family')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ è‚²å…’ä¸­</button>
                  <button onclick="ExpenseCalc.predictScenario('empty')">ğŸ‘« ç©ºå·¢æœŸ</button>
                  <button onclick="ExpenseCalc.predictScenario('retire')">ğŸ–ï¸ é€€ä¼‘</button>
                </div>
                <!-- é æ¸¬çµæœé¡¯ç¤ºå€ -->
                <div id="predictionResult" style="margin-top:8px"></div>
              </div>
              
              <!-- æ”¯å‡ºç¸½çµ -->
              <div class="expense-summary">
                <div class="expense-summary-row">
                  <span class="expense-summary-label">å¿…è¦æ”¯å‡º</span>
                  <span class="expense-summary-value" id="summaryNeed" style="color:var(--need)">NT$ 0</span>
                </div>
                <div class="expense-summary-row">
                  <span class="expense-summary-label">æƒ³è¦æ”¯å‡º</span>
                  <span class="expense-summary-value" id="summaryWant" style="color:var(--want)">NT$ 0</span>
                </div>
                <div class="expense-summary-row">
                  <span class="expense-summary-label">æœˆç¸½æ”¯å‡º</span>
                  <span class="expense-summary-value" id="summaryTotal">NT$ 0</span>
                </div>
              </div>
              
              <!-- æ”¯å‡ºæ¯”ä¾‹é€²åº¦æ¢ -->
              <div class="expense-progress">
                <div class="expense-progress-item">
                  <div class="expense-progress-label">
                    <span style="color:var(--need)">å¿…è¦æ”¯å‡ºæ¯”ä¾‹</span>
                    <span id="needPercent">0%</span>
                  </div>
                  <div class="expense-progress-bar">
                    <div class="expense-progress-fill need" id="needBar" style="width:0%"></div>
                  </div>
                </div>
                <div class="expense-progress-item">
                  <div class="expense-progress-label">
                    <span style="color:var(--want)">æƒ³è¦æ”¯å‡ºæ¯”ä¾‹</span>
                    <span id="wantPercent">0%</span>
                  </div>
                  <div class="expense-progress-bar">
                    <div class="expense-progress-fill want" id="wantBar" style="width:0%"></div>
                  </div>
                </div>
              </div>
              
              <!-- æ“ä½œæŒ‰éˆ• -->
              <div class="expense-actions">
                <button class="success" onclick="ExpenseCalc.applyToLifestyle()">
                  âœ“ å¥—ç”¨åˆ°ç†æƒ³ç”Ÿæ´»è²»
                </button>
                <button class="primary" onclick="ExpenseCalc.applyToSurvival()">
                  âš¡ åƒ…å¥—ç”¨å¿…è¦æ”¯å‡ºåˆ°åŸºæœ¬ç”Ÿæ´»è²»
                </button>
              </div>
              
              <!-- æ™ºèƒ½å»ºè­° -->
              <div id="expenseAdvice" style="margin-top:12px"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ==========================================
           ACCORDION: INCOME DETAILS
           ========================================== -->
      <div class="accordion-item">
        <div class="accordion-header">
          <h3><span class="accordion-icon">â–¶</span> ğŸ’° æ”¶å…¥ç´°ç¯€ï¼ˆé¸å¡«ï¼‰</h3>
        </div>
        <div class="accordion-content">
          <div class="accordion-body">
            <p style="font-size:11px;color:var(--muted);margin:0 0 10px 0">åˆ†é–‹è¨­å®šä¸»æ¥­å’Œå‰¯æ¥­å¯ä»¥æ›´æº–ç¢ºé æ¸¬æœªä¾†æ”¶å…¥æˆé•·ã€‚ç•™ç©ºå‰‡ä½¿ç”¨ç¸½æ”¶å…¥ã€‚</p>
            <div class="grid">
              <div class="row">
                <label>ä¸»æ¥­æœˆæ”¶å…¥<span class="help-icon" data-help="mainIncome">?</span></label>
                <input id="mainIncome" type="number" step="1000" value="90000"/>
              </div>
              <div class="row">
                <label>å‰¯æ¥­æœˆæ”¶å…¥<span class="help-icon" data-help="sideIncome">?</span></label>
                <input id="sideIncome" type="number" step="1000" value="15000"/>
              </div>
              <div class="row">
                <label>ä¸»æ¥­å¹´æˆé•·ç‡ %<span class="help-icon" data-help="mainGrowth">?</span></label>
                <input id="mainGrowth" type="number" step="0.1" value="3"/>
              </div>
              <div class="row">
                <label>å‰¯æ¥­å¹´æˆé•·ç‡ %<span class="help-icon" data-help="sideGrowth">?</span></label>
                <input id="sideGrowth" type="number" step="0.1" value="10"/>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ==========================================
           ACCORDION: INFLATION & EXPENSES
           ========================================== -->
      <div class="accordion-item">
        <div class="accordion-header">
          <h3><span class="accordion-icon">â–¶</span> ğŸŒ¡ï¸ é€šè†¨èˆ‡æ”¯å‡º</h3>
        </div>
        <div class="accordion-content">
          <div class="accordion-body">
            <p style="font-size:11px;color:var(--muted);margin:0 0 10px 0">é€šè†¨æœƒè®“æœªä¾†çš„éŒ¢è®Šè–„ï¼Œå»ºè­°è¨­å®š 2-3% çš„å¹´é€šè†¨ç‡è®“è¨ˆç®—æ›´è²¼è¿‘ç¾å¯¦ã€‚</p>
            <div class="grid">
              <div class="row">
                <label>å¹´é€šè†¨ç‡ %<span class="help-icon" data-help="inflation">?</span></label>
                <input id="inflation" type="number" step="0.1" value="2"/>
              </div>
              <div class="row">
                <label>ç”Ÿæ´»è²»å¹´æˆé•· %<span class="help-icon" data-help="expenseGrowth">?</span></label>
                <input id="expenseGrowth" type="number" step="0.1" value="2"/>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ==========================================
           ACCORDION: RISK LEVEL
           ========================================== -->
      <div class="accordion-item">
        <div class="accordion-header">
          <h3><span class="accordion-icon">â–¶</span> ğŸ¯ é¢¨éšªåå¥½</h3>
        </div>
        <div class="accordion-content">
          <div class="accordion-body">
            <p style="font-size:11px;color:var(--muted);margin:0 0 10px 0">é¸æ“‡æŠ•è³‡é¢¨éšªç­‰ç´šï¼Œç³»çµ±æœƒè‡ªå‹•èª¿æ•´å ±é…¬ç‡èˆ‡ FAT FIRE å€æ•¸ã€‚</p>
            <div class="grid">
              <div class="row">
                <label>é¢¨éšªç­‰ç´š</label>
                <select id="riskLevel">
                  <option value="conservative">ä¿å®ˆå‹ï¼ˆä½é¢¨éšªï¼‰</option>
                  <option value="moderate" selected>ç©©å¥å‹ï¼ˆä¸­é¢¨éšªï¼‰</option>
                  <option value="aggressive">ç©æ¥µå‹ï¼ˆé«˜é¢¨éšªï¼‰</option>
                </select>
              </div>
              <div class="row">
                <label>FAT FIRE å€æ•¸<span class="help-icon" data-help="fat">?</span></label>
                <input id="fat" type="number" step="0.1" value="1.8"/>
              </div>
            </div>
            <button id="fatfill" style="width:100%;margin-top:8px">è‡ªå‹•å¡«å…¥å»ºè­° FAT å€æ•¸</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ“ä½œæŒ‰éˆ• -->
    <div class="actions">
      <button id="calc" class="primary">é‡æ–°è¨ˆç®—</button>
      <button id="share">åˆ†äº«çµæœ</button>
      <button id="savepng">ä¸‹è¼‰åœ–è¡¨</button>
      <button id="reset">é‡è¨­</button>
    </div>
  </section>
  
  <!-- ==========================================
       RESULT PANEL
       ========================================== -->
  <section class="panel">
    <h2>è©¦ç®—çµæœ</h2>
    
    <!-- ç¸½çµå¡ç‰‡ -->
    <div id="summaryCard" style="padding:10px"></div>
    
    <!-- æ™‚é–“è»¸ -->
    <div id="timeline" style="padding:10px"></div>
    
    <!-- KPI å€ -->
    <div class="kpi" id="kpi"></div>
    
    <!-- æ™ºèƒ½å»ºè­° -->
    <div id="suggestions" style="padding:10px"></div>
    
    <!-- åœ–è¡¨å€ -->
    <div class="charts">
      <div class="chartbox">
        <h3>ç¾é‡‘æµè¶¨å‹¢</h3>
        <div class="chart-wrapper">
          <canvas id="cvCash"></canvas>
        </div>
      </div>
      <div class="chartbox">
        <h3>è³‡ç”¢ç´¯ç©è·¯å¾‘ï¼ˆä¸‰ç¨®æƒ…å¢ƒï¼‰</h3>
        <div class="chart-wrapper">
          <canvas id="cvAsset"></canvas>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>
  Â© 2025 FIRE Playground. æœ¬å·¥å…·åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›è²¡å‹™è¦åŠƒè«‹è«®è©¢å°ˆæ¥­é¡§å•ã€‚
</footer>

<div class="back-home">
  <a href="https://www.buytogetherlike.com">â† å›åˆ° é·¹å®¶è²·ç‰©ç¤¾é¦–é </a>
</div>

<!-- Tooltips -->
<div id="tooltipCash" class="tooltip"></div>
<div id="tooltipAsset" class="tooltip"></div>

<script>
// ==========================================
// SECTION 1: CONFIGURATION & HELPERS
// ==========================================
const $=(s)=>document.querySelector(s), $$=(s)=>document.querySelectorAll(s);
const fmt=(n)=>Math.round(n).toLocaleString('zh-TW');
const C={
  blue:'#60a5fa',teal:'#22d3ee',orange:'#fb923c',green:'#34d399',
  sur:'#8b5cf6',life:'#a78bfa',fire:'#ef4444',fat:'#f59e0b',asset:'#cbd5e1'
};

const defaults={
  assets:1500000,totalIncome:105000,survival:25000,lifestyle:50000,
  returnRate:6,years:30,mainIncome:90000,sideIncome:15000,
  mainGrowth:3,sideGrowth:10,inflation:2,expenseGrowth:2,
  riskLevel:'moderate',fat:1.8
};

const helpTexts={
  assets:'ç›®å‰æ“æœ‰çš„ç¸½è³‡ç”¢ï¼ˆåŒ…å«å­˜æ¬¾ã€æŠ•è³‡ã€ä¸å‹•ç”¢ç­‰ï¼‰æ‰£é™¤è² å‚µå¾Œçš„æ·¨å€¼ã€‚',
  totalIncome:'æ¯æœˆç¨…å¾Œç¸½æ”¶å…¥ï¼ŒåŒ…å«è–ªè³‡ã€çé‡‘ã€è¢«å‹•æ”¶å…¥ç­‰æ‰€æœ‰æ”¶å…¥ä¾†æºã€‚',
  survival:'ç¶­æŒåŸºæœ¬ç”Ÿå­˜æ‰€éœ€çš„æœ€ä½æœˆæ”¯å‡ºï¼ŒåŒ…å«æˆ¿ç§Ÿã€åŸºæœ¬é£²é£Ÿã€äº¤é€šã€ä¿éšªç­‰å¿…è¦é–‹éŠ·ã€‚',
  lifestyle:'ç†æƒ³ç”Ÿæ´»å“è³ªæ‰€éœ€çš„æœˆæ”¯å‡ºï¼ŒåŒ…å«å¨›æ¨‚ã€æ—…éŠã€å¤–é£Ÿç­‰æƒ³è¦çš„é–‹éŠ·ã€‚',
  returnRate:'é æœŸçš„å¹´åŒ–æŠ•è³‡å ±é…¬ç‡ã€‚ä¿å®ˆå‹å»ºè­° 4-5%ï¼Œç©©å¥å‹ 6-7%ï¼Œç©æ¥µå‹ 8-10%ã€‚',
  mainIncome:'ä¸»è¦å·¥ä½œçš„æœˆæ”¶å…¥ï¼ˆè–ªè³‡ï¼‰ã€‚',
  sideIncome:'å‰¯æ¥­æˆ–å…¶ä»–é¡å¤–æ”¶å…¥ï¼ˆå¦‚æ¥æ¡ˆã€æŠ•è³‡æ”¶ç›Šç­‰ï¼‰ã€‚',
  mainGrowth:'ä¸»æ¥­æ”¶å…¥çš„é æœŸå¹´æˆé•·ç‡ï¼Œé€šå¸¸èˆ‡èª¿è–ªã€å‡é·æœ‰é—œã€‚',
  sideGrowth:'å‰¯æ¥­æ”¶å…¥çš„é æœŸå¹´æˆé•·ç‡ï¼Œæ–°å‰µå‰¯æ¥­æˆé•·é€šå¸¸è¼ƒå¿«ã€‚',
  inflation:'å¹´é€šè†¨ç‡ï¼Œå°ç£è¿‘å¹´ç´„ 1.5-2.5%ã€‚',
  expenseGrowth:'ç”Ÿæ´»è²»ç”¨çš„å¹´æˆé•·ç‡ï¼Œé€šå¸¸æ¥è¿‘é€šè†¨ç‡ã€‚',
  fat:'FAT FIRE æ˜¯ç†æƒ³ç”Ÿæ´»è²»çš„å€æ•¸ï¼Œä»£è¡¨æ›´å¯¬è£•çš„é€€ä¼‘ç”Ÿæ´»ã€‚å»ºè­° 1.5-2 å€ã€‚',
  survivalFreedom:'ã€ç”Ÿå­˜è‡ªç”±ã€‘ç•¶è¢«å‹•æ”¶å…¥ï¼ˆè³‡ç”¢ Ã— 4%ï¼‰â‰¥ åŸºæœ¬ç”Ÿæ´»è²»æ™‚é”æˆã€‚æ­¤æ™‚å³ä½¿å¤±æ¥­ï¼Œä¹Ÿèƒ½ç¶­æŒåŸºæœ¬ç”Ÿå­˜ï¼Œä¸å¿…æ“”å¿ƒé¤“æ­»ã€‚é€™æ˜¯è²¡å‹™å®‰å…¨çš„ç¬¬ä¸€é“é˜²ç·šã€‚',
  lifestyleFreedom:'ã€ç”Ÿæ´»è‡ªç”±ã€‘ç•¶è¢«å‹•æ”¶å…¥ï¼ˆè³‡ç”¢ Ã— 4%ï¼‰â‰¥ ç†æƒ³ç”Ÿæ´»è²»æ™‚é”æˆã€‚æ­¤æ™‚å®Œå…¨ä¸å·¥ä½œä¹Ÿèƒ½éä¸Šç†æƒ³ç”Ÿæ´»ï¼Œå¯¦ç¾çœŸæ­£çš„è²¡å‹™è‡ªç”±ã€‚é€™å°±æ˜¯å‚³çµ±æ„ç¾©çš„ FIREã€‚',
  workFreedom:'ã€å·¥ä½œè‡ªç”±ã€‘ç•¶å‰¯æ¥­æ”¶å…¥ + è¢«å‹•æ”¶å…¥ â‰¥ ç†æƒ³ç”Ÿæ´»è²»æ™‚é”æˆã€‚æ­¤æ™‚å¯ä»¥è¾­å»ä¸»æ¥­å·¥ä½œï¼Œé å‰¯æ¥­å’ŒæŠ•è³‡æ”¶å…¥ç¶­æŒç”Ÿæ´»ã€‚é›–ç„¶ä»éœ€å·¥ä½œï¼Œä½†æœ‰é¸æ“‡å·¥ä½œçš„è‡ªç”±ï¼Œä¸è¢«ä¸»æ¥­ç¶æ­»ã€‚',
  fire:'ã€FIRE = Financial Independence, Retire Earlyã€‘è²¡å‹™ç¨ç«‹ã€æå‰é€€ä¼‘ã€‚ç•¶è¢«å‹•æ”¶å…¥è¶³ä»¥æ”¯ä»˜ç†æƒ³ç”Ÿæ´»è²»æ™‚ï¼Œå¯é¸æ“‡æå‰é€€ä¼‘ã€‚æ ¸å¿ƒç†å¿µï¼šé€éé«˜å„²è“„ç‡å’ŒæŠ•è³‡ï¼Œåœ¨ 40-50 æ­²é”æˆè²¡å‹™è‡ªç”±ã€‚',
  leanFire:'ã€Lean FIREã€‘ç²¾ç°¡ç‰ˆ FIREï¼Œä»¥è¼ƒä½çš„ç”Ÿæ´»è²»ï¼ˆé€šå¸¸æ˜¯åŸºæœ¬ç”Ÿæ´»è²»ï¼‰æå‰é€€ä¼‘ã€‚å„ªé»æ˜¯è¼ƒå¿«é”æˆï¼Œç¼ºé»æ˜¯ç”Ÿæ´»è¼ƒç‚ºç¯€å„‰ã€‚é©åˆæ¥µç°¡ä¸»ç¾©è€…ã€‚',
  fatFire:'ã€FAT FIREã€‘å¯Œè£•ç‰ˆ FIREï¼Œä»¥ 1.5-2 å€çš„ç†æƒ³ç”Ÿæ´»è²»é€€ä¼‘ã€‚å¯äº«å—æ›´å¯¬è£•çš„ç”Ÿæ´»å“è³ªï¼Œæœ‰è¶³å¤ é ç®—æ‡‰å°æ„å¤–é–‹éŠ·ã€æ—…éŠã€å¥¢ä¾ˆå“ç­‰ã€‚é©åˆè¿½æ±‚é«˜å“è³ªé€€ä¼‘ç”Ÿæ´»è€…ã€‚',
  baristaFire:'ã€Barista FIREã€‘åŠé€€ä¼‘ç‹€æ…‹ï¼Œè¢«å‹•æ”¶å…¥ + è¼•é¬†å…¼è·ï¼ˆå¦‚å’–å•¡å¸«ï¼‰= ç†æƒ³ç”Ÿæ´»è²»ã€‚ä¸å®Œå…¨é€€ä¼‘ï¼Œä¿æŒç¤¾äº¤å’Œè¼•åº¦å·¥ä½œï¼ŒåŒæ™‚äº«å—è²¡å‹™è‡ªç”±ã€‚é©åˆå–œæ­¡ä¿æŒå·¥ä½œæ„Ÿä½†ä¸æƒ³å…¨è·çš„äººã€‚',
  coastFire:'ã€Coast FIREã€‘æµ·å²¸ FIREï¼Œå·²ç´¯ç©è¶³å¤ è³‡ç”¢ï¼Œæœªä¾†é è¤‡åˆ©å¢é•·å°±èƒ½åœ¨é€€ä¼‘å¹´é½¡é”æˆ FIREï¼Œç•¶ä¸‹åªéœ€è³ºå–ç”Ÿæ´»è²»å³å¯ã€‚ä¸å¿…å†ç‚ºé€€ä¼‘å„²è“„ï¼Œå¯é¸æ“‡å£“åŠ›è¼ƒå°çš„å·¥ä½œã€‚'
};

// ==========================================
// SECTION 2: EXPENSE CALCULATOR MODULE
// ==========================================
const ExpenseCalc = {
  // ç•¶å‰ç”¨æˆ¶æ‰€è™•çš„ç”Ÿæ´»ç‹€æ…‹
  currentState: 'family', // é è¨­è‚²å…’ä¸­
  
  // æƒ…å¢ƒè½‰æ›æ¯”ä¾‹ï¼ˆå¾ä¸€å€‹ç‹€æ…‹åˆ°å¦ä¸€å€‹ç‹€æ…‹ï¼‰
  stateTransitions: {
    single: { single: 1.0, couple: 1.2, family: 1.8, empty: 1.15, retire: 0.95 },
    couple: { single: 0.83, couple: 1.0, family: 1.5, empty: 0.96, retire: 0.8 },
    family: { single: 0.56, couple: 0.67, family: 1.0, empty: 0.64, retire: 0.53 },
    empty: { single: 0.87, couple: 1.04, family: 1.56, empty: 1.0, retire: 0.83 },
    retire: { single: 1.05, couple: 1.25, family: 1.89, empty: 1.2, retire: 1.0 }
  },
  
  // è¨­å®šç•¶å‰ç‹€æ…‹
  setCurrentState: function(state) {
    this.currentState = state;
    
    // æ›´æ–°æŒ‰éˆ•è¦–è¦ºç‹€æ…‹
    ['single', 'couple', 'family', 'empty', 'retire'].forEach(s => {
      const btn = document.getElementById(`state-${s}`);
      if (btn) {
        if (s === state) {
          btn.classList.add('primary');
        } else {
          btn.classList.remove('primary');
        }
      }
    });
    
    const stateNames = {
      single: 'å–®èº«',
      couple: 'å·²å©šï¼ˆé›™è–ªç„¡å°å­©ï¼‰',
      family: 'è‚²å…’ä¸­',
      empty: 'ç©ºå·¢æœŸï¼ˆå°å­©ç¨ç«‹ï¼‰',
      retire: 'é€€ä¼‘'
    };
    
    // æ¸…ç©ºé æ¸¬çµæœ
    const resultEl = document.getElementById('predictionResult');
    if (resultEl) resultEl.innerHTML = '';
  },
  
  // é æ¸¬å…¶ä»–æƒ…å¢ƒï¼ˆä¸æ”¹å‹•è¼¸å…¥æ¬„ä½ï¼‰
  predictScenario: function(targetState) {
    if (!this.currentState) {
      alert('âš ï¸ è«‹å…ˆåœ¨ä¸Šæ–¹é¸æ“‡æ‚¨ç›®å‰çš„ç”Ÿæ´»ç‹€æ…‹');
      return;
    }
    
    if (this.currentState === targetState) {
      alert('ğŸ’¡ é€™å°±æ˜¯æ‚¨ç•¶å‰çš„ç‹€æ…‹ï¼Œä¸‹æ–¹é¡¯ç¤ºçš„å°±æ˜¯ç•¶å‰æ”¯å‡ºã€‚');
      return;
    }
    
    // ç²å–ç•¶å‰è¼¸å…¥çš„æ”¯å‡º
    const current = this.getCurrentExpenses();
    const currentNeed = this.calculateNeedTotal(current);
    const currentWant = this.calculateWantTotal(current);
    const currentTotal = currentNeed + currentWant;
    
    if (currentTotal === 0) {
      alert('âš ï¸ è«‹å…ˆå¡«å…¥æ‚¨ç›®å‰çš„æ”¯å‡ºæ•¸æ“š');
      return;
    }
    
    // è¨ˆç®—è½‰æ›æ¯”ä¾‹
    const ratio = this.stateTransitions[this.currentState][targetState];
    
    // é æ¸¬æœªä¾†æ”¯å‡º
    const predictedTotal = Math.round(currentTotal * ratio);
    const predictedNeed = Math.round(currentNeed * ratio);
    const predictedWant = Math.round(currentWant * ratio);
    
    const stateNames = {
      single: 'å–®èº«',
      couple: 'å·²å©š',
      family: 'è‚²å…’ä¸­',
      empty: 'ç©ºå·¢æœŸ',
      retire: 'é€€ä¼‘'
    };
    
    const percentChange = ((ratio - 1) * 100).toFixed(0);
    const changeText = ratio > 1 
      ? `<span style="color:#f59e0b">+${percentChange}%</span>`
      : `<span style="color:#10b981">${percentChange}%</span>`;
    
    // é¡¯ç¤ºé æ¸¬çµæœ
    const resultEl = document.getElementById('predictionResult');
    if (resultEl) {
      resultEl.innerHTML = `
        <div style="margin-top:10px;padding:10px;background:rgba(15,23,42,0.6);border:1px solid var(--line);border-radius:8px">
          <div style="font-size:11px;color:var(--muted);margin-bottom:6px">
            å¾ã€Œ${stateNames[this.currentState]}ã€â†’ã€Œ${stateNames[targetState]}ã€é æ¸¬
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:11px">
            <div>
              <div style="color:var(--muted)">å¿…è¦æ”¯å‡º</div>
              <div style="font-weight:600;color:var(--need)">NT$ ${fmt(predictedNeed)}</div>
            </div>
            <div>
              <div style="color:var(--muted)">æƒ³è¦æ”¯å‡º</div>
              <div style="font-weight:600;color:var(--want)">NT$ ${fmt(predictedWant)}</div>
            </div>
            <div>
              <div style="color:var(--muted)">ç¸½æ”¯å‡º ${changeText}</div>
              <div style="font-weight:600">NT$ ${fmt(predictedTotal)}</div>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;gap:6px">
            <button onclick="ExpenseCalc.applyPrediction(${predictedNeed}, ${predictedWant})" style="flex:1;font-size:10px;padding:6px;background:#10b981;border-color:#059669">
              å¥—ç”¨åˆ°ç†æƒ³ç”Ÿæ´»è²»
            </button>
            <button onclick="ExpenseCalc.applyPredictionToSurvival(${predictedNeed})" style="flex:1;font-size:10px;padding:6px">
              å¥—ç”¨å¿…è¦æ”¯å‡º
            </button>
          </div>
        </div>
      `;
    }
  },
  
  // å¥—ç”¨é æ¸¬çµæœåˆ°ç†æƒ³ç”Ÿæ´»è²»
  applyPrediction: function(need, want) {
    const total = need + want;
    $('#lifestyle').value = Math.round(total);
    run();
    alert(`âœ“ å·²å¥—ç”¨é æ¸¬çµæœï¼\nç†æƒ³ç”Ÿæ´»è²»å·²æ›´æ–°ç‚º NT$ ${fmt(total)}`);
  },
  
  // å¥—ç”¨é æ¸¬å¿…è¦æ”¯å‡ºåˆ°åŸºæœ¬ç”Ÿæ´»è²»
  applyPredictionToSurvival: function(need) {
    $('#survival').value = Math.round(need);
    run();
    alert(`âœ“ å·²å¥—ç”¨é æ¸¬å¿…è¦æ”¯å‡ºï¼\nåŸºæœ¬ç”Ÿæ´»è²»å·²æ›´æ–°ç‚º NT$ ${fmt(need)}`);
  },
  
  // ç²å–ç•¶å‰æ‰€æœ‰æ”¯å‡ºé …ç›®
  getCurrentExpenses: function() {
    const expenses = {};
    const allIds = [
      'exp_rent', 'exp_management', 'exp_utilities', 'exp_groceries',
      'exp_transport', 'exp_fuel', 'exp_health', 'exp_insurance', 'exp_loan',
      'exp_dining', 'exp_travel', 'exp_entertainment', 'exp_clothing',
      'exp_hobbies', 'exp_streaming', 'exp_subscriptions'
    ];
    
    allIds.forEach(id => {
      expenses[id] = parseFloat(document.getElementById(id)?.value || 0);
    });
    
    return expenses;
  },
  
  // è¨ˆç®—å¿…è¦æ”¯å‡ºç¸½å’Œ
  calculateNeedTotal: function(expenses) {
    const needItems = [
      'exp_rent', 'exp_management', 'exp_utilities', 'exp_groceries',
      'exp_transport', 'exp_fuel', 'exp_health', 'exp_insurance', 'exp_loan'
    ];
    return needItems.reduce((sum, id) => sum + (expenses[id] || 0), 0);
  },
  
  // è¨ˆç®—æƒ³è¦æ”¯å‡ºç¸½å’Œ
  calculateWantTotal: function(expenses) {
    const wantItems = [
      'exp_dining', 'exp_travel', 'exp_entertainment', 'exp_clothing',
      'exp_hobbies', 'exp_streaming', 'exp_subscriptions'
    ];
    return wantItems.reduce((sum, id) => sum + (expenses[id] || 0), 0);
  },
  
  // åˆ‡æ›åˆ†é¡å±•é–‹/æ”¶åˆ
  toggleCategory: function(header) {
    const category = header.parentElement;
    category.classList.toggle('open');
  },
  
  // è¨ˆç®—æ”¯å‡º
  calculate: function() {
    const expenses = this.getCurrentExpenses();
    const needTotal = this.calculateNeedTotal(expenses);
    const wantTotal = this.calculateWantTotal(expenses);
    const total = needTotal + wantTotal;
    
    $('#needTotal').textContent = `NT$ ${fmt(needTotal)}`;
    $('#wantTotal').textContent = `NT$ ${fmt(wantTotal)}`;
    $('#summaryNeed').textContent = `NT$ ${fmt(needTotal)}`;
    $('#summaryWant').textContent = `NT$ ${fmt(wantTotal)}`;
    $('#summaryTotal').textContent = `NT$ ${fmt(total)}`;
    
    const needPercent = total > 0 ? (needTotal / total * 100) : 0;
    const wantPercent = total > 0 ? (wantTotal / total * 100) : 0;
    
    $('#needPercent').textContent = `${needPercent.toFixed(1)}%`;
    $('#wantPercent').textContent = `${wantPercent.toFixed(1)}%`;
    $('#needBar').style.width = `${needPercent}%`;
    $('#wantBar').style.width = `${wantPercent}%`;
    
    this.showAdvice(needPercent, wantPercent, total);
    
    return { needTotal, wantTotal, total };
  },
  
  // æ™ºèƒ½å»ºè­°
  showAdvice: function(needPercent, wantPercent, total) {
    const advice = $('#expenseAdvice');
    let html = '';
    
    if (needPercent > 60) {
      html += `
        <div class="suggestion-card warning">
          <h4>âš ï¸ å¿…è¦æ”¯å‡ºæ¯”ä¾‹åé«˜</h4>
          <p>æ‚¨çš„å¿…è¦æ”¯å‡ºä½”ç¸½æ”¯å‡º ${needPercent.toFixed(1)}%ï¼Œå»ºè­°æ§åˆ¶åœ¨ 50-60% ä»¥å…§ã€‚å¯è€ƒæ…®ï¼š</p>
          <ul>
            <li>å°‹æ‰¾æ›´ç¶“æ¿Ÿçš„å±…ä½é¸æ“‡</li>
            <li>å„ªåŒ–äº¤é€šæˆæœ¬ï¼ˆå…±ä¹˜ã€å¤§çœ¾é‹è¼¸ï¼‰</li>
            <li>æª¢è¦–ä¿éšªæ˜¯å¦æœ‰é‡è¤‡æˆ–éåº¦æŠ•ä¿</li>
          </ul>
        </div>
      `;
    }
    
    if (wantPercent > 40) {
      html += `
        <div class="suggestion-card warning">
          <h4>ğŸ’¸ æƒ³è¦æ”¯å‡ºæ¯”ä¾‹è¼ƒé«˜</h4>
          <p>æ‚¨çš„æƒ³è¦æ”¯å‡ºä½”ç¸½æ”¯å‡º ${wantPercent.toFixed(1)}%ï¼Œå»ºè­°æ§åˆ¶åœ¨ 30% å·¦å³ã€‚å¯è€ƒæ…®ï¼š</p>
          <ul>
            <li>æ¸›å°‘å¤–é£Ÿé »ç‡ï¼Œå¢åŠ åœ¨å®¶æ–™ç†</li>
            <li>æª¢è¦–è¨‚é–±æœå‹™æ˜¯å¦çœŸçš„éƒ½æœ‰åœ¨ä½¿ç”¨</li>
            <li>è¨­å®šæ¯æœˆå¨›æ¨‚é ç®—ä¸Šé™</li>
          </ul>
        </div>
      `;
    }
    
    if (needPercent <= 60 && wantPercent <= 40) {
      html += `
        <div class="suggestion-card success">
          <h4>âœ… æ”¯å‡ºçµæ§‹å¥åº·</h4>
          <p>æ‚¨çš„æ”¯å‡ºåˆ†é…ç¬¦åˆ 50/30/20 æ³•å‰‡ï¼ç¹¼çºŒä¿æŒï¼Œä¸¦å°‡çœä¸‹çš„éŒ¢ç”¨æ–¼å„²è“„å’ŒæŠ•è³‡ã€‚</p>
        </div>
      `;
    }
    
    advice.innerHTML = html;
  },
  
  // å¥—ç”¨åˆ°ç†æƒ³ç”Ÿæ´»è²»
  applyToLifestyle: function() {
    const { total } = this.calculate();
    $('#lifestyle').value = Math.round(total);
    run();
    alert(`âœ“ å·²å¥—ç”¨ï¼ç†æƒ³ç”Ÿæ´»è²»å·²æ›´æ–°ç‚º NT$ ${fmt(total)}`);
  },
  
  // åƒ…å¥—ç”¨å¿…è¦æ”¯å‡ºåˆ°åŸºæœ¬ç”Ÿæ´»è²»
  applyToSurvival: function() {
    const { needTotal } = this.calculate();
    $('#survival').value = Math.round(needTotal);
    run();
    alert(`âœ“ å·²å¥—ç”¨ï¼åŸºæœ¬ç”Ÿæ´»è²»å·²æ›´æ–°ç‚º NT$ ${fmt(needTotal)}`);
  }
};

// ==========================================
// SECTION 3: SIMULATION ENGINE
// ==========================================
function simulate(){
  const p={
    assets:+$('#assets').value||0,
    totalIncome:+$('#totalIncome').value||0,
    survival:+$('#survival').value||0,
    lifestyle:+$('#lifestyle').value||0,
    returnRate:(+$('#returnRate').value||0)/100,
    years:+$('#years').value||30,
    mainIncome:+$('#mainIncome').value||0,
    sideIncome:+$('#sideIncome').value||0,
    mainGrowth:(+$('#mainGrowth').value||0)/100,
    sideGrowth:(+$('#sideGrowth').value||0)/100,
    inflation:(+$('#inflation').value||0)/100,
    expenseGrowth:(+$('#expenseGrowth').value||0)/100,
    fat:+$('#fat').value||1.8
  };
  
  const N=p.years*12;
  const mr=p.returnRate/12;
  
  // å°‡å¹´æˆé•·ç‡è½‰æ›ç‚ºæœˆæˆé•·ç‡ï¼Œå¯¦ç¾å¹³æ»‘æ›²ç·š
  const mainMonthlyGrowth=Math.pow(1+p.mainGrowth,1/12)-1;
  const sideMonthlyGrowth=Math.pow(1+p.sideGrowth,1/12)-1;
  
  const main=[], side=[], total=[];
  const A_surv=[], A_mid=[], A_life=[];
  
  let currMain=p.mainIncome||p.totalIncome*0.8;
  let currSide=p.sideIncome||p.totalIncome*0.2;
  let asset_surv=p.assets, asset_mid=p.assets, asset_life=p.assets;
  
  for(let i=0;i<N;i++){
    // æ¯æœˆå¹³æ»‘å¢é•·ï¼Œé¿å…éšæ¢¯æ•ˆæœ
    if(i>0){
      currMain*=(1+mainMonthlyGrowth);
      currSide*=(1+sideMonthlyGrowth);
    }
    
    const m=currMain, s=currSide, t=m+s;
    main.push(m); side.push(s); total.push(t);
    
    const midExpense=(p.survival+p.lifestyle)/2;
    asset_surv=asset_surv*(1+mr)+(t-p.survival);
    asset_mid=asset_mid*(1+mr)+(t-midExpense);
    asset_life=asset_life*(1+mr)+(t-p.lifestyle);
    
    A_surv.push(asset_surv);
    A_mid.push(asset_mid);
    A_life.push(asset_life);
  }
  
  const survivalTarget=p.survival*12/0.04;
  const lifestyleTarget=p.lifestyle*12/0.04;
  // å·¥ä½œè‡ªç”±ï¼šå‰¯æ¥­æ”¶å…¥èƒ½æ”¯ä»˜ç†æƒ³ç”Ÿæ´»è²»æ™‚ï¼Œå¯ä»¥è‡ªç”±é¸æ“‡æ˜¯å¦ç¹¼çºŒä¸»æ¥­
  // éœ€è¦çš„è³‡ç”¢ = (ç†æƒ³ç”Ÿæ´»è²» - å‰¯æ¥­æ”¶å…¥) Ã— 25å€
  const workFreeGap=Math.max(0,p.lifestyle-(p.sideIncome||p.totalIncome*0.2));
  const workFreeTarget=workFreeGap*12/0.04;
  const fireTarget=lifestyleTarget;
  const fatTarget=p.lifestyle*p.fat*12/0.04;
  
  return {p,N,main,side,total,A_surv,A_mid,A_life,
    survivalTarget,lifestyleTarget,workFreeTarget,fireTarget,fatTarget};
}

// ==========================================
// SECTION 4: RENDER FUNCTIONS
// ==========================================
function renderKPI(S){
  const findYear=(arr,target)=>{
    // å¦‚æœç›®æ¨™ç‚º0ï¼Œè¡¨ç¤ºå·²é”æˆï¼ˆå‰¯æ¥­æ”¶å…¥å·²è¶³å¤ ï¼‰
    if(target<=0) return 0;
    // å¦‚æœç•¶å‰è³‡ç”¢å·²ç¶“é”æˆç›®æ¨™
    if(arr[0]>=target) return 0;
    const idx=arr.findIndex(v=>v>=target);
    return idx===-1?-1:Math.floor(idx/12);
  };
  
  const ySurv=findYear(S.A_surv,S.survivalTarget);
  const yLife=findYear(S.A_life,S.lifestyleTarget);
  const yWork=findYear(S.A_mid,S.workFreeTarget);
  const yFire=findYear(S.A_life,S.fireTarget);
  const yFat=findYear(S.A_life,S.fatTarget);
  
  const makeCard=(title,target,years,ok,helpKey,isWorkFree=false)=>{
    // å·¥ä½œè‡ªç”±ç‰¹æ®Šè™•ç†ï¼šç›®æ¨™ç‚º0è¡¨ç¤ºå‰¯æ¥­æ”¶å…¥å·²è¶³å¤ 
    if(isWorkFree && target===0){
      return `
        <div class="k ok">
          <h3>${title}<span class="help-icon" data-help="${helpKey}">?</span></h3>
          <p>ç›®æ¨™è³‡ç”¢ï¼š<strong>NT$ 0</strong></p>
          <p>ç‹€æ…‹ï¼š<strong>âœ… å·²é”æˆï¼å‰¯æ¥­æ”¶å…¥å·²è¶³å¤ æ”¯ä»˜ç†æƒ³ç”Ÿæ´»è²»</strong></p>
        </div>
      `;
    }
    
    // 0å¹´è¡¨ç¤ºç•¶å‰è³‡ç”¢å·²é”æˆ
    if(years===0){
      return `
        <div class="k ok">
          <h3>${title}<span class="help-icon" data-help="${helpKey}">?</span></h3>
          <p>ç›®æ¨™è³‡ç”¢ï¼š<strong>${fmt(target)}</strong></p>
          <p>ç‹€æ…‹ï¼š<strong>âœ… å·²é”æˆï¼</strong></p>
        </div>
      `;
    }
    
    return `
      <div class="k ${ok?'ok':'warn'}">
        <h3>${title}<span class="help-icon" data-help="${helpKey}">?</span></h3>
        <p>ç›®æ¨™è³‡ç”¢ï¼š<strong>${fmt(target)}</strong></p>
        <p>é è¨ˆæ™‚é–“ï¼š<strong>${years===-1?'è¶…éæ¨¡æ“¬å¹´æ•¸':`${years}å¹´å¾Œé”æˆ`}</strong></p>
      </div>
    `;
  };
  
  $('#kpi').innerHTML=[
    makeCard('ç”Ÿå­˜è‡ªç”±',S.survivalTarget,ySurv,ySurv!==-1 && ySurv<=10,'survivalFreedom'),
    makeCard('ç”Ÿæ´»è‡ªç”±',S.lifestyleTarget,yLife,yLife!==-1 && yLife<=20,'lifestyleFreedom'),
    makeCard('å·¥ä½œè‡ªç”±',S.workFreeTarget,yWork,yWork!==-1 && yWork<=15,'workFreedom',true),
    makeCard('FIRE',S.fireTarget,yFire,yFire!==-1 && yFire<=25,'fire'),
    makeCard('FAT FIRE',S.fatTarget,yFat,yFat!==-1 && yFat<=30,'fatFire')
  ].join('');
}

function renderSummary(S){
  const finalAsset=S.A_life[S.A_life.length-1];
  const canFire=finalAsset>=S.fireTarget;
  const canFat=finalAsset>=S.fatTarget;
  
  let emoji='ğŸ¯', text='', level='';
  if(canFat){
    emoji='ğŸ‰'; text='æ­å–œï¼æ‚¨æœ‰æ©Ÿæœƒé”æˆ FAT FIREï¼Œäº«å—å¯Œè£•é€€ä¼‘ç”Ÿæ´»ï¼';
    level='FAT FIRE';
  }else if(canFire){
    emoji='ğŸ”¥'; text='å¤ªå¥½äº†ï¼æ‚¨æœ‰æ©Ÿæœƒé”æˆ FIREï¼Œå¯¦ç¾è²¡å‹™è‡ªç”±ï¼';
    level='FIRE';
  }else{
    emoji='ğŸ’ª'; text='ç¹¼çºŒåŠªåŠ›ï¼èª¿æ•´ç­–ç•¥å¯åŠ é€Ÿé”æˆç›®æ¨™ã€‚';
    level='åŠªåŠ›ä¸­';
  }
  
  $('#summaryCard').innerHTML=`
    <div class="summary-card">
      <div class="main-result">
        <span class="emoji">${emoji}</span>
        ${text}
      </div>
      <div class="sub-text">
        ${S.p.years}å¹´å¾Œé ä¼°è³‡ç”¢ï¼š<strong>${fmt(finalAsset)}</strong> | 
        ç›®æ¨™ç­‰ç´šï¼š<strong>${level}</strong>
      </div>
    </div>
  `;
}

function renderTimeline(S){
  const findYear=(arr,target)=>{
    const idx=arr.findIndex(v=>v>=target);
    return idx===-1?-1:Math.floor(idx/12);
  };
  
  const milestones=[
    {label:'ç”Ÿå­˜è‡ªç”±',year:findYear(S.A_surv,S.survivalTarget)},
    {label:'ç”Ÿæ´»è‡ªç”±',year:findYear(S.A_life,S.lifestyleTarget)},
    {label:'å·¥ä½œè‡ªç”±',year:findYear(S.A_mid,S.workFreeTarget)},
    {label:'FIRE',year:findYear(S.A_life,S.fireTarget)},
    {label:'FAT FIRE',year:findYear(S.A_life,S.fatTarget)}
  ];
  
  const html=milestones.map((m,i)=>{
    const achieved=m.year!==-1 && m.year===0;
    const current=m.year!==-1 && m.year>0 && m.year<=S.p.years;
    const future=m.year===-1 || m.year>S.p.years;
    
    return`
      <div class="timeline-point ${achieved?'achieved':current?'current':''}">
        <div class="dot"></div>
        <div class="label">${m.label}</div>
        <div class="year">${m.year===-1?'â€”':`${m.year}å¹´`}</div>
      </div>
    `;
  }).join('');
  
  $('#timeline').innerHTML=`
    <div class="timeline">
      <div class="timeline-track"></div>
      <div class="timeline-points">${html}</div>
    </div>
  `;
}

function renderSuggestions(S){
  const suggestions=[];
  const savingsRate=S.p.totalIncome>0?(S.p.totalIncome-S.p.lifestyle)/S.p.totalIncome*100:0;
  
  if(savingsRate<20){
    suggestions.push({
      type:'warning',
      icon:'ğŸ’¡',
      title:'å»ºè­°æé«˜å„²è“„ç‡',
      content:`ç›®å‰å„²è“„ç‡ç´„ ${savingsRate.toFixed(1)}%ï¼Œå»ºè­°æå‡è‡³ 20% ä»¥ä¸Šå¯åŠ é€Ÿé”æˆç›®æ¨™ã€‚`
    });
  }else if(savingsRate>=50){
    suggestions.push({
      type:'success',
      icon:'ğŸŒŸ',
      title:'å„ªç§€çš„å„²è“„ç‡',
      content:`æ‚¨çš„å„²è“„ç‡é” ${savingsRate.toFixed(1)}%ï¼Œéå¸¸æ£’ï¼ç¹¼çºŒä¿æŒé€™å€‹ç¿’æ…£ã€‚`
    });
  }
  
  const expenseRatio=S.p.totalIncome>0?S.p.lifestyle/S.p.totalIncome:0;
  if(expenseRatio>0.7){
    suggestions.push({
      type:'warning',
      icon:'âš ï¸',
      title:'ç”Ÿæ´»è²»ä½”æ¯”åé«˜',
      content:'ç†æƒ³ç”Ÿæ´»è²»ä½”æ”¶å…¥ 70% ä»¥ä¸Šï¼Œå»ºè­°ä½¿ç”¨ã€Œæ”¯å‡ºè©³ç´°è¦åŠƒã€åŠŸèƒ½æª¢è¦–å„é …æ”¯å‡ºã€‚'
    });
  }
  
  if(S.p.returnRate<0.05){
    suggestions.push({
      type:'info',
      icon:'ğŸ“ˆ',
      title:'è€ƒæ…®æé«˜æŠ•è³‡å ±é…¬',
      content:'ç›®å‰è¨­å®šçš„å ±é…¬ç‡è¼ƒä½ï¼Œå¯è€ƒæ…®å­¸ç¿’æŠ•è³‡æˆ–å°‹æ±‚å°ˆæ¥­ç†è²¡å»ºè­°ã€‚'
    });
  }
  
  // åŠ å…¥ FIRE é¡å‹è£œå……è³‡è¨Š
  suggestions.push({
    type:'info',
    icon:'ğŸ”¥',
    title:'èªè­˜ä¸åŒé¡å‹çš„ FIRE',
    content:`
      <div style="margin-top:8px;font-size:11px;line-height:1.6">
        <div style="margin-bottom:6px"><strong>Lean FIREï¼š</strong>ç²¾ç°¡é€€ä¼‘ï¼Œä»¥åŸºæœ¬ç”Ÿæ´»è²»æå‰é€€ä¼‘</div>
        <div style="margin-bottom:6px"><strong>FIREï¼š</strong>æ¨™æº–è²¡å‹™è‡ªç”±ï¼Œè¢«å‹•æ”¶å…¥ â‰¥ ç†æƒ³ç”Ÿæ´»è²»</div>
        <div style="margin-bottom:6px"><strong>FAT FIREï¼š</strong>å¯Œè£•é€€ä¼‘ï¼Œ1.5-2å€ç†æƒ³ç”Ÿæ´»è²»</div>
        <div style="margin-bottom:6px"><strong>Barista FIREï¼š</strong>åŠé€€ä¼‘ + è¼•é¬†å…¼è·</div>
        <div><strong>Coast FIREï¼š</strong>è³‡ç”¢å·²è¶³å¤ ï¼Œåªéœ€è³ºå–ç•¶å‰ç”Ÿæ´»è²»</div>
      </div>
    `
  });
  
  const html=suggestions.map(s=>`
    <div class="suggestion-card ${s.type}">
      <h4>${s.icon} ${s.title}</h4>
      <p>${s.content}</p>
    </div>
  `).join('');
  
  $('#suggestions').innerHTML=html?`<div class="suggestions">${html}</div>`:'';
}

// ==========================================
// SECTION 5: CHART RENDERING
// ==========================================
const tooltipDataMap=new Map();

function drawChart(canvas,tooltipEl,series,opts={}){
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const rect=canvas.getBoundingClientRect();
  const baseWidth=rect.width, baseHeight=rect.height;
  
  canvas.width=baseWidth*dpr;
  canvas.height=baseHeight*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  
  const isMobile=baseWidth<500;
  const yearsTotal=opts.years||30;
  const N=series[0].data.length;
  
  const pad={t:isMobile?35:40,r:isMobile?15:20,b:isMobile?40:45,l:isMobile?50:60};
  const plot={
    x:pad.l,
    y:pad.t,
    w:baseWidth-pad.l-pad.r,
    h:baseHeight-pad.t-pad.b
  };
  
  const allVals=series.flatMap(s=>s.data);
  let yMax=Math.max(...allVals);
  if(opts.extraMax) yMax=Math.max(yMax,...opts.extraMax);
  
  const xPos=i=>plot.x+(plot.w/(N-1))*i;
  const yPos=v=>plot.y+plot.h-(v/yMax)*plot.h;
  
  ctx.fillStyle='#0f172a';
  ctx.fillRect(0,0,baseWidth,baseHeight);
  
  ctx.strokeStyle='#1f2937';
  ctx.lineWidth=1;
  for(let i=0;i<=5;i++){
    const y=plot.y+(plot.h/5)*i;
    ctx.beginPath();
    ctx.moveTo(plot.x,y);
    ctx.lineTo(plot.x+plot.w,y);
    ctx.stroke();
  }
  
  if(opts.hLines){
    opts.hLines.forEach(hl=>{
      const y=yPos(hl.y);
      if(y>=plot.y && y<=plot.y+plot.h){
        ctx.save();
        ctx.strokeStyle=hl.color||'#fff';
        ctx.lineWidth=2;
        ctx.setLineDash([6,6]);
        ctx.beginPath();
        ctx.moveTo(plot.x,y);
        ctx.lineTo(plot.x+plot.w,y);
        ctx.stroke();
        ctx.restore();
        
        ctx.fillStyle=hl.color||'#fff';
        ctx.font='11px sans-serif';
        ctx.textAlign='right';
        ctx.fillText(hl.label,plot.x+plot.w-5,y-5);
      }
    });
  }
  
  series.forEach(s=>{
    ctx.save();
    ctx.strokeStyle=s.color;
    ctx.lineWidth=s.w||2;
    if(s.dash) ctx.setLineDash(s.dash);
    ctx.beginPath();
    s.data.forEach((v,i)=>{
      const x=xPos(i), y=yPos(v);
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();
    ctx.restore();
  });
  
  ctx.fillStyle='#9ca3af';
  ctx.font=isMobile?'10px sans-serif':'11px sans-serif';
  ctx.textAlign='center';
  for(let y=0;y<=yearsTotal;y+=isMobile?10:5){
    const x=xPos((y/yearsTotal)*N);
    ctx.fillText(y+'å¹´',x,plot.y+plot.h+20);
  }
  
  ctx.textAlign='right';
  for(let i=0;i<=5;i++){
    const val=(yMax/5)*(5-i);
    const y=plot.y+(plot.h/5)*i;
    ctx.fillText(fmt(val),plot.x-8,y+4);
  }
  
  ctx.save();
  ctx.fillStyle='#cbd5e1';
  ctx.font=isMobile?'10px sans-serif':'11px sans-serif';
  ctx.textAlign='left';
  const legendSpacing=isMobile?8:12;
  const legendItemSpacing=4;
  const legendLineHeight=16;
  let lx=plot.x, ly=isMobile?15:20;
  
  series.forEach((s,idx)=>{
    const text=s.name;
    const textWidth=ctx.measureText(text).width;
    const itemWidth=14+legendItemSpacing+textWidth+12;
    
    if(isMobile && idx>0 && lx+itemWidth>plot.x+plot.w){
      lx=plot.x;
      ly+=legendLineHeight;
    }
    
    ctx.fillStyle=s.color;
    ctx.fillRect(lx,ly+3,12,2);
    ctx.fillStyle='#cbd5e1';
    ctx.fillText(text,lx+14+legendItemSpacing,ly);
    
    lx+=itemWidth;
  });
  ctx.restore();
  
  tooltipDataMap.set(canvas,{
    canvas:canvas,
    tooltip:tooltipEl,
    data:{series,plot,xPos,yPos,N,yearsTotal,yMax,baseWidth,baseHeight}
  });
}

function setupTooltip(canvas,tooltipEl){
  function handleMove(e){
    const tooltipData=tooltipDataMap.get(canvas);
    if(!tooltipData || !tooltipData.data) return;
    
    const rect=canvas.getBoundingClientRect();
    const clientX=e.clientX||(e.touches && e.touches[0]?e.touches[0].clientX:0);
    const clientY=e.clientY||(e.touches && e.touches[0]?e.touches[0].clientY:0);
    
    const x=clientX-rect.left;
    const y=clientY-rect.top;
    const {series,plot,xPos,N}=tooltipData.data;
    
    if(x<plot.x || x>plot.x+plot.w || y<plot.y || y>plot.y+plot.h){
      tooltipEl.style.display='none';
      return;
    }
    
    let nearestIdx=0;
    let minDist=Infinity;
    for(let i=0;i<N;i++){
      const dist=Math.abs(xPos(i)-x);
      if(dist<minDist){
        minDist=dist;
        nearestIdx=i;
      }
    }
    
    const year=Math.floor(nearestIdx/12);
    let html=`<div class="tooltip-row"><span class="tooltip-label">å¹´ä»½ï¼š</span>${year}å¹´</div>`;
    series.forEach(s=>{
      html+=`<div class="tooltip-row"><span class="tooltip-label" style="color:${s.color}">${s.name}ï¼š</span>${fmt(s.data[nearestIdx])}</div>`;
    });
    
    tooltipEl.innerHTML=html;
    tooltipEl.style.display='block';
    
    let tooltipX=clientX+15;
    let tooltipY=clientY-10;
    
    const tooltipRect=tooltipEl.getBoundingClientRect();
    if(tooltipX+tooltipRect.width>window.innerWidth){
      tooltipX=clientX-tooltipRect.width-15;
    }
    if(tooltipY+tooltipRect.height>window.innerHeight){
      tooltipY=clientY-tooltipRect.height-10;
    }
    if(tooltipY<0) tooltipY=clientY+20;
    
    tooltipEl.style.left=tooltipX+'px';
    tooltipEl.style.top=tooltipY+'px';
  }
  
  function handleLeave(){
    tooltipEl.style.display='none';
  }
  
  canvas.addEventListener('mousemove',handleMove);
  canvas.addEventListener('touchmove',handleMove,{passive:true});
  canvas.addEventListener('mouseleave',handleLeave);
  canvas.addEventListener('touchend',handleLeave);
  canvas.addEventListener('touchcancel',handleLeave);
}

// ==========================================
// SECTION 6: MAIN EXECUTION
// ==========================================
function run(){
  const S=simulate();
  
  renderSummary(S);
  renderTimeline(S);
  renderSuggestions(S);
  renderKPI(S);
  
  const cashSeries=[
    {name:'ä¸»æ¥­æ”¶å…¥',color:C.blue,data:S.main},
    {name:'å‰¯æ¥­æ”¶å…¥',color:C.teal,data:S.side},
    {name:'ç¸½æ”¶å…¥',color:C.orange,data:S.total},
    {name:'ç”Ÿå­˜æ”¯å‡º',color:C.sur,data:Array(S.N).fill(S.p.survival),dash:[6,6],w:1.5},
    {name:'ç”Ÿæ´»æ”¯å‡º',color:C.life,data:Array(S.N).fill(S.p.lifestyle),dash:[6,6],w:1.5},
  ];
  drawChart($('#cvCash'),$('#tooltipCash'),cashSeries,{years:S.p.years});
  
  const assetSeries=[
    {name:'è³‡ç”¢ï¼ˆç”Ÿå­˜æ”¯å‡ºè·¯å¾‘ï¼‰',color:C.green,data:S.A_surv},
    {name:'è³‡ç”¢ï¼ˆä¸­é–“æ”¯å‡ºè·¯å¾‘ï¼‰',color:'#7aa2ff',data:S.A_mid},
    {name:'è³‡ç”¢ï¼ˆç”Ÿæ´»æ”¯å‡ºè·¯å¾‘ï¼‰',color:C.blue,data:S.A_life},
  ];
  drawChart($('#cvAsset'),$('#tooltipAsset'),assetSeries,{
    years:S.p.years,
    extraMax:[S.fireTarget,S.fatTarget],
    hLines:[
      {y:S.fireTarget,label:'FIRE',color:C.fire},
      {y:S.fatTarget,label:'FAT FIRE',color:C.fat}
    ]
  });
  
  // é‡æ–°ç¶å®šå‹•æ…‹ç”Ÿæˆçš„å¹«åŠ©åœ–æ¨™
  setupHelpIcons();
}

// ==========================================
// SECTION 7: UI INTERACTIONS
// ==========================================
function savePNG(){
  const c1=$('#cvCash'),c2=$('#cvAsset');
  const out=document.createElement('canvas');
  const W=Math.max(c1.width,c2.width)/(window.devicePixelRatio||1);
  const H=(c1.height+c2.height)/(window.devicePixelRatio||1)+60;
  out.width=W*(window.devicePixelRatio||1);
  out.height=H*(window.devicePixelRatio||1);
  const ctx=out.getContext('2d');
  ctx.setTransform(window.devicePixelRatio||1,0,0,window.devicePixelRatio||1,0,0);
  ctx.fillStyle=getComputedStyle(document.body).backgroundColor||'#0f172a';
  ctx.fillRect(0,0,W,H);
  ctx.drawImage(c1,0,0,c1.width/(window.devicePixelRatio||1),c1.height/(window.devicePixelRatio||1));
  ctx.drawImage(c2,0,c1.height/(window.devicePixelRatio||1)+60,c2.width/(window.devicePixelRatio||1),c2.height/(window.devicePixelRatio||1));
  const a=document.createElement('a');
  a.download='fire_result.png';
  a.href=out.toDataURL('image/png');
  a.click();
}

function shareLink(){
  const params=new URLSearchParams();
  Object.keys(defaults).forEach(k=>{
    const el=document.getElementById(k);
    if(el) params.set(k,el.value);
  });
  const url=window.location.origin+window.location.pathname+'?'+params.toString();
  
  if(navigator.clipboard){
    navigator.clipboard.writeText(url).then(()=>{
      alert('âœ“ åˆ†äº«é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
    });
  }else{
    prompt('è¤‡è£½æ­¤é€£çµåˆ†äº«ï¼š',url);
  }
}

function applyQuery(){
  const params=new URLSearchParams(window.location.search);
  params.forEach((val,key)=>{
    const el=document.getElementById(key);
    if(el) el.value=val;
  });
}

function setupHelpIcons(){
  $$('.help-icon').forEach(icon=>{
    const key=icon.dataset.help;
    const text=helpTexts[key]||'';
    
    icon.addEventListener('click',(e)=>{
      e.stopPropagation();
      const existing=$('.help-popup.show');
      if(existing) existing.classList.remove('show');
      
      let popup=icon.nextElementSibling;
      if(!popup || !popup.classList.contains('help-popup')){
        popup=document.createElement('div');
        popup.className='help-popup';
        popup.textContent=text;
        icon.parentElement.style.position='relative';
        icon.parentElement.appendChild(popup);
      }
      popup.classList.add('show');
      
      const closePopup=()=>{
        popup.classList.remove('show');
        document.removeEventListener('click',closePopup);
      };
      setTimeout(()=>document.addEventListener('click',closePopup),100);
    });
  });
}

function setupAccordion(){
  $$('.accordion-header').forEach(header=>{
    header.addEventListener('click',()=>{
      const item=header.parentElement;
      item.classList.toggle('open');
    });
  });
}

function setupRiskLevel(){
  const riskMap={
    conservative:{returnRate:4,fat:1.5},
    moderate:{returnRate:6,fat:1.8},
    aggressive:{returnRate:9,fat:2.2}
  };
  
  $('#riskLevel').addEventListener('change',(e)=>{
    const risk=riskMap[e.target.value];
    if(risk){
      $('#returnRate').value=risk.returnRate;
      $('#fat').value=risk.fat;
      run();
    }
  });
}

function setupIncomeSync(){
  const syncIncome=()=>{
    const main=parseFloat($('#mainIncome').value)||0;
    const side=parseFloat($('#sideIncome').value)||0;
    const total=main+side;
    if(total>0) $('#totalIncome').value=total;
  };
  
  $('#mainIncome').addEventListener('input',syncIncome);
  $('#sideIncome').addEventListener('input',syncIncome);
}

// ==========================================
// SECTION 8: INITIALIZATION
// ==========================================
$('#calc').addEventListener('click',run);
$('#fatfill').addEventListener('click',()=>{
  $('#fat').value=Math.round((+$('#lifestyle').value||0)*1.8);
  run();
});
$('#share').addEventListener('click',shareLink);
$('#savepng').addEventListener('click',savePNG);
$('#reset').addEventListener('click',()=>{
  for(const k in defaults){
    const el=document.getElementById(k);
    if(el) el.value=defaults[k];
  }
  run();
});

// æ‰“é–‹æ”¯å‡ºè¨ˆç®—å™¨æŒ‰éˆ•
$('#openExpenseCalc').addEventListener('click',()=>{
  const accordion=$('#expenseAccordion');
  if(!accordion.classList.contains('open')){
    accordion.classList.add('open');
    accordion.scrollIntoView({behavior:'smooth',block:'nearest'});
  }
});

let resizeTimer;
window.addEventListener('resize',()=>{
  clearTimeout(resizeTimer);
  resizeTimer=setTimeout(run,150);
},{passive:true});

setupTooltip($('#cvCash'),$('#tooltipCash'));
setupTooltip($('#cvAsset'),$('#tooltipAsset'));
setupHelpIcons();
setupAccordion();
setupRiskLevel();
setupIncomeSync();

// åˆå§‹åŒ–æ”¯å‡ºè¨ˆç®—å™¨
ExpenseCalc.calculate();

applyQuery();
run();
</script>
</body>
</html>
