<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è²¡å‹™è‡ªç”±è·¯å¾‘è©¦ç®—ï½œFIRE Playground</title>
<style>
  :root{
    --bg:#0f172a;--panel:#111827;--ink:#e5e7eb;--muted:#9ca3af;--line:#1f2937;
    --blue:#60a5fa;--teal:#22d3ee;--orange:#fb923c;--green:#34d399;--asset:#cbd5e1;
    --sur:#8b5cf6;--life:#a78bfa;--fire:#ef4444;--fat:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC;line-height:1.5}
  header{padding:16px 12px 8px;border-bottom:1px solid var(--line)}
  header h1{margin:0 0 6px 0;font-size:20px;text-align:center}
  header p{margin:0;color:var(--muted);font-size:12px;text-align:center}
  main{max-width:1200px;margin:0 auto;padding:12px;display:grid;gap:12px;grid-template-columns:360px 1fr}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .panel h2{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);font-size:14px;color:#cbd5e1}
  .grid{display:grid;grid-template-columns:1fr;gap:8px;padding:10px}
  .row{display:grid;grid-template-columns:1.2fr 1fr;gap:8px;align-items:center}
  label{font-size:12px;color:var(--muted)}
  input[type="number"],select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #2b3443;background:#0b1220;color:var(--ink)}
  .actions{display:flex;gap:8px;flex-wrap:wrap;padding:0 10px 10px}
  button{cursor:pointer;border:1px solid var(--line);background:#0b1220;color:#e5e7eb;padding:8px 12px;border-radius:10px}
  button.primary{background:#0ea5e9;border-color:#0284c7}
  .kpi{display:grid;grid-template-columns:1fr;gap:8px;padding:10px}
  .k{border:1px dashed #334155;border-radius:10px;padding:10px}
  .k.ok{border-color:#14532d;background:rgba(34,197,94,0.08)}
  .k.warn{border-color:#7f1d1d;background:rgba(239,68,68,0.06)}
  .k h3{margin:0 0 6px 0;font-size:13px}
  .k p{margin:2px 0;font-size:12px;color:#cbd5e1}
  .charts{display:grid;grid-template-columns:1fr;gap:12px;padding:10px}
  .chartbox{border:1px solid var(--line);border-radius:12px;padding:10px;position:relative}
  .chartbox h3{margin:0 0 6px 0;font-size:13px;color:#cbd5e1}
  .chart-wrapper{position:relative;width:100%;overflow:hidden}
  canvas{display:block;width:100%;height:380px;touch-action:pan-y}
  footer{max-width:1200px;margin:8px auto 20px;color:#9ca3af;text-align:center;font-size:12px}
  .back-home{text-align:center;margin:20px auto;max-width:1200px}
  .back-home a{display:inline-block;padding:12px 24px;background:#0ea5e9;color:white;text-decoration:none;border-radius:10px;font-size:14px;border:1px solid #0284c7}
  .back-home a:hover{background:#0284c7}
  .tooltip{position:fixed;background:rgba(17,24,39,0.95);border:1px solid var(--line);border-radius:8px;padding:8px 12px;font-size:11px;pointer-events:none;display:none;z-index:1000;color:var(--ink);white-space:nowrap;max-width:90vw}
  .tooltip-row{margin:2px 0}
  .tooltip-label{color:var(--muted);margin-right:8px}
  @media(max-width:900px){ 
    main{grid-template-columns:1fr}
    canvas{height:320px}
    .chartbox{padding:8px}
    .chartbox h3{font-size:12px}
    header h1{font-size:18px}
    header p{font-size:11px}
  }
  
  /* æ–°å¢ï¼šæ‰‹é¢¨ç´å¼æŠ˜ç–Šå€å¡Š */
  .accordion{margin-top:12px}
  .accordion-item{border:1px solid var(--line);border-radius:10px;margin-bottom:8px;overflow:hidden}
  .accordion-header{padding:10px 12px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;background:rgba(15,23,42,0.5);transition:background 0.2s}
  .accordion-header:hover{background:rgba(15,23,42,0.8)}
  .accordion-header h3{margin:0;font-size:13px;display:flex;align-items:center;gap:6px}
  .accordion-icon{font-size:12px;transition:transform 0.2s}
  .accordion-item.open .accordion-icon{transform:rotate(90deg)}
  .accordion-content{max-height:0;overflow:hidden;transition:max-height 0.3s ease-out}
  .accordion-item.open .accordion-content{max-height:2000px;transition:max-height 0.5s ease-in}
  .accordion-body{padding:10px}
  
  /* æ–°å¢ï¼šæ™ºèƒ½å»ºè­°å¡ç‰‡ */
  .suggestions{display:grid;grid-template-columns:1fr;gap:10px;padding:10px 0}
  .suggestion-card{border:1px solid var(--line);border-radius:10px;padding:12px;background:rgba(15,23,42,0.3)}
  .suggestion-card.info{border-left:3px solid #3b82f6}
  .suggestion-card.warning{border-left:3px solid #f59e0b}
  .suggestion-card.success{border-left:3px solid #10b981}
  .suggestion-card h4{margin:0 0 8px 0;font-size:13px;display:flex;align-items:center;gap:6px}
  .suggestion-card p{margin:6px 0;font-size:12px;line-height:1.6;color:var(--muted)}
  .suggestion-card ul{margin:8px 0;padding-left:20px;font-size:12px;color:var(--muted)}
  .suggestion-card button{margin-top:8px;font-size:11px;padding:6px 12px}
  
  /* æ–°å¢ï¼šæç¤ºåœ–æ¨™ */
  .help-icon{display:inline-block;width:16px;height:16px;border-radius:50%;background:#3b82f6;color:white;text-align:center;line-height:16px;font-size:11px;cursor:help;margin-left:4px}
  .help-icon:hover{background:#2563eb}
  
  /* æ–°å¢ï¼šæç¤ºæ³¡æ³¡ */
  .help-popup{position:absolute;background:rgba(17,24,39,0.98);border:1px solid var(--line);border-radius:8px;padding:10px;font-size:11px;line-height:1.5;max-width:250px;z-index:100;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.3)}
  .help-popup.show{display:block}
  
  /* æ–°å¢ï¼šç¸½çµå¡ç‰‡ */
  .summary-card{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:12px;text-align:center}
  .summary-card .main-result{font-size:16px;font-weight:600;margin-bottom:8px;line-height:1.6}
  .summary-card .main-result .emoji{font-size:20px;margin-right:6px}
  .summary-card .sub-text{font-size:12px;color:var(--muted)}
  
  /* æ–°å¢ï¼šæ™‚é–“è»¸ */
  .timeline{padding:16px 0;margin:12px 0}
  .timeline-track{position:relative;height:3px;background:var(--line);border-radius:2px;margin:20px 0}
  .timeline-points{position:relative;display:flex;justify-content:space-between;margin-top:-12px}
  .timeline-point{text-align:center;flex:1;position:relative}
  .timeline-point .dot{width:12px;height:12px;border-radius:50%;background:var(--muted);margin:0 auto 6px;border:2px solid var(--bg)}
  .timeline-point.achieved .dot{background:var(--green);box-shadow:0 0 8px var(--green)}
  .timeline-point.current .dot{background:var(--blue);box-shadow:0 0 8px var(--blue)}
  .timeline-point .label{font-size:10px;color:var(--muted);margin-top:4px}
  .timeline-point .year{font-size:11px;font-weight:600;margin-top:2px}
  
  @media(max-width:900px){
    .suggestions{grid-template-columns:1fr}
    .suggestion-card{padding:10px}
    .suggestion-card h4{font-size:12px}
    .help-popup{max-width:200px;font-size:10px}
  }
</style>
</head>
<body>
<header>
  <h1>è²¡å‹™è‡ªç”±è·¯å¾‘è©¦ç®—ï½œFIRE Playground</h1>
  <p>è¼¸å…¥å°å¹£é‡‘é¡èˆ‡åƒæ•¸ï¼Œç³»çµ±å³æ™‚è¨ˆç®—ï¼šã€Œç”Ÿå­˜/ç”Ÿæ´»/å·¥ä½œè‡ªç”±ã€èˆ‡ FIRE / FAT FIRE çš„é”æˆé–€æª»èˆ‡è¶¨å‹¢ã€‚</p>
</header>

<main>
  <section class="panel">
    <h2>åŸºæœ¬åƒæ•¸</h2>
    <div class="grid">
      <div class="row">
        <label>ç›®å‰è³‡ç”¢æ·¨å€¼<span class="help-icon" data-help="assets">?</span></label>
        <input id="assets" type="number" step="10000" value="3000000"/>
      </div>
      <div class="row">
        <label>æ¯æœˆç¸½æ”¶å…¥<span class="help-icon" data-help="totalIncome">?</span></label>
        <input id="totalIncome" type="number" step="1000" value="240000"/>
      </div>
      <div class="row">
        <label>åŸºæœ¬ç”Ÿæ´»è²»ï¼ˆæœˆï¼‰<span class="help-icon" data-help="survival">?</span></label>
        <input id="survival" type="number" step="1000" value="60000"/>
      </div>
      <div class="row">
        <label>ç†æƒ³ç”Ÿæ´»è²»ï¼ˆæœˆï¼‰<span class="help-icon" data-help="lifestyle">?</span></label>
        <input id="lifestyle" type="number" step="1000" value="120000"/>
      </div>
      <div class="row">
        <label>æŠ•è³‡å¹´åŒ–å ±é…¬ %<span class="help-icon" data-help="returnRate">?</span></label>
        <input id="returnRate" type="number" step="0.1" value="6"/>
      </div>
      <div class="row">
        <label>æ¨¡æ“¬å¹´æ•¸</label>
        <input id="years" type="number" min="1" max="60" value="30"/>
      </div>
    </div>
    
    <!-- æ‰‹é¢¨ç´å¼é€²éšè¨­å®š -->
    <div class="accordion">
      <div class="accordion-item">
        <div class="accordion-header">
          <h3><span class="accordion-icon">â–¶</span> ğŸ’° æ”¶å…¥ç´°ç¯€ï¼ˆé¸å¡«ï¼‰</h3>
        </div>
        <div class="accordion-content">
          <div class="accordion-body">
            <p style="font-size:11px;color:var(--muted);margin:0 0 10px 0">åˆ†é–‹è¨­å®šä¸»æ¥­å’Œå‰¯æ¥­å¯ä»¥æ›´æº–ç¢ºé æ¸¬æœªä¾†æ”¶å…¥æˆé•·ã€‚ç•™ç©ºå‰‡ä½¿ç”¨ç¸½æ”¶å…¥ã€‚</p>
            <div class="grid">
              <div class="row">
                <label>ä¸»æ¥­æœˆæ”¶å…¥<span class="help-icon" data-help="mainIncome">?</span></label>
                <input id="mainIncome" type="number" step="1000" value="200000"/>
              </div>
              <div class="row">
                <label>å‰¯æ¥­æœˆæ”¶å…¥<span class="help-icon" data-help="sideIncome">?</span></label>
                <input id="sideIncome" type="number" step="1000" value="40000"/>
              </div>
              <div class="row">
                <label>ä¸»æ¥­å¹´æˆé•·ç‡ %<span class="help-icon" data-help="mainGrowth">?</span></label>
                <input id="mainGrowth" type="number" step="0.1" value="3"/>
              </div>
              <div class="row">
                <label>å‰¯æ¥­å¹´æˆé•·ç‡ %<span class="help-icon" data-help="sideGrowth">?</span></label>
                <input id="sideGrowth" type="number" step="0.1" value="10"/>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="accordion-item">
        <div class="accordion-header">
          <h3><span class="accordion-icon">â–¶</span> ğŸŒ¡ï¸ é€šè†¨èˆ‡æ”¯å‡º</h3>
        </div>
        <div class="accordion-content">
          <div class="accordion-body">
            <p style="font-size:11px;color:var(--muted);margin:0 0 10px 0">é€šè†¨æœƒè®“æœªä¾†çš„éŒ¢è®Šè–„ï¼Œå»ºè­°è¨­å®š 2-3% çš„å¹´é€šè†¨ç‡è®“è¨ˆç®—æ›´è²¼è¿‘ç¾å¯¦ã€‚</p>
            <div class="grid">
              <div class="row">
                <label>å¹´é€šè†¨ç‡ %<span class="help-icon" data-help="inflation">?</span></label>
                <input id="inflation" type="number" step="0.1" value="0" min="0" max="10"/>
              </div>
              <div class="row">
                <label>FAT FIRE æ”¯å‡ºï¼ˆæœˆï¼‰<span class="help-icon" data-help="fat">?</span></label>
                <input id="fat" type="number" step="1000" value="216000"/>
              </div>
              <div class="row">
                <label>æ”¯å‡ºéš¨é€šè†¨èª¿æ•´ï¼Ÿ</label>
                <select id="inflationAdjust">
                  <option value="yes" selected>æ˜¯</option>
                  <option value="no">å¦</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="accordion-item">
        <div class="accordion-header">
          <h3><span class="accordion-icon">â–¶</span> ğŸ“Š æŠ•è³‡ç­–ç•¥</h3>
        </div>
        <div class="accordion-content">
          <div class="accordion-body">
            <p style="font-size:11px;color:var(--muted);margin:0 0 10px 0">é¸æ“‡é©åˆä½ çš„é¢¨éšªç­‰ç´šï¼Œå ±é…¬ç‡æœƒè‡ªå‹•èª¿æ•´ã€‚</p>
            <div class="grid">
              <div class="row">
                <label>é¢¨éšªç­‰ç´š</label>
                <select id="riskLevel">
                  <option value="conservative">ä¿å®ˆå‹ (4%)</option>
                  <option value="moderate" selected>ç©©å¥å‹ (6%)</option>
                  <option value="aggressive">ç©æ¥µå‹ (8%)</option>
                  <option value="custom">è‡ªè¨‚</option>
                </select>
              </div>
              <div class="row" id="customReturnRow" style="display:none">
                <label>è‡ªè¨‚å ±é…¬ç‡ %</label>
                <input id="customReturn" type="number" step="0.1" value="6"/>
              </div>
              <div class="row">
                <label>æé ˜ç‡ % / å¹´<span class="help-icon" data-help="wr">?</span></label>
                <input id="wr" type="number" step="0.1" value="4"/>
              </div>
              <div class="row">
                <label>ç›ˆé¤˜å…¨éƒ¨æŠ•å…¥ï¼Ÿ</label>
                <select id="reinvest">
                  <option value="yes" selected>æ˜¯</option>
                  <option value="no">å¦</option>
                </select>
              </div>
            </div>
            <div style="margin-top:10px;padding:10px;background:rgba(59,130,246,0.1);border-radius:8px;font-size:11px;line-height:1.6">
              <strong>ğŸ’¡ é¢¨éšªç­‰ç´šèªªæ˜ï¼š</strong><br>
              â€¢ ä¿å®ˆå‹ï¼šä»¥å‚µåˆ¸ã€å®šå­˜ç‚ºä¸»<br>
              â€¢ ç©©å¥å‹ï¼šè‚¡å‚µå¹³è¡¡é…ç½®<br>
              â€¢ ç©æ¥µå‹ï¼šé«˜æ¯”ä¾‹è‚¡ç¥¨
            </div>
          </div>
        </div>
      </div>
      
      <div class="accordion-item">
        <div class="accordion-header">
          <h3><span class="accordion-icon">â–¶</span> ğŸ“ FIRE çŸ¥è­˜è£œçµ¦ç«™</h3>
        </div>
        <div class="accordion-content">
          <div class="accordion-body">
            <div style="font-size:12px;line-height:1.8">
              <h4 style="margin:0 0 8px 0;font-size:13px;color:var(--green)">ğŸ’° FIRE æ˜¯ä»€éº¼ï¼Ÿ</h4>
              <p style="color:var(--muted);margin:0 0 12px 0">
                FIRE = Financial Independence, Retire Earlyï¼ˆè²¡å‹™ç¨ç«‹ï¼Œææ—©é€€ä¼‘ï¼‰<br>
                æ ¸å¿ƒæ¦‚å¿µæ˜¯é€éå„²è“„å’ŒæŠ•è³‡ï¼Œç´¯ç©è¶³å¤ è³‡ç”¢ï¼Œè®“è¢«å‹•æ”¶å…¥è¦†è“‹ç”Ÿæ´»æ”¯å‡ºã€‚
              </p>
              
              <h4 style="margin:12px 0 8px 0;font-size:13px;color:var(--blue)">ğŸ¯ FIRE çš„é¡å‹</h4>
              <ul style="margin:0;padding-left:20px;color:var(--muted)">
                <li><strong>Lean FIRE</strong>ï¼šæ¥µç°¡ç”Ÿæ´»ï¼Œé™ä½æ”¯å‡ºåˆ°æœ€ä½</li>
                <li><strong>Regular FIRE</strong>ï¼šç¶­æŒèˆ’é©ç”Ÿæ´»æ°´æº–</li>
                <li><strong>Fat FIRE</strong>ï¼šå¯Œè£•é€€ä¼‘ï¼Œé«˜å“è³ªç”Ÿæ´»</li>
                <li><strong>Barista FIRE</strong>ï¼šåŠé€€ä¼‘ï¼Œåšè¼•é¬†å…¼è·</li>
                <li><strong>Coast FIRE</strong>ï¼šåœæ­¢æŠ•å…¥ï¼Œè®“è³‡ç”¢è‡ªç„¶æˆé•·</li>
              </ul>
              
              <h4 style="margin:12px 0 8px 0;font-size:13px;color:var(--orange)">ğŸ“ 4% æ³•å‰‡</h4>
              <p style="color:var(--muted);margin:0">
                ä¾†è‡ª Trinity Study ç ”ç©¶ï¼Œå»ºè­°æ¯å¹´å¾æŠ•è³‡çµ„åˆæé ˜ 4%ï¼Œæœ‰ 95% çš„æ©Ÿç‡å¯ä»¥ç¶­æŒ 30 å¹´ä¸æœƒæŠŠéŒ¢èŠ±å…‰ã€‚<br>
                ä¾‹å¦‚ï¼šå¹´æ”¯å‡º 120 è¬ï¼Œå‰‡éœ€è¦ 3000 è¬è³‡ç”¢ï¼ˆ120è¬ Ã· 4% = 3000è¬ï¼‰
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- è¨ˆç®—æŒ‰éˆ•å€ -->
    <div class="actions" style="margin-top:16px">
      <button class="primary" id="calc" style="width:100%;font-size:15px;padding:12px;font-weight:600">ğŸš€ é–‹å§‹è¨ˆç®—æˆ‘çš„ FIRE è·¯å¾‘</button>
    </div>
    
    <div class="actions" style="margin-top:8px">
      <button id="fatfill">ç”¨ç”Ÿæ´»è²» Ã— 1.8 å¡«å…¥ FAT</button>
      <button id="share">åˆ†äº«åƒæ•¸é€£çµ</button>
      <button id="savepng">ä¸‹è¼‰çµæœ PNG</button>
      <button id="reset">é‡è¨­ç‚ºé è¨­å€¼</button>
    </div>
    
    <!-- æ™ºèƒ½å»ºè­°å¡ç‰‡å€ï¼ˆç§»åˆ°é€™è£¡ï¼‰ -->
    <div id="suggestions" class="suggestions" style="display:none"></div>
    
    <!-- KPI è©³ç´°çµæœ -->
    <div class="kpi" id="kpi"></div>
  </section>

  <section class="panel">
    <h2>åˆ†æçµæœ</h2>
    
    <!-- ä¸€å¥è©±ç¸½çµ -->
    <div id="summaryCard" class="summary-card"></div>
    
    <!-- æ™‚é–“è»¸ -->
    <div id="timeline" class="timeline" style="display:none"></div>
    
    <h2 style="margin-top:16px;padding:10px 12px 0;font-size:14px;color:#cbd5e1;border:none">åœ–è¡¨åˆ†æ</h2>
    <div class="charts">
      <div class="chartbox">
        <h3>ç¾é‡‘æµè¶¨å‹¢ï¼ˆä¸»æ¥­ / å‰¯æ¥­ / ç¸½æ”¶å…¥ vs ç”Ÿå­˜/ç”Ÿæ´»ï¼‰</h3>
        <div class="chart-wrapper">
          <canvas id="cvCash"></canvas>
        </div>
        <div class="tooltip" id="tooltipCash"></div>
      </div>
      <div class="chartbox">
        <h3>è³‡ç”¢å¢é•·æ¨¡æ“¬ï¼ˆä¸‰æ¢æ”¯å‡ºè·¯å¾‘ï¼‰</h3>
        <div class="chart-wrapper">
          <canvas id="cvAsset"></canvas>
        </div>
        <div class="tooltip" id="tooltipAsset"></div>
      </div>
    </div>
  </section>
</main>

<div class="back-home">
  <a href="https://www.eaglish.store">å›åœ˜è³¼é¦–é </a>
</div>

<footer>âš ï¸ æœ¬å·¥å…·åƒ…ä¾›æ•™è‚²èˆ‡è²¡å‹™è¦åŠƒåƒè€ƒï¼ŒéæŠ•è³‡å»ºè­°ã€‚æ‰€æœ‰é‡‘é¡ä»¥æ–°å°å¹£è¨ˆç®—ï¼Œæ¡ã€Œæœˆã€ç‚ºé€±æœŸã€å¹´åŒ–ç‡æŠ˜ç®—ç‚ºæœˆè¤‡åˆ©ã€‚</footer>

<script>
const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);
const css = n=>getComputedStyle(document.documentElement).getPropertyValue(n).trim();
const C = {
  blue:css('--blue'), teal:css('--teal'), orange:css('--orange'), green:css('--green'), asset:css('--asset'),
  sur:css('--sur'), life:css('--life'), fire:css('--fire'), fat:css('--fat')
};

// ==== æ–°å¢ï¼šå¹«åŠ©æç¤ºç³»çµ± ====
const helpTexts = {
  survival: 'èƒ½æ´»ä¸‹å»çš„æœ€ä½é–‹éŠ·ï¼ŒåŒ…æ‹¬æˆ¿ç§Ÿã€é£Ÿç‰©ã€æ°´é›»ç­‰åŸºæœ¬éœ€æ±‚ã€‚',
  lifestyle: 'èˆ’é©ç”Ÿæ´»çš„æ¯æœˆé–‹éŠ·ï¼ŒåŒ…æ‹¬å¨›æ¨‚ã€æ—…éŠã€å¤–é£Ÿç­‰ã€‚',
  fat: 'FAT FIRE æ˜¯æ›´è±ªè¯çš„é€€ä¼‘ç”Ÿæ´»ï¼Œé€šå¸¸æ˜¯ç”Ÿæ´»æ”¯å‡ºçš„ 1.5-2 å€ã€‚',
  assets: 'ä½ ç›®å‰æ“æœ‰çš„è³‡ç”¢ç¸½é¡ï¼ŒåŒ…æ‹¬å­˜æ¬¾ã€è‚¡ç¥¨ã€åŸºé‡‘ç­‰ï¼ˆä¸å«è‡ªä½æˆ¿ç”¢ï¼‰ã€‚',
  totalIncome: 'ä½ çš„æ¯æœˆç¸½æ”¶å…¥ï¼ŒåŒ…æ‹¬ä¸»æ¥­ã€å‰¯æ¥­ã€å…¼è·ç­‰æ‰€æœ‰æ”¶å…¥ä¾†æºã€‚',
  mainIncome: 'ä½ çš„ä¸»è¦å·¥ä½œæ”¶å…¥ï¼Œé€šå¸¸æ˜¯è–ªè³‡æˆ–ç‡Ÿæ¥­æ”¶å…¥ã€‚',
  sideIncome: 'å‰¯æ¥­ã€å…¼è·ã€æ¥æ¡ˆç­‰é¡å¤–æ”¶å…¥ä¾†æºã€‚',
  mainGrowth: 'é æœŸä¸»æ¥­æ”¶å…¥æ¯å¹´æˆé•·çš„ç™¾åˆ†æ¯”ï¼Œä¸€èˆ¬ç‚º 3-5%ã€‚',
  sideGrowth: 'é æœŸå‰¯æ¥­æ”¶å…¥æ¯å¹´æˆé•·çš„ç™¾åˆ†æ¯”ï¼Œé€šå¸¸é«˜æ–¼ä¸»æ¥­ã€‚',
  returnRate: 'æŠ•è³‡çµ„åˆçš„é æœŸå¹´åŒ–å ±é…¬ç‡ã€‚ä¿å®ˆ 4%ã€ç©©å¥ 6%ã€ç©æ¥µ 8%ã€‚',
  wr: 'æ¯å¹´å¾è³‡ç”¢ä¸­æé ˜çš„ç™¾åˆ†æ¯”ã€‚4% æ³•å‰‡å»ºè­°ä¸è¶…é 4%ã€‚',
  inflation: 'ç‰©åƒ¹ä¸Šæ¼²çš„é€Ÿåº¦ï¼Œå°ç£è¿‘å¹´å¹³å‡ç´„ 2%ã€‚é€šè†¨æœƒè®“æœªä¾†çš„éŒ¢è®Šè–„ã€‚'
};

let currentHelpPopup = null;

function setupHelpIcons(){
  $$('.help-icon').forEach(icon => {
    icon.addEventListener('click', (e) => {
      e.stopPropagation();
      const key = icon.dataset.help;
      const text = helpTexts[key];
      if(!text) return;
      
      // ç§»é™¤èˆŠçš„ popup
      if(currentHelpPopup){
        currentHelpPopup.remove();
        currentHelpPopup = null;
      }
      
      // å‰µå»ºæ–°çš„ popup
      const popup = document.createElement('div');
      popup.className = 'help-popup show';
      popup.innerHTML = text;
      document.body.appendChild(popup);
      
      // å®šä½
      const rect = icon.getBoundingClientRect();
      popup.style.left = (rect.left - popup.offsetWidth / 2 + 8) + 'px';
      popup.style.top = (rect.bottom + 8) + 'px';
      
      currentHelpPopup = popup;
    });
  });
  
  // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰ popup
  document.addEventListener('click', () => {
    if(currentHelpPopup){
      currentHelpPopup.remove();
      currentHelpPopup = null;
    }
  });
}

// ==== æ–°å¢ï¼šæ‰‹é¢¨ç´åŠŸèƒ½ ====
function setupAccordion(){
  $$('.accordion-header').forEach(header => {
    header.addEventListener('click', () => {
      const item = header.parentElement;
      const isOpen = item.classList.contains('open');
      
      // åˆ‡æ›ç•¶å‰é …ç›®
      if(isOpen){
        item.classList.remove('open');
      } else {
        item.classList.add('open');
      }
    });
  });
}

// ==== æ–°å¢ï¼šé¢¨éšªç­‰ç´šé¸æ“‡å™¨ ====
function setupRiskLevel(){
  const riskSelect = $('#riskLevel');
  const returnInput = $('#returnRate');
  const customRow = $('#customReturnRow');
  const customInput = $('#customReturn');
  
  riskSelect.addEventListener('change', () => {
    const val = riskSelect.value;
    if(val === 'conservative'){
      returnInput.value = 4;
      customRow.style.display = 'none';
    } else if(val === 'moderate'){
      returnInput.value = 6;
      customRow.style.display = 'none';
    } else if(val === 'aggressive'){
      returnInput.value = 8;
      customRow.style.display = 'none';
    } else if(val === 'custom'){
      customRow.style.display = '';
      returnInput.value = customInput.value;
    }
    run(); // é‡æ–°è¨ˆç®—
  });
  
  customInput.addEventListener('input', () => {
    if(riskSelect.value === 'custom'){
      returnInput.value = customInput.value;
      run();
    }
  });
}

// æ”¹é€²çš„æ ¼å¼åŒ–å‡½æ•¸ï¼šä½¿ç”¨è¬ã€ç™¾è¬ã€åƒè¬ã€å„„
function fmt(n){
  n = Math.round(n);
  if(n >= 100000000) return 'NT$' + (n/100000000).toFixed(1) + 'å„„';
  if(n >= 10000000) return 'NT$' + (n/10000000).toFixed(1) + 'åƒè¬';
  if(n >= 1000000) return 'NT$' + (n/1000000).toFixed(1) + 'ç™¾è¬';
  if(n >= 10000) return 'NT$' + (n/10000).toFixed(1) + 'è¬';
  return 'NT$' + n.toLocaleString('zh-TW');
}

// Yè»¸æ¨™ç±¤æ ¼å¼åŒ–
function fmtAxis(n){
  n = Math.round(n);
  if(n >= 100000000) return (n/100000000).toFixed(0) + 'å„„';
  if(n >= 10000000) return (n/10000000).toFixed(0) + 'åƒè¬';
  if(n >= 1000000) return (n/1000000).toFixed(0) + 'ç™¾è¬';
  if(n >= 10000) return (n/10000).toFixed(0) + 'è¬';
  return n.toLocaleString('zh-TW');
}

const monthsToText = m => m===Infinity ? 'å°šæœªé”æˆï¼ˆæ¨¡æ“¬æœŸå…§ï¼‰' : (Math.floor(m/12)+' å¹´ '+(m%12? m%12+' å€‹æœˆ':''));

const defaults = {
  survival:60000,
  lifestyle:120000,
  fat:216000,
  assets:3000000,
  totalIncome:240000,
  mainIncome:200000,
  sideIncome:40000,
  mainGrowth:3,
  sideGrowth:10,
  returnRate:6,
  wr:4,
  years:30,
  reinvest:'yes',
  inflation:0,
  inflationAdjust:'yes'
};

// ==== æ–°å¢ï¼šæ”¶å…¥æ¬„ä½åŒæ­¥åŠŸèƒ½ ====
function setupIncomeSync(){
  const totalIncomeInput = $('#totalIncome');
  const mainIncomeInput = $('#mainIncome');
  const sideIncomeInput = $('#sideIncome');
  
  // ç•¶ç¸½æ”¶å…¥æ”¹è®Šæ™‚ï¼Œæ›´æ–°ä¸»æ¥­+å‰¯æ¥­
  totalIncomeInput.addEventListener('input', () => {
    const total = parseFloat(totalIncomeInput.value) || 0;
    const currentMain = parseFloat(mainIncomeInput.value) || 0;
    const currentSide = parseFloat(sideIncomeInput.value) || 0;
    const currentTotal = currentMain + currentSide;
    
    if(currentTotal > 0){
      // æŒ‰æ¯”ä¾‹åˆ†é…
      const ratio = total / currentTotal;
      mainIncomeInput.value = Math.round(currentMain * ratio);
      sideIncomeInput.value = Math.round(currentSide * ratio);
    } else {
      // é è¨­ 80/20 åˆ†é…
      mainIncomeInput.value = Math.round(total * 0.8);
      sideIncomeInput.value = Math.round(total * 0.2);
    }
  });
  
  // ç•¶ä¸»æ¥­æˆ–å‰¯æ¥­æ”¹è®Šæ™‚ï¼Œæ›´æ–°ç¸½æ”¶å…¥
  const updateTotal = () => {
    const main = parseFloat(mainIncomeInput.value) || 0;
    const side = parseFloat(sideIncomeInput.value) || 0;
    totalIncomeInput.value = main + side;
  };
  
  mainIncomeInput.addEventListener('input', updateTotal);
  sideIncomeInput.addEventListener('input', updateTotal);
}

// ---- URL åƒæ•¸è®€å¯« ----
function readFromUI(){
  // è®€å–æ”¶å…¥ï¼ˆå„ªå…ˆä½¿ç”¨ä¸»æ¥­+å‰¯æ¥­ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ç¸½æ”¶å…¥ï¼‰
  const mainIncome = parseFloat($('#mainIncome').value) || 0;
  const sideIncome = parseFloat($('#sideIncome').value) || 0;
  const totalIncome = parseFloat($('#totalIncome').value) || 0;
  
  let main0, side0;
  if(mainIncome > 0 || sideIncome > 0){
    // ä½¿ç”¨è©³ç´°è¼¸å…¥
    main0 = mainIncome;
    side0 = sideIncome;
  } else if(totalIncome > 0){
    // ä½¿ç”¨ç¸½æ”¶å…¥ï¼Œé è¨­ 80/20 åˆ†é…
    main0 = totalIncome * 0.8;
    side0 = totalIncome * 0.2;
  } else {
    main0 = 0;
    side0 = 0;
  }
  
  return {
    survival: parseFloat($('#survival').value) || 0,
    lifestyle: parseFloat($('#lifestyle').value) || 0,
    fat: parseFloat($('#fat').value) || 0,
    assets0: parseFloat($('#assets').value) || 0,
    main0: main0,
    side0: side0,
    gMain: (parseFloat($('#mainGrowth').value) || 0) / 100,
    gSide: (parseFloat($('#sideGrowth').value) || 0) / 100,
    r: (parseFloat($('#returnRate').value) || 0) / 100,
    wr: (parseFloat($('#wr').value) || 0) / 100,
    years: Math.max(1, Math.min(60, parseInt($('#years').value) || 30)),
    reinvest: $('#reinvest').value === 'yes',
    inflation: (parseFloat($('#inflation').value) || 0) / 100,
    inflationAdjust: $('#inflationAdjust').value === 'yes'
  };
}
function applyQuery(){
  const url = new URL(location.href);
  const q = url.searchParams;
  for(const k in defaults){
    if(q.has(k)){
      const el = document.getElementById(k);
      if(el) el.value = q.get(k);
    }
  }
}
function shareLink(){
  const url = new URL(location.href);
  const p = readFromUI();
  for(const k in defaults){ url.searchParams.set(k, p[k]); }
  navigator.clipboard.writeText(url.toString());
  alert('åƒæ•¸é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
}

// ---- æ•¸æ“šæ¨¡æ“¬ ----
function simulate(){
  const p = readFromUI();
  const months = p.years*12|0;
  const mG = Math.pow(1+p.gMain,1/12)-1;
  const sG = Math.pow(1+p.gSide,1/12)-1;
  const rM = Math.pow(1+p.r,1/12)-1;
  const iM = p.inflationAdjust ? Math.pow(1+p.inflation,1/12)-1 : 0; // æœˆé€šè†¨ç‡

  const L=[], main=[], side=[], total=[],  // ç¾é‡‘æµï¼ˆä¸å«è¢«å‹•ï¼‰
        A_surv=[], A_life=[], A_mid=[];    // ä¸‰æ¢è³‡ç”¢è·¯å¾‘
  const t = {survival:Infinity, life:Infinity, work:Infinity, fire:Infinity, fat:Infinity};

  let A1=p.assets0, A2=p.assets0, A3=p.assets0;

  for(let m=0;m<=months;m++){
    const ma = p.main0*Math.pow(1+mG,m);
    const si = p.side0*Math.pow(1+sG,m);
    const tot = ma+si;

    L.push((m/12)); main.push(ma); side.push(si); total.push(tot);

    // æ”¯å‡ºéš¨é€šè†¨èª¿æ•´
    const inflationFactor = Math.pow(1+iM, m);
    const survival_adjusted = p.survival * inflationFactor;
    const lifestyle_adjusted = p.lifestyle * inflationFactor;
    const mid_adjusted = (p.survival + p.lifestyle) / 2 * inflationFactor;

    // é‡Œç¨‹ç¢‘ï¼ˆä»¥ç¾é‡‘æµå®šç¾©ï¼Œä½¿ç”¨èª¿æ•´å¾Œçš„æ”¯å‡ºï¼‰
    if(t.survival===Infinity && si>=survival_adjusted) t.survival=m;
    if(t.life===Infinity && tot>=lifestyle_adjusted) t.life=m;
    if(t.work===Infinity && si>=ma) t.work=m;

    // ä¸‰ç¨®æ”¯å‡ºä¸‹çš„ç›ˆé¤˜ï¼ˆåƒ…æŠ•è³‡ç›ˆé¤˜ï¼›ä¸è¨ˆè¢«å‹•ç¾é‡‘æµï¼‰
    const c1 = p.reinvest ? Math.max(0, tot - survival_adjusted) : 0;
    const c2 = p.reinvest ? Math.max(0, tot - lifestyle_adjusted) : 0;
    const c3 = p.reinvest ? Math.max(0, tot - mid_adjusted) : 0;

    if(m===0){ A_surv.push(A1); A_life.push(A2); A_mid.push(A3); }
    else{
      A1 = A1*(1+rM) + c1;
      A2 = A2*(1+rM) + c2;
      A3 = A3*(1+rM) + c3;
      A_surv.push(A1); A_life.push(A2); A_mid.push(A3);
    }
  }
  
  // FIRE ç›®æ¨™ï¼ˆè€ƒæ…®é€šè†¨å½±éŸ¿ï¼Œä½¿ç”¨ç•¶å‰çš„æ”¯å‡ºé‡‘é¡ï¼‰
  const fireTarget = p.lifestyle*12/p.wr;
  const fatTarget  = p.fat*12/p.wr;
  
  // FIRE é”æˆæ™‚é–“ï¼šä»¥ã€Œç”Ÿæ´»æ”¯å‡ºè·¯å¾‘ã€è³‡ç”¢ç‚ºæº–
  t.fire = A_life.findIndex(v=>v>=fireTarget); if(t.fire<0) t.fire=Infinity;
  t.fat  = A_life.findIndex(v=>v>=fatTarget); if(t.fat<0) t.fat=Infinity;

  return {p, L, main, side, total, A_surv, A_life, A_mid, t, fireTarget, fatTarget};
}

// ---- KPI ----
function renderKPI(S){
  const el = $('#kpi');
  const K = [
    ['ç”Ÿå­˜è‡ªç”±ï¼ˆå‰¯æ¥­ â‰¥ ç”Ÿå­˜ï¼‰', S.t.survival, [['é”æˆæ™‚é–“', monthsToText(S.t.survival)], ['é”æˆæ™‚å‰¯æ¥­', S.t.survival<Infinity? fmt(S.side[S.t.survival]):'â€”']]],
    ['ç”Ÿæ´»è‡ªç”±ï¼ˆç¸½æ”¶å…¥ â‰¥ ç”Ÿæ´»ï¼‰', S.t.life, [['é”æˆæ™‚é–“', monthsToText(S.t.life)], ['é”æˆæ™‚ç¸½æ”¶å…¥', S.t.life<Infinity? fmt(S.total[S.t.life]):'â€”']]],
    ['å·¥ä½œè‡ªç”±ï¼ˆå‰¯æ¥­ â‰¥ ä¸»æ¥­ï¼‰', S.t.work, [['é”æˆæ™‚é–“', monthsToText(S.t.work)], ['å‰¯æ¥­', S.t.work<Infinity? fmt(S.side[S.t.work]):'â€”'], ['ä¸»æ¥­', S.t.work<Infinity? fmt(S.main[S.t.work]):'â€”']]],
    ['è²¡å¯Œè‡ªç”± FIREï¼ˆè³‡ç”¢ â‰¥ ç”Ÿæ´»/æé ˜ç‡ï¼‰', S.t.fire, [['é”æˆæ™‚é–“', monthsToText(S.t.fire)], ['è³‡ç”¢é–€æª»', fmt(S.fireTarget)], ['é”æˆæ™‚è³‡ç”¢', S.t.fire<Infinity? fmt(S.A_life[S.t.fire]):'â€”']]],
    ['è²¡å¯Œè±ç›› FAT FIREï¼ˆè³‡ç”¢ â‰¥ FAT/æé ˜ç‡ï¼‰', S.t.fat, [['é”æˆæ™‚é–“', monthsToText(S.t.fat)], ['è³‡ç”¢é–€æª»', fmt(S.fatTarget)], ['é”æˆæ™‚è³‡ç”¢', S.t.fat<Infinity? fmt(S.A_life[S.t.fat]):'â€”']]],
  ];
  el.innerHTML = K.map(([title,t,rows])=>{
    const cls = 'k ' + (t<Infinity? 'ok':'warn');
    const rs = rows.map(([k,v])=>`<p><span style="color:#9ca3af">${k}</span>ã€€${v}</p>`).join('');
    return `<div class="${cls}"><h3>${title}</h3>${rs}</div>`;
  }).join('');
}

// ==== æ–°å¢ï¼šæ¸²æŸ“ç¸½çµå¡ç‰‡ ====
function renderSummary(S){
  const el = $('#summaryCard');
  const fireYears = S.t.fire < Infinity ? Math.floor(S.t.fire / 12) : null;
  const currentYear = new Date().getFullYear();
  
  let html = '';
  if(fireYears && fireYears <= S.p.years){
    const targetYear = currentYear + fireYears;
    html = `
      <div class="main-result">
        <span class="emoji">ğŸ¯</span>
        å¥½æ¶ˆæ¯ï¼æŒ‰ç…§ç›®å‰çš„æƒ…æ³ï¼Œä½ åœ¨ ${targetYear} å¹´ï¼ˆ${fireYears} å¹´å¾Œï¼‰å°±èƒ½é”æˆ FIREï¼
      </div>
      <div class="sub-text">å±†æ™‚ä½ çš„è³‡ç”¢å°‡é”åˆ° ${fmt(S.fireTarget)}ï¼Œè¶³ä»¥æ”¯æ’ç†æƒ³ç”Ÿæ´»</div>
    `;
  } else if(fireYears && fireYears > S.p.years){
    html = `
      <div class="main-result">
        <span class="emoji">â°</span>
        ä»¥ç›®å‰çš„ç‹€æ³ï¼Œéœ€è¦ç´„ ${fireYears} å¹´æ‰èƒ½é”æˆ FIRE
      </div>
      <div class="sub-text">åˆ¥æ“”å¿ƒï¼Œè®“æˆ‘å€‘çœ‹çœ‹å¦‚ä½•å„ªåŒ–ä½ çš„è¨ˆç•«...</div>
    `;
  } else {
    html = `
      <div class="main-result">
        <span class="emoji">ğŸ’ª</span>
        åœ¨æ¨¡æ“¬çš„ ${S.p.years} å¹´å…§å°šæœªé”æˆ FIRE
      </div>
      <div class="sub-text">èª¿æ•´åƒæ•¸æˆ–å»¶é•·æ¨¡æ“¬æ™‚é–“ï¼Œæ‰¾å‡ºæœ€é©åˆä½ çš„è·¯å¾‘</div>
    `;
  }
  
  el.innerHTML = html;
}

// ==== æ–°å¢ï¼šæ¸²æŸ“æ™‚é–“è»¸ ====
function renderTimeline(S){
  const el = $('#timeline');
  const currentYear = new Date().getFullYear();
  
  // å®šç¾©é‡Œç¨‹ç¢‘
  const milestones = [
    {key: 'current', label: 'ç¾åœ¨', year: currentYear, achieved: true, current: true},
    {key: 'survival', label: 'ç”Ÿå­˜è‡ªç”±', months: S.t.survival, achieved: S.t.survival < Infinity},
    {key: 'life', label: 'ç”Ÿæ´»è‡ªç”±', months: S.t.life, achieved: S.t.life < Infinity},
    {key: 'fire', label: 'FIRE', months: S.t.fire, achieved: S.t.fire < Infinity},
    {key: 'fat', label: 'FAT FIRE', months: S.t.fat, achieved: S.t.fat < Infinity}
  ];
  
  // è¨ˆç®—å¹´ä»½
  milestones.forEach(m => {
    if(m.months !== undefined && m.months < Infinity){
      m.year = currentYear + Math.floor(m.months / 12);
    }
  });
  
  // åªé¡¯ç¤ºå·²é”æˆæˆ–å³å°‡é”æˆçš„é‡Œç¨‹ç¢‘
  const visibleMilestones = milestones.filter(m => m.achieved || m.current);
  
  if(visibleMilestones.length <= 1){
    el.style.display = 'none';
    return;
  }
  
  el.style.display = 'block';
  
  let html = '<div class="timeline-track"></div><div class="timeline-points">';
  visibleMilestones.forEach(m => {
    const cls = m.current ? 'current' : (m.achieved ? 'achieved' : '');
    html += `
      <div class="timeline-point ${cls}">
        <div class="dot"></div>
        <div class="label">${m.label}</div>
        ${m.year ? `<div class="year">${m.year}</div>` : ''}
      </div>
    `;
  });
  html += '</div>';
  
  el.innerHTML = html;
}

// ==== æ–°å¢ï¼šæ™ºèƒ½å»ºè­°ç³»çµ± ====
function renderSuggestions(S){
  const el = $('#suggestions');
  const suggestions = [];
  
  const fireYears = S.t.fire < Infinity ? Math.floor(S.t.fire / 12) : Infinity;
  const savingsRate = S.p.reinvest ? ((S.total[0] - S.p.lifestyle) / S.total[0] * 100).toFixed(0) : 0;
  
  // å»ºè­° 1: å¦‚æœé”æˆæ™‚é–“å¤ªä¹…
  if(fireYears > 25 || fireYears === Infinity){
    suggestions.push({
      type: 'warning',
      title: 'ğŸ’¡ æƒ³è¦ææ—©é€€ä¼‘ï¼Ÿ',
      content: `
        <p>ä»¥ç›®å‰è¦åŠƒï¼ŒFIRE æ™‚é–“è¼ƒé•·ã€‚è©¦è©¦é€™äº›æ–¹æ³•ï¼š</p>
        <ul>
          <li>æé«˜å„²è“„ç‡åˆ° 50% ä»¥ä¸Š</li>
          <li>ç™¼å±•å‰¯æ¥­å¢åŠ æ”¶å…¥</li>
          <li>è€ƒæ…®é™ä½ç”Ÿæ´»æ”¯å‡º 10-20%</li>
        </ul>
      `,
      action: null
    });
  }
  
  // å»ºè­° 2: æª¢æŸ¥é€šè†¨
  const inflationRate = parseFloat($('#inflation').value) || 0;
  if(inflationRate < 1){
    suggestions.push({
      type: 'warning',
      title: 'âš ï¸ åˆ¥å¿˜è¨˜é€šè†¨ï¼',
      content: `
        <p>é€šè†¨æœƒè®“ä½ çš„ ${fmt(S.p.lifestyle * 12)} å¹´æ”¯å‡ºåœ¨ 20 å¹´å¾Œéœ€è¦æ›´å¤šéŒ¢æ‰èƒ½ç¶­æŒç›¸åŒç”Ÿæ´»å“è³ªã€‚</p>
        <p>å»ºè­°è¨­å®š 2-3% çš„å¹´é€šè†¨ç‡ï¼Œè®“è¨ˆç®—æ›´è²¼è¿‘ç¾å¯¦ã€‚</p>
      `,
      action: {text: 'è¨­å®šé€šè†¨', fn: () => {
        $('#inflation').value = 2;
        $$('.accordion-item')[1].classList.add('open');
        run();
      }}
    });
  }
  
  // å»ºè­° 3: Coast FIRE æª¢æŸ¥
  const coastTarget = S.fireTarget;
  const yearsToRetire = 30; // å‡è¨­ 30 å¹´å¾Œé€€ä¼‘
  const requiredNow = coastTarget / Math.pow(1 + S.p.r, yearsToRetire);
  
  if(S.p.assets0 >= requiredNow && S.t.fire > 12){
    suggestions.push({
      type: 'success',
      title: 'ğŸ‰ ä½ å·²é”æˆ Coast FIREï¼',
      content: `
        <p>å¥½æ¶ˆæ¯ï¼ä½ ç¾åœ¨çš„è³‡ç”¢ ${fmt(S.p.assets0)} å·²ç¶“è¶³å¤ ï¼Œå³ä½¿åœæ­¢å­˜éŒ¢ï¼Œåœ¨ ${yearsToRetire} å¹´å¾Œä¹Ÿèƒ½é”æˆ FIREï¼</p>
        <p>é€™è¡¨ç¤ºä½ å¯ä»¥ï¼š</p>
        <ul>
          <li>é™ä½å·¥ä½œå¼·åº¦</li>
          <li>è¿½æ±‚æ›´æœ‰æ„ç¾©ä½†è–ªæ°´è¼ƒä½çš„å·¥ä½œ</li>
          <li>æŠŠæ”¶å…¥ç”¨åœ¨ç•¶ä¸‹çš„ç”Ÿæ´»å“è³ª</li>
        </ul>
      `,
      action: null
    });
  }
  
  // å»ºè­° 4: å‰¯æ¥­ç™¼å±•
  const sideIncomeRatio = S.p.side0 / (S.p.main0 + S.p.side0);
  if(sideIncomeRatio < 0.2 && S.t.survival > 36){
    suggestions.push({
      type: 'info',
      title: 'ğŸ’¼ è€ƒæ…®ç™¼å±•å‰¯æ¥­',
      content: `
        <p>å‰¯æ¥­ä¸åªæ˜¯é¡å¤–æ”¶å…¥ï¼Œé‚„èƒ½ï¼š</p>
        <ul>
          <li>åˆ†æ•£æ”¶å…¥é¢¨éšª</li>
          <li>åŠ é€Ÿé”æˆè²¡å‹™è‡ªç”±</li>
          <li>åŸ¹é¤Šé€€ä¼‘å¾Œçš„æŠ€èƒ½</li>
        </ul>
        <p>å³ä½¿æ¯æœˆåªå¢åŠ  2-3 è¬å…ƒå‰¯æ¥­æ”¶å…¥ï¼Œä¹Ÿèƒ½å¤§å¹…ç¸®çŸ­ FIRE æ™‚é–“ï¼</p>
      `,
      action: null
    });
  }
  
  // é¡¯ç¤ºå»ºè­°
  if(suggestions.length > 0){
    el.style.display = 'grid';
    el.innerHTML = suggestions.map(s => `
      <div class="suggestion-card ${s.type}">
        <h4>${s.title}</h4>
        <div>${s.content}</div>
        ${s.action ? `<button onclick="${s.action.fn}">${s.action.text}</button>` : ''}
      </div>
    `).join('');
    
    // ç¶å®šæŒ‰éˆ•äº‹ä»¶
    suggestions.forEach((s, idx) => {
      if(s.action){
        const btn = el.querySelectorAll('button')[idx];
        if(btn) btn.onclick = s.action.fn;
      }
    });
  } else {
    el.style.display = 'none';
  }
}

// ---- ç¹ªåœ–å·¥å…· ----
function niceMax(max){
  if(max<=0) return 1;
  const pow = Math.pow(10, Math.floor(Math.log10(max)));
  const n = max/pow;
  const base = n<=1?1:n<=2?2:n<=5?5:10;
  return base*pow;
}
function drawLine(ctx, points, color, width=2, dash=null){
  ctx.save();
  ctx.lineWidth=width; ctx.strokeStyle=color; ctx.beginPath();
  if(dash) ctx.setLineDash(dash);
  points.forEach(([x,y],i)=>{ if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.stroke(); ctx.setLineDash([]); ctx.restore();
}

// Tooltip state
let currentTooltip = {canvas: null, tooltip: null, data: null};

function drawChart(canvas, tooltipEl, series, opts){
  // Get actual container width
  const container = canvas.parentElement;
  const isMobile = window.innerWidth <= 900;
  
  // Use container's actual width
  const baseWidth = container.clientWidth;
  const baseHeight = isMobile ? 320 : 380;
  
  // Set canvas size to match container
  canvas.style.width = '100%';
  canvas.style.height = baseHeight + 'px';
  
  // Set internal resolution for sharp rendering
  const dpr = Math.min(2, window.devicePixelRatio || 1); // Cap at 2 for performance
  canvas.width = baseWidth * dpr;
  canvas.height = baseHeight * dpr;
  
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.clearRect(0, 0, baseWidth, baseHeight);
  
  // Adaptive padding based on screen size
  const padL = isMobile ? 50 : 70;
  const padR = isMobile ? 20 : 40;
  const padT = isMobile ? 45 : 30;
  const padB = isMobile ? 35 : 40;
  const plot = {x: padL, y: padT, w: baseWidth - padL - padR, h: baseHeight - padT - padB};

  // X scale
  const N = series[0].data.length;
  const xPos = i => plot.x + plot.w * (i / (N - 1));

  // X-axis ticks - adaptive based on available width
  const yearsTotal = opts.years;
  let step;
  if(isMobile){
    step = yearsTotal <= 10 ? 2 : (yearsTotal <= 20 ? 5 : 10);
  } else {
    step = yearsTotal <= 10 ? 1 : (yearsTotal <= 20 ? 2 : 5);
  }

  // Y scale
  let yMax = 0;
  series.forEach(s => s.data.forEach(v => { if(v > yMax) yMax = v; }));
  if(opts.extraMax) yMax = Math.max(yMax, ...opts.extraMax);
  yMax = niceMax(yMax);
  const yPos = v => plot.y + plot.h * (1 - v / yMax);

  // Grid and axes
  ctx.strokeStyle = '#1f2937';
  ctx.lineWidth = 1;
  ctx.font = isMobile ? '9px system-ui' : '11px system-ui';
  ctx.fillStyle = '#9ca3af';
  ctx.textAlign = 'right';
  ctx.textBaseline = 'middle';
  
  // Y-axis grid and labels
  for(let i = 0; i <= 5; i++){
    const y = plot.y + plot.h * (1 - i / 5);
    ctx.beginPath();
    ctx.moveTo(plot.x, y);
    ctx.lineTo(plot.x + plot.w, y);
    ctx.stroke();
    const val = yMax * i / 5;
    ctx.fillText(fmtAxis(val), padL - 5, y);
  }
  
  // X-axis labels
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  for(let y = 0; y <= yearsTotal; y += step){
    const i = Math.round(N * y / yearsTotal);
    const x = xPos(i);
    if(x >= plot.x && x <= plot.x + plot.w){
      ctx.fillText(y + 'å¹´', x, baseHeight - padB + 5);
    }
  }

  // Draw series lines
  series.forEach(s => {
    const pts = s.data.map((v, i) => [xPos(i), yPos(v)]);
    drawLine(ctx, pts, s.color, s.w || 2, s.dash || null);
  });

  // Horizontal threshold labels
  if(opts.hLines){
    ctx.save();
    ctx.font = isMobile ? '10px system-ui' : '12px system-ui';
    ctx.fillStyle = '#cbd5e1';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'bottom';
    
    opts.hLines.forEach(h => {
      const y = yPos(h.y);
      drawLine(ctx, [[plot.x, y], [plot.x + plot.w, y]], h.color, 1.5, [6, 6]);
      ctx.fillText(h.label, plot.x + 3, y - 4);
    });
    ctx.restore();
  }

  // Legend - adaptive layout
  ctx.save();
  ctx.textAlign = 'left';
  ctx.textBaseline = 'top';
  ctx.font = isMobile ? '9px system-ui' : '10px system-ui';
  
  let lx = plot.x;
  let ly = plot.y - (isMobile ? 38 : 24);
  const legendItemSpacing = isMobile ? 4 : 8;
  const legendLineHeight = isMobile ? 12 : 14;
  
  series.forEach((s, idx) => {
    const text = s.name;
    const textWidth = ctx.measureText(text).width;
    const itemWidth = 14 + legendItemSpacing + textWidth + 12; // box + spacing + text + gap
    
    // Wrap to next line if needed (mobile only)
    if(isMobile && idx > 0 && lx + itemWidth > plot.x + plot.w){
      lx = plot.x;
      ly += legendLineHeight;
    }
    
    // Draw legend item
    ctx.fillStyle = s.color;
    ctx.fillRect(lx, ly + 3, 12, 2);
    ctx.fillStyle = '#cbd5e1';
    ctx.fillText(text, lx + 14 + legendItemSpacing, ly);
    
    lx += itemWidth;
  });
  ctx.restore();

  // Store data for tooltip
  currentTooltip = {
    canvas: canvas,
    tooltip: tooltipEl,
    data: {series, plot, xPos, yPos, N, yearsTotal, yMax, baseWidth, baseHeight}
  };
}

// Tooltip handler
function setupTooltip(canvas, tooltipEl){
  function handleMove(e){
    if(!currentTooltip.data || currentTooltip.canvas !== canvas) return;
    
    const rect = canvas.getBoundingClientRect();
    const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
    const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
    
    const x = clientX - rect.left;
    const y = clientY - rect.top;
    const {series, plot, xPos, N, yearsTotal} = currentTooltip.data;
    
    // Check if inside plot area
    if(x < plot.x || x > plot.x + plot.w || y < plot.y || y > plot.y + plot.h){
      tooltipEl.style.display = 'none';
      return;
    }
    
    // Find nearest data point
    let nearestIdx = 0;
    let minDist = Infinity;
    for(let i = 0; i < N; i++){
      const dist = Math.abs(xPos(i) - x);
      if(dist < minDist){
        minDist = dist;
        nearestIdx = i;
      }
    }
    
    // Build tooltip content
    const year = Math.floor(nearestIdx / 12);
    let html = `<div class="tooltip-row"><span class="tooltip-label">å¹´ä»½ï¼š</span>${year}å¹´</div>`;
    series.forEach(s => {
      if(!s.dash){ // Only show non-dashed lines in tooltip
        html += `<div class="tooltip-row"><span class="tooltip-label" style="color:${s.color}">${s.name}ï¼š</span>${fmt(s.data[nearestIdx])}</div>`;
      }
    });
    
    tooltipEl.innerHTML = html;
    tooltipEl.style.display = 'block';
    
    // Position tooltip - adjust for screen edges
    let tooltipX = clientX + 15;
    let tooltipY = clientY - 10;
    
    // Prevent tooltip from going off screen
    const tooltipRect = tooltipEl.getBoundingClientRect();
    if(tooltipX + tooltipRect.width > window.innerWidth){
      tooltipX = clientX - tooltipRect.width - 15;
    }
    if(tooltipY + tooltipRect.height > window.innerHeight){
      tooltipY = clientY - tooltipRect.height - 10;
    }
    if(tooltipY < 0) tooltipY = clientY + 20;
    
    tooltipEl.style.left = tooltipX + 'px';
    tooltipEl.style.top = tooltipY + 'px';
  }
  
  function handleLeave(){
    tooltipEl.style.display = 'none';
  }
  
  canvas.addEventListener('mousemove', handleMove);
  canvas.addEventListener('touchmove', (e) => {
    handleMove(e);
  }, {passive: true});
  canvas.addEventListener('mouseleave', handleLeave);
  canvas.addEventListener('touchend', handleLeave);
  canvas.addEventListener('touchcancel', handleLeave);
}

// ---- ä¸»æµç¨‹ ----
function run(){
  const S = simulate();
  
  // æ–°å¢ï¼šæ¸²æŸ“æ–°åŠŸèƒ½
  renderSummary(S);
  renderTimeline(S);
  renderSuggestions(S);
  
  // åŸæœ‰åŠŸèƒ½
  renderKPI(S);

  // ç¾é‡‘æµåœ–
  const cashSeries = [
    {name:'ä¸»æ¥­æ”¶å…¥', color:C.blue, data:S.main},
    {name:'å‰¯æ¥­æ”¶å…¥', color:C.teal, data:S.side},
    {name:'ç¸½æ”¶å…¥',   color:C.orange, data:S.total},
    {name:'ç”Ÿå­˜æ”¯å‡º', color:C.sur, data:Array(S.L.length).fill(S.p.survival), dash:[6,6], w:1.5},
    {name:'ç”Ÿæ´»æ”¯å‡º', color:C.life, data:Array(S.L.length).fill(S.p.lifestyle), dash:[6,6], w:1.5},
  ];
  drawChart($('#cvCash'), $('#tooltipCash'), cashSeries, {years:S.p.years});

  // è³‡ç”¢åœ–ï¼ˆä¸‰æ¢è·¯å¾‘ï¼‰
  const assetSeries = [
    {name:'è³‡ç”¢ï¼ˆç”Ÿå­˜æ”¯å‡ºè·¯å¾‘ï¼‰', color:C.green, data:S.A_surv},
    {name:'è³‡ç”¢ï¼ˆä¸­é–“æ”¯å‡ºè·¯å¾‘ï¼‰', color:'#7aa2ff', data:S.A_mid},
    {name:'è³‡ç”¢ï¼ˆç”Ÿæ´»æ”¯å‡ºè·¯å¾‘ï¼‰', color:C.blue, data:S.A_life},
  ];
  drawChart($('#cvAsset'), $('#tooltipAsset'), assetSeries, {
    years:S.p.years,
    extraMax:[S.fireTarget,S.fatTarget],
    hLines:[
      {y:S.fireTarget, label:'FIRE', color:C.fire},
      {y:S.fatTarget,  label:'FAT FIRE', color:C.fat}
    ]
  });
}

// PNG åˆä½µä¸‹è¼‰
function savePNG(){
  const c1=$('#cvCash'), c2=$('#cvAsset');
  const out = document.createElement('canvas');
  const W = Math.max(c1.width, c2.width)/ (window.devicePixelRatio||1);
  const H = (c1.height + c2.height)/ (window.devicePixelRatio||1) + 60;
  out.width = W*(window.devicePixelRatio||1); out.height = H*(window.devicePixelRatio||1);
  const ctx = out.getContext('2d'); ctx.setTransform(window.devicePixelRatio||1,0,0,window.devicePixelRatio||1,0,0);
  ctx.fillStyle = getComputedStyle(document.body).backgroundColor || '#0f172a';
  ctx.fillRect(0,0,W,H);
  ctx.drawImage(c1,0,0,c1.width/(window.devicePixelRatio||1),c1.height/(window.devicePixelRatio||1));
  ctx.drawImage(c2,0,c1.height/(window.devicePixelRatio||1)+60,c2.width/(window.devicePixelRatio||1),c2.height/(window.devicePixelRatio||1));
  const a=document.createElement('a'); a.download='fire_result.png'; a.href=out.toDataURL('image/png'); a.click();
}

// äº‹ä»¶
$('#calc').addEventListener('click', run);
$('#fatfill').addEventListener('click', ()=>{$('#fat').value=Math.round((+$('#lifestyle').value||0)*1.8); run();});
$('#share').addEventListener('click', shareLink);
$('#savepng').addEventListener('click', savePNG);
$('#reset').addEventListener('click', ()=>{ for(const k in defaults){ const el=document.getElementById(k); if(el) el.value=defaults[k]; } run(); });

// Debounced resize handler for better performance
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(run, 150);
}, {passive: true});

// Setup tooltips
setupTooltip($('#cvCash'), $('#tooltipCash'));
setupTooltip($('#cvAsset'), $('#tooltipAsset'));

// æ–°å¢ï¼šåˆå§‹åŒ–æ–°åŠŸèƒ½
setupHelpIcons();
setupAccordion();
setupRiskLevel();
setupIncomeSync();

applyQuery();
run();
</script>
</body>
</html>
