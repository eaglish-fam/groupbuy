html = r"""<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>財務自由路徑試算｜FIRE Playground</title>
  <style>
    :root{
      --bg:#0f172a;--panel:#0b1220;--ink:#e5e7eb;--muted:#9ca3af;--line:#1f2937;
      --blue:#60a5fa;--teal:#22d3ee;--orange:#fb923c;--green:#34d399;--asset:#cbd5e1;
      --sur:#8b5cf6;--life:#a78bfa;--fire:#ef4444;--fat:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;line-height:1.5}
    header{padding:16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:#0f172acc;backdrop-filter:blur(6px)}
    header h1{margin:0 0 4px 0;font-size:18px}
    header p{margin:0;color:var(--muted);font-size:12px}
    .wrap{display:grid;grid-template-columns:1fr;gap:12px;padding:12px;max-width:1200px;margin:0 auto}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .panel h2{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);font-size:14px;color:#cbd5e1;letter-spacing:0.4px}
    .grid{display:grid;grid-template-columns:1fr;gap:8px;padding:10px}
    .row{display:grid;grid-template-columns:1.2fr 1fr;gap:8px;align-items:center}
    label{font-size:12px;color:var(--muted)}
    input[type="number"],select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #2b3443;background:#0b1220;color:var(--ink);outline:none}
    .actions{display:flex;gap:8px;flex-wrap:wrap;padding:0 10px 10px}
    button{cursor:pointer;border:1px solid var(--line);background:#0b1220;color:#e5e7eb;padding:8px 12px;border-radius:10px}
    button.primary{background:#0ea5e9;border-color:#0284c7}
    .kpi{display:grid;grid-template-columns:1fr;gap:8px;padding:10px}
    .k{border:1px dashed #334155;border-radius:10px;padding:10px}
    .k h3{margin:0 0 8px 0;font-size:13px}
    .k p{margin:2px 0;font-size:12px;color:#cbd5e1}
    .ok{border-color:#14532d;background:rgba(34,197,94,0.08)}
    .warn{border-color:#7f1d1d;background:rgba(239,68,68,0.06)}
    .legend{font-size:12px;color:#cbd5e1;margin:6px 10px 0 10px}
    .legend span{display:inline-flex;align-items:center;margin-right:16px;white-space:nowrap}
    .legend i{display:inline-block;width:14px;height:3px;margin-right:6px;border-radius:2px}
    canvas{display:block;width:100%;height:420px}
    footer{padding:14px 12px;color:#9ca3af;font-size:12px;border-top:1px solid var(--line);text-align:center}
    @media(min-width:880px){
      .wrap{grid-template-columns:360px 1fr}
      .kpi{grid-template-columns:repeat(3,1fr)}
    }
  </style>
</head>
<body>
  <header>
    <h1>財務自由路徑試算｜FIRE Playground</h1>
    <p>輸入台幣金額與參數，系統即時計算：生存自由／生活自由／工作自由（副業≥主業）／FIRE／FAT FIRE 的達成時間與資產門檻。</p>
  </header>

  <main class="wrap">
    <section class="panel">
      <h2>輸入參數（NT$/月；年化%）</h2>
      <div class="grid">
        <div class="row"><label>生存支出</label><input id="survival" type="number" step="1000" value="60000"/></div>
        <div class="row"><label>生活支出</label><input id="lifestyle" type="number" step="1000" value="120000"/></div>
        <div class="row"><label>FAT FIRE 支出</label><input id="fat" type="number" step="1000" value="216000"/></div>
        <div class="row"><label>目前資產淨值</label><input id="assets" type="number" step="10000" value="3000000"/></div>
        <div class="row"><label>主業收入（月）</label><input id="mainIncome" type="number" step="1000" value="200000"/></div>
        <div class="row"><label>副業收入（月）</label><input id="sideIncome" type="number" step="1000" value="40000"/></div>
        <div class="row"><label>主業年成長率 %</label><input id="mainGrowth" type="number" step="0.1" value="3"/></div>
        <div class="row"><label>副業年成長率 %</label><input id="sideGrowth" type="number" step="0.1" value="10"/></div>
        <div class="row"><label>投資年化報酬 %</label><input id="returnRate" type="number" step="0.1" value="6"/></div>
        <div class="row"><label>提領率 % / 年</label><input id="wr" type="number" step="0.1" value="4"/></div>
        <div class="row"><label>模擬年數</label><input id="years" type="number" min="1" max="60" value="40"/></div>
      </div>
      <div class="actions">
        <button class="primary" id="calc">重新計算</button>
        <button id="fatfill">用生活 × 1.8 填入 FAT</button>
        <button id="share">分享參數連結</button>
        <button id="export">匯出 PNG</button>
        <button id="reset">重設</button>
      </div>
    </section>

    <section class="panel">
      <h2>里程碑總覽</h2>
      <div class="kpi" id="kpi"></div>
    </section>

    <section class="panel" id="chart1panel">
      <h2>現金流關係（月）</h2>
      <div class="legend" id="legend1"></div>
      <div style="padding:10px">
        <canvas id="cv1" height="420"></canvas>
      </div>
    </section>

    <section class="panel" id="chart2panel">
      <h2>資產增長模擬（三種生活路徑）</h2>
      <div class="legend" id="legend2"></div>
      <div style="padding:10px">
        <canvas id="cv2" height="420"></canvas>
      </div>
    </section>
  </main>

  <footer>
    ⚠️ 本工具僅供教育與財務規劃參考，非投資建議。所有金額以新台幣計算，採「月」為週期、年化率折算為月複利。
  </footer>

  <script>
    // ----- helpers -----
    const $ = s=>document.querySelector(s);
    const fmt = n=>'NT$'+Math.round(n).toLocaleString('zh-TW');
    const monthsToY = m => m===Infinity ? '尚未達成（模擬期內）' : (Math.floor(m/12)+' 年 '+(m%12? m%12+' 個月':''));
    const css = n=>getComputedStyle(document.documentElement).getPropertyValue(n).trim();

    // preset + URL params
    const defaults = {survival:60000, lifestyle:120000, fat:216000, assets:3000000, mainIncome:200000, sideIncome:40000, mainGrowth:3, sideGrowth:10, returnRate:6, wr:4, years:40};
    function applyParams(){
      const u = new URLSearchParams(location.search);
      let changed=false;
      for(const k in defaults){
        if(u.has(k)){ const el=document.getElementById(k); if(el){ el.value = u.get(k); changed=true; } }
      }
      return changed;
    }
    function shareLink(){
      const u = new URL(location.href);
      u.search='';
      const p = read();
      for(const k in p){ if(['years'].includes(k) || typeof p[k]==='number') u.searchParams.set(k, p[k]); }
      navigator.clipboard?.writeText(u.toString());
      alert('已複製分享連結：\\n'+u.toString());
    }

    // read inputs
    function read(){
      return {
        survival:+$('#survival').value||0,
        lifestyle:+$('#lifestyle').value||0,
        fat:+$('#fat').value||0,
        assets0:+$('#assets').value||0,
        main0:+$('#mainIncome').value||0,
        side0:+$('#sideIncome').value||0,
        gMain:(+$('#mainGrowth').value||0)/100,
        gSide:(+$('#sideGrowth').value||0)/100,
        r:(+$('#returnRate').value||0)/100,
        wr:(+$('#wr').value||0)/100,
        years:Math.max(1, Math.min(60, +$('#years').value||40)),
      };
    }

    // simulate
    function simulate(){
      const p = read();
      const months = p.years*12|0;
      const mG = Math.pow(1+p.gMain,1/12)-1;
      const sG = Math.pow(1+p.gSide,1/12)-1;
      const rM = Math.pow(1+p.r,1/12)-1;
      const wrM = p.wr/12;

      const L=[]; const main=[]; const sideOnly=[]; const total=[]; const passive=[];
      // asset paths for three spending scenarios
      const A0=p.assets0; let As=A0, Am=A0, Al=A0;
      const asset_sur=[], asset_mid=[], asset_life=[];

      const t = {survival:Infinity, life:Infinity, work:Infinity,
                 fire_s:Infinity, fire_m:Infinity, fire_l:Infinity,
                 fat_s:Infinity, fat_m:Infinity, fat_l:Infinity};

      for(let m=0;m<=months;m++){
        const ma = p.main0*Math.pow(1+mG,m);
        const si = p.side0*Math.pow(1+sG,m);
        const pa_s = As*wrM, pa_m = Am*wrM, pa_l = Al*wrM; // passive depends on each path's assets
        const to_s = ma+si+pa_s, to_m = ma+si+pa_m, to_l = ma+si+pa_l;

        L.push((m).toString()); // we'll label with integer years separately
        main.push(ma); sideOnly.push(si); total.push(ma+si+ (A0*wrM)); // total for display only (approx without path dependency)
        passive.push((As+Am+Al)/3*wrM); // show avg passive for first chart for sense

        // milestones (flow-based)
        if(t.survival===Infinity && si>=p.survival) t.survival=m;
        if(t.life===Infinity && (ma+si+((As+Am+Al)/3*wrM))>=p.lifestyle) t.life=m; // using avg passive to approximate
        if(t.work===Infinity && si>=ma) t.work=m;

        // assets update by scenarios
        // spending amounts:
        const spend_sur = p.survival;
        const spend_life= p.lifestyle;
        const spend_mid = (p.survival+p.lifestyle)/2;

        const save_s = Math.max(0, to_s - spend_sur);
        const save_m = Math.max(0, to_m - spend_mid);
        const save_l = Math.max(0, to_l - spend_life);

        As = As*(1+rM) + save_s;
        Am = Am*(1+rM) + save_m;
        Al = Al*(1+rM) + save_l;

        asset_sur.push(As); asset_mid.push(Am); asset_life.push(Al);

        // FIRE & FAT crossings per path
        const fireTarget=p.lifestyle*12/p.wr, fatTarget=p.fat*12/p.wr;
        if(t.fire_s===Infinity && As>=fireTarget) t.fire_s=m;
        if(t.fire_m===Infinity && Am>=fireTarget) t.fire_m=m;
        if(t.fire_l===Infinity && Al>=fireTarget) t.fire_l=m;
        if(t.fat_s===Infinity && As>=fatTarget) t.fat_s=m;
        if(t.fat_m===Infinity && Am>=fatTarget) t.fat_m=m;
        if(t.fat_l===Infinity && Al>=fatTarget) t.fat_l=m;
      }

      return {
        p,L,main,sideOnly,total,passive,
        asset_sur,asset_mid,asset_life,
        t,
        fireTarget:p.lifestyle*12/p.wr,
        fatTarget:p.fat*12/p.wr
      };
    }

    // KPI rendering
    function KPI(S){
      const el = $('#kpi');
      const K = [
        ['生存自由（副業 ≥ 生存）', S.t.survival, [['達成時間', monthsToY(S.t.survival)], ['副業月收', S.t.survival<Infinity? fmt(S.sideOnly[S.t.survival]):'—']]],
        ['生活自由（總收入 ≥ 生活）', S.t.life, [['達成時間', monthsToY(S.t.life)], ['總收入（約）', S.t.life<Infinity? fmt(S.main[S.t.life]+S.sideOnly[S.t.life]+S.passive?.[S.t.life]||0):'—']]],
        ['工作自由（副業 ≥ 主業）', S.t.work, [['達成時間', monthsToY(S.t.work)], ['副業', S.t.work<Infinity? fmt(S.sideOnly[S.t.work]):'—'], ['主業', S.t.work<Infinity? fmt(S.main[S.t.work]):'—']]],
        ['FIRE（資產 ≥ 生活/提領率）', Math.min(S.t.fire_s,S.t.fire_m,S.t.fire_l),
          [['達成時間（生存/中間/生活）',
            [S.t.fire_s,S.t.fire_m,S.t.fire_l].map(monthsToY).join(' ｜ ')],
           ['資產門檻', fmt(S.fireTarget)]]],
        ['FAT FIRE（資產 ≥ FAT/提領率）', Math.min(S.t.fat_s,S.t.fat_m,S.t.fat_l),
          [['達成時間（生存/中間/生活）',
            [S.t.fat_s,S.t.fat_m,S.t.fat_l].map(monthsToY).join(' ｜ ')],
           ['資產門檻', fmt(S.fatTarget)]]],
      ];
      el.innerHTML = K.map(([title,t,rows])=>{
        const cls = 'k ' + (t<Infinity? 'ok':'warn');
        const rs = rows.map(([k,v])=>`<p><span style="color:#9ca3af">${k}</span>　${v}</p>`).join('');
        return `<div class="${cls}"><h3>${title}</h3>${rs}</div>`;
      }).join('');
    }

    // ------- Chart 1: cash flows (no assets line here) -------
    function legend(container, items){
      container.innerHTML = items.map(([name,color,style])=>{
        const border = style==='dash' ? '2px dashed '+color : '2px solid '+color;
        return `<span><i style="background:${color};border:${border}"></i>${name}</span>`;
      }).join('');
    }

    function drawChart1(S){
      const cv = $('#cv1'); const dpr = Math.max(1, window.devicePixelRatio||1);
      const padLeft=84, padRight=24, padTop=22, padBot=38;
      const W = cv.clientWidth, H = cv.clientHeight;
      cv.width = W*dpr; cv.height = H*dpr;
      const ctx = cv.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,W,H);
      const plot = {x:padLeft, y:padTop, w:W-padLeft-padRight, h:H-padTop-padBot};

      const colors = {main:css('--blue'), side:css('--teal'), total:css('--orange'), passive:css('--green'), sur:css('--sur'), life:css('--life')};
      legend($('#legend1'), [['主業',colors.main],['副業',colors.side],['總收入（含平均被動）',colors.total],['被動（平均）',colors.passive],['生存支出',colors.sur,'dash'],['生活支出',colors.life,'dash']]);

      const leftSets = [
        {name:'主業', data:S.main, color:colors.main, w:2},
        {name:'副業', data:S.sideOnly, color:colors.side, w:2},
        {name:'總收入（含平均被動）', data:S.total, color:colors.total, w:2},
        {name:'被動（平均）', data:S.passive, color:colors.passive, w:2},
        {name:'生存支出', data:Array(S.main.length).fill(S.p.survival), color:colors.sur, dash:[6,4], w:1},
        {name:'生活支出', data:Array(S.main.length).fill(S.p.lifestyle), color:colors.life, dash:[6,4], w:1},
      ];
      const lMin=0, lMax=Math.max(...leftSets.flatMap(s=>s.data));
      const xPos = i => plot.x + plot.w * (i/(S.main.length-1));
      const yLeft = v => plot.y + plot.h * (1 - (v-lMin)/(lMax-lMin||1));

      // grids & integer-year ticks
      ctx.strokeStyle='#1f2937'; ctx.lineWidth=1; ctx.font='11px system-ui'; ctx.fillStyle='#9ca3af';
      const years = S.p.years;
      for(let i=0;i<=5;i++){
        const y = plot.y + plot.h*(1 - i/5);
        ctx.beginPath(); ctx.moveTo(plot.x, y); ctx.lineTo(plot.x+plot.w, y); ctx.stroke();
        const lv = lMin + (lMax-lMin)*i/5;
        ctx.fillText('NT$'+Math.round(lv).toLocaleString('zh-TW'), 6, y+4);
      }
      for(let y=0;y<=years;y++){
        const i = Math.round(S.main.length * (y/years));
        const x = plot.x + plot.w * (y/years);
        ctx.fillText(y+'y', x-8, H-12);
        ctx.beginPath(); ctx.moveTo(x, plot.y+plot.h); ctx.lineTo(x, plot.y+plot.h+4); ctx.stroke();
      }

      function line(set){
        ctx.beginPath();
        set.data.forEach((v,i)=>{ const x=xPos(i), y=yLeft(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
        ctx.lineWidth=set.w; ctx.setLineDash(set.dash||[]); ctx.strokeStyle=set.color; ctx.stroke(); ctx.setLineDash([]);
      }
      leftSets.forEach(line);

      // marker for work freedom
      if(S.t.work<Infinity){
        const x = xPos(S.t.work), y = yLeft(S.sideOnly[S.t.work]);
        ctx.fillStyle=colors.side; ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='#cbd5e1'; ctx.fillText('工作自由（副≥主）', x+6,y-6);
      }
    }

    // ------- Chart 2: assets for three spending paths -------
    function drawChart2(S){
      const cv = $('#cv2'); const dpr = Math.max(1, window.devicePixelRatio||1);
      const padLeft=84, padRight=120, padTop=22, padBot=38;
      const W = cv.clientWidth, H = cv.clientHeight;
      cv.width = W*dpr; cv.height = H*dpr;
      const ctx = cv.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,W,H);
      const plot = {x:padLeft, y:padTop, w:W-padLeft-padRight, h:H-padTop-padBot};

      const colors = {sur:'#7dd3fc', mid:'#60a5fa', life:'#1d4ed8', asset:css('--asset'), fire:css('--fire'), fat:css('--fat')};
      legend($('#legend2'), [['資產（生存支出路徑）',colors.sur],['資產（中間支出路徑）',colors.mid],['資產（生活支出路徑）',colors.life],['FIRE 資產門檻',colors.fire,'dash'],['FAT FIRE 資產門檻',colors.fat,'dash']]);

      const rightSets = [
        {name:'資產（生存）', data:S.asset_sur, color:colors.sur, w:2},
        {name:'資產（中間）', data:S.asset_mid, color:colors.mid, w:2},
        {name:'資產（生活）', data:S.asset_life, color:colors.life, w:2},
        {name:'FIRE門檻', data:Array(S.asset_sur.length).fill(S.fireTarget), color:colors.fire, dash:[4,4], w:1.2},
        {name:'FAT門檻', data:Array(S.asset_sur.length).fill(S.fatTarget), color:colors.fat, dash:[4,4], w:1.2}
      ];
      const rMin=0, rMax=Math.max(...rightSets.flatMap(s=>s.data));
      const xPos = i => plot.x + plot.w * (i/(S.asset_sur.length-1));
      const yRight = v => plot.y + plot.h * (1 - (v-rMin)/(rMax-rMin||1));

      // grids & integer-year ticks
      ctx.strokeStyle='#1f2937'; ctx.lineWidth=1; ctx.font='11px system-ui'; ctx.fillStyle='#9ca3af';
      for(let i=0;i<=5;i++){
        const y = plot.y + plot.h*(1 - i/5);
        ctx.beginPath(); ctx.moveTo(plot.x, y); ctx.lineTo(plot.x+plot.w, y); ctx.stroke();
        const rv = rMin + (rMax-rMin)*i/5;
        ctx.fillText('資產 NT$'+Math.round(rv).toLocaleString('zh-TW'), plot.x+plot.w+6, y+4);
      }
      const years = S.p.years;
      for(let y=0;y<=years;y++){
        const x = plot.x + plot.w * (y/years);
        ctx.fillText(y+'y', x-8, H-12);
        ctx.beginPath(); ctx.moveTo(x, plot.y+plot.h); ctx.lineTo(x, plot.y+plot.h+4); ctx.stroke();
      }

      function line(set){
        ctx.beginPath();
        set.data.forEach((v,i)=>{ const x=xPos(i), y=yRight(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
        ctx.lineWidth=set.w; ctx.setLineDash(set.dash||[]); ctx.strokeStyle=set.color; ctx.stroke(); ctx.setLineDash([]);
      }
      rightSets.forEach(line);

      // markers for FIRE/FAT per path
      const pts=[
        ['fire_s','資產（生存）',colors.sur, S.asset_sur],
        ['fire_m','資產（中間）',colors.mid, S.asset_mid],
        ['fire_l','資產（生活）',colors.life, S.asset_life],
        ['fat_s','資產（生存）',colors.sur, S.asset_sur, true],
        ['fat_m','資產（中間）',colors.mid, S.asset_mid, true],
        ['fat_l','資產（生活）',colors.life, S.asset_life, true],
      ];
      pts.forEach(([key,label,color,arr,isFat])=>{
        const m = S.t[key];
        if(m<Infinity){
          const x=xPos(m), y=yRight(arr[m]);
          ctx.fillStyle=color; ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
          ctx.fillStyle='#cbd5e1';
          ctx.fillText((isFat?'FAT ':'FIRE ')+label+' 達成', x+6,y-6);
        }
      });
    }

    function run(){
      const S = simulate();
      KPI(S); drawChart1(S); drawChart2(S);
      window.currentState = S; // for export
    }

    // export two canvases + KPI summary into one PNG
    function exportPNG(){
      const S = window.currentState || simulate();
      const c1 = $('#cv1'), c2 = $('#cv2');
      const w = Math.max(c1.width, c2.width)/ (window.devicePixelRatio||1);
      const h = (c1.height + c2.height)/ (window.devicePixelRatio||1);
      const extra = 160; // header + KPI text
      const dpr = Math.max(1, window.devicePixelRatio||1);
      const cv = document.createElement('canvas');
      cv.width = w*dpr; cv.height = (h+extra)*dpr;
      const ctx = cv.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);

      // bg
      ctx.fillStyle = getComputedStyle(document.body).backgroundColor; ctx.fillRect(0,0,w,h+extra);
      // header
      ctx.fillStyle='#e5e7eb'; ctx.font='16px system-ui'; ctx.fillText('財務自由路徑試算｜FIRE Playground', 12, 24);
      ctx.font='12px system-ui'; ctx.fillStyle='#9ca3af';
      ctx.fillText('分享自：eaglish.store', 12, 44);

      // KPI snippet
      ctx.fillStyle='#cbd5e1'; ctx.font='12px system-ui';
      const lines=[
        '里程碑：',
        `• 生存自由：${monthsToY(S.t.survival)}`,
        `• 生活自由：${monthsToY(S.t.life)}`,
        `• 工作自由（副≥主）：${monthsToY(S.t.work)}`,
        `• FIRE（生/中/生）：${[S.t.fire_s,S.t.fire_m,S.t.fire_l].map(monthsToY).join(' ｜ ')}`,
        `• FAT（生/中/生）：${[S.t.fat_s,S.t.fat_m,S.t.fat_l].map(monthsToY).join(' ｜ ')}`
      ];
      let y=66; lines.forEach(t=>{ ctx.fillText(t,12,y); y+=16; });

      // draw canvases
      ctx.drawImage(c1, 0, extra, w, c1.height/dpr);
      ctx.drawImage(c2, 0, extra + c1.height/dpr, w, c2.height/dpr);

      const url = cv.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url; a.download = 'fire_result.png'; a.click();
    }

    // actions
    $('#calc').addEventListener('click', run);
    $('#fatfill').addEventListener('click', ()=>{$('#fat').value=Math.round((+$('#lifestyle').value||0)*1.8); run();});
    $('#reset').addEventListener('click', ()=>{ for(const k in defaults){ const el = document.getElementById(k); if(!el) continue; el.value = defaults[k]; } run();});
    $('#share').addEventListener('click', shareLink);
    $('#export').addEventListener('click', exportPNG);
    window.addEventListener('resize', run, {passive:true});

    applyParams(); run();
  </script>
</body>
</html>