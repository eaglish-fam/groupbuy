<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>財務自由路徑試算｜FIRE Playground</title>
<style>
  :root{
    --bg:#0f172a;--panel:#111827;--ink:#e5e7eb;--muted:#9ca3af;--line:#1f2937;
    --blue:#60a5fa;--teal:#22d3ee;--orange:#fb923c;--green:#34d399;--asset:#cbd5e1;
    --sur:#8b5cf6;--life:#a78bfa;--fire:#ef4444;--fat:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC;line-height:1.5}
  header{padding:16px 12px 8px;border-bottom:1px solid var(--line)}
  header h1{margin:0 0 6px 0;font-size:20px;text-align:center}
  header p{margin:0;color:var(--muted);font-size:12px;text-align:center}
  main{max-width:1200px;margin:0 auto;padding:12px;display:grid;gap:12px;grid-template-columns:360px 1fr}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .panel h2{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);font-size:14px;color:#cbd5e1}
  .grid{display:grid;grid-template-columns:1fr;gap:8px;padding:10px}
  .row{display:grid;grid-template-columns:1.2fr 1fr;gap:8px;align-items:center}
  label{font-size:12px;color:var(--muted)}
  input[type="number"],select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #2b3443;background:#0b1220;color:var(--ink)}
  .actions{display:flex;gap:8px;flex-wrap:wrap;padding:0 10px 10px}
  button{cursor:pointer;border:1px solid var(--line);background:#0b1220;color:#e5e7eb;padding:8px 12px;border-radius:10px}
  button.primary{background:#0ea5e9;border-color:#0284c7}
  .kpi{display:grid;grid-template-columns:1fr;gap:8px;padding:10px}
  .k{border:1px dashed #334155;border-radius:10px;padding:10px}
  .k.ok{border-color:#14532d;background:rgba(34,197,94,0.08)}
  .k.warn{border-color:#7f1d1d;background:rgba(239,68,68,0.06)}
  .k h3{margin:0 0 6px 0;font-size:13px}
  .k p{margin:2px 0;font-size:12px;color:#cbd5e1}
  .charts{display:grid;grid-template-columns:1fr;gap:12px;padding:10px}
  .chartbox{border:1px solid var(--line);border-radius:12px;padding:10px;position:relative}
  .chartbox h3{margin:0 0 6px 0;font-size:13px;color:#cbd5e1}
  .chart-wrapper{position:relative;width:100%;overflow:hidden}
  canvas{display:block;width:100%;height:380px;touch-action:pan-y}
  footer{max-width:1200px;margin:8px auto 20px;color:#9ca3af;text-align:center;font-size:12px}
  .back-home{text-align:center;margin:20px auto;max-width:1200px}
  .back-home a{display:inline-block;padding:12px 24px;background:#0ea5e9;color:white;text-decoration:none;border-radius:10px;font-size:14px;border:1px solid #0284c7}
  .back-home a:hover{background:#0284c7}
  .tooltip{position:fixed;background:rgba(17,24,39,0.95);border:1px solid var(--line);border-radius:8px;padding:8px 12px;font-size:11px;pointer-events:none;display:none;z-index:1000;color:var(--ink);white-space:nowrap;max-width:90vw}
  .tooltip-row{margin:2px 0}
  .tooltip-label{color:var(--muted);margin-right:8px}
  @media(max-width:900px){ 
    main{grid-template-columns:1fr}
    canvas{height:320px}
    .chartbox{padding:8px}
    .chartbox h3{font-size:12px}
    header h1{font-size:18px}
    header p{font-size:11px}
  }
</style>
</head>
<body>
<header>
  <h1>財務自由路徑試算｜FIRE Playground</h1>
  <p>輸入台幣金額與參數，系統即時計算：「生存/生活/工作自由」與 FIRE / FAT FIRE 的達成門檻與趨勢。</p>
</header>

<main>
  <section class="panel">
    <h2>輸入參數（NT$/月；年化%）</h2>
    <div class="grid">
      <div class="row"><label>生存支出</label><input id="survival" type="number" step="1000" value="60000"/></div>
      <div class="row"><label>生活支出</label><input id="lifestyle" type="number" step="1000" value="120000"/></div>
      <div class="row"><label>FAT FIRE 支出</label><input id="fat" type="number" step="1000" value="216000"/></div>
      <div class="row"><label>目前資產淨值</label><input id="assets" type="number" step="10000" value="3000000"/></div>
      <div class="row"><label>主業收入（月）</label><input id="mainIncome" type="number" step="1000" value="200000"/></div>
      <div class="row"><label>副業收入（月）</label><input id="sideIncome" type="number" step="1000" value="40000"/></div>
      <div class="row"><label>主業年成長率 %</label><input id="mainGrowth" type="number" step="0.1" value="3"/></div>
      <div class="row"><label>副業年成長率 %</label><input id="sideGrowth" type="number" step="0.1" value="10"/></div>
      <div class="row"><label>投資年化報酬 %</label><input id="returnRate" type="number" step="0.1" value="6"/></div>
      <div class="row"><label>提領率 % / 年</label><input id="wr" type="number" step="0.1" value="4"/></div>
      <div class="row"><label>模擬年數</label><input id="years" type="number" min="1" max="60" value="30"/></div>
      <div class="row"><label>盈餘全部投入？</label>
        <select id="reinvest"><option value="yes" selected>是</option><option value="no">否</option></select>
      </div>
    </div>
    <div class="actions">
      <button class="primary" id="calc">重新計算</button>
      <button id="fatfill">用生活 × 1.8 填入 FAT</button>
      <button id="share">分享參數連結</button>
      <button id="savepng">下載結果 PNG</button>
      <button id="reset">重設為預設值</button>
    </div>
    <div class="kpi" id="kpi"></div>
  </section>

  <section class="panel">
    <h2>圖表</h2>
    <div class="charts">
      <div class="chartbox">
        <h3>現金流趨勢（主業 / 副業 / 總收入 vs 生存/生活）</h3>
        <div class="chart-wrapper">
          <canvas id="cvCash"></canvas>
        </div>
        <div class="tooltip" id="tooltipCash"></div>
      </div>
      <div class="chartbox">
        <h3>資產增長模擬（三條支出路徑）</h3>
        <div class="chart-wrapper">
          <canvas id="cvAsset"></canvas>
        </div>
        <div class="tooltip" id="tooltipAsset"></div>
      </div>
    </div>
  </section>
</main>

<div class="back-home">
  <a href="https://www.eaglish.store">回團購首頁</a>
</div>

<footer>⚠️ 本工具僅供教育與財務規劃參考，非投資建議。所有金額以新台幣計算，採「月」為週期、年化率折算為月複利。</footer>

<script>
const $ = s=>document.querySelector(s);
const css = n=>getComputedStyle(document.documentElement).getPropertyValue(n).trim();
const C = {
  blue:css('--blue'), teal:css('--teal'), orange:css('--orange'), green:css('--green'), asset:css('--asset'),
  sur:css('--sur'), life:css('--life'), fire:css('--fire'), fat:css('--fat')
};

// 改進的格式化函數：使用萬、百萬、千萬、億
function fmt(n){
  n = Math.round(n);
  if(n >= 100000000) return 'NT$' + (n/100000000).toFixed(1) + '億';
  if(n >= 10000000) return 'NT$' + (n/10000000).toFixed(1) + '千萬';
  if(n >= 1000000) return 'NT$' + (n/1000000).toFixed(1) + '百萬';
  if(n >= 10000) return 'NT$' + (n/10000).toFixed(1) + '萬';
  return 'NT$' + n.toLocaleString('zh-TW');
}

// Y軸標籤格式化
function fmtAxis(n){
  n = Math.round(n);
  if(n >= 100000000) return (n/100000000).toFixed(0) + '億';
  if(n >= 10000000) return (n/10000000).toFixed(0) + '千萬';
  if(n >= 1000000) return (n/1000000).toFixed(0) + '百萬';
  if(n >= 10000) return (n/10000).toFixed(0) + '萬';
  return n.toLocaleString('zh-TW');
}

const monthsToText = m => m===Infinity ? '尚未達成（模擬期內）' : (Math.floor(m/12)+' 年 '+(m%12? m%12+' 個月':''));

const defaults = {survival:60000,lifestyle:120000,fat:216000,assets:3000000,mainIncome:200000,sideIncome:40000,mainGrowth:3,sideGrowth:10,returnRate:6,wr:4,years:30,reinvest:'yes'};

// ---- URL 參數讀寫 ----
function readFromUI(){
  return {
    survival:+$('#survival').value||0,
    lifestyle:+$('#lifestyle').value||0,
    fat:+$('#fat').value||0,
    assets0:+$('#assets').value||0,
    main0:+$('#mainIncome').value||0,
    side0:+$('#sideIncome').value||0,
    gMain:(+$('#mainGrowth').value||0)/100,
    gSide:(+$('#sideGrowth').value||0)/100,
    r:(+$('#returnRate').value||0)/100,
    wr:(+$('#wr').value||0)/100,
    years:Math.max(1, Math.min(60, +$('#years').value||30)),
    reinvest: $('#reinvest').value==='yes'
  };
}
function applyQuery(){
  const url = new URL(location.href);
  const q = url.searchParams;
  for(const k in defaults){
    if(q.has(k)){
      const el = document.getElementById(k);
      if(el) el.value = q.get(k);
    }
  }
}
function shareLink(){
  const url = new URL(location.href);
  const p = readFromUI();
  for(const k in defaults){ url.searchParams.set(k, p[k]); }
  navigator.clipboard.writeText(url.toString());
  alert('參數連結已複製到剪貼簿！');
}

// ---- 數據模擬 ----
function simulate(){
  const p = readFromUI();
  const months = p.years*12|0;
  const mG = Math.pow(1+p.gMain,1/12)-1;
  const sG = Math.pow(1+p.gSide,1/12)-1;
  const rM = Math.pow(1+p.r,1/12)-1;

  const L=[], main=[], side=[], total=[],  // 現金流（不含被動）
        A_surv=[], A_life=[], A_mid=[];    // 三條資產路徑
  const t = {survival:Infinity, life:Infinity, work:Infinity, fire:Infinity, fat:Infinity};

  let A1=p.assets0, A2=p.assets0, A3=p.assets0;

  for(let m=0;m<=months;m++){
    const ma = p.main0*Math.pow(1+mG,m);
    const si = p.side0*Math.pow(1+sG,m);
    const tot = ma+si;

    L.push((m/12)); main.push(ma); side.push(si); total.push(tot);

    // 里程碑（以現金流定義）
    if(t.survival===Infinity && si>=p.survival) t.survival=m;
    if(t.life===Infinity && tot>=p.lifestyle) t.life=m;
    if(t.work===Infinity && si>=ma) t.work=m;

    // 三種支出下的盈餘（僅投資盈餘；不計被動現金流）
    const spend_surv = p.survival;
    const spend_life = p.lifestyle;
    const spend_mid  = (p.survival + p.lifestyle)/2;

    const c1 = p.reinvest ? Math.max(0, tot - spend_surv) : 0;
    const c2 = p.reinvest ? Math.max(0, tot - spend_life) : 0;
    const c3 = p.reinvest ? Math.max(0, tot - spend_mid ) : 0;

    if(m===0){ A_surv.push(A1); A_life.push(A2); A_mid.push(A3); }
    else{
      A1 = A1*(1+rM) + c1;
      A2 = A2*(1+rM) + c2;
      A3 = A3*(1+rM) + c3;
      A_surv.push(A1); A_life.push(A2); A_mid.push(A3);
    }
  }
  const fireTarget = p.lifestyle*12/p.wr;
  const fatTarget  = p.fat*12/p.wr;
  // FIRE 達成時間：以「生活支出路徑」資產為準
  t.fire = A_life.findIndex(v=>v>=fireTarget); if(t.fire<0) t.fire=Infinity;
  t.fat  = A_life.findIndex(v=>v>=fatTarget); if(t.fat<0) t.fat=Infinity;

  return {p, L, main, side, total, A_surv, A_life, A_mid, t, fireTarget, fatTarget};
}

// ---- KPI ----
function renderKPI(S){
  const el = $('#kpi');
  const K = [
    ['生存自由（副業 ≥ 生存）', S.t.survival, [['達成時間', monthsToText(S.t.survival)], ['達成時副業', S.t.survival<Infinity? fmt(S.side[S.t.survival]):'—']]],
    ['生活自由（總收入 ≥ 生活）', S.t.life, [['達成時間', monthsToText(S.t.life)], ['達成時總收入', S.t.life<Infinity? fmt(S.total[S.t.life]):'—']]],
    ['工作自由（副業 ≥ 主業）', S.t.work, [['達成時間', monthsToText(S.t.work)], ['副業', S.t.work<Infinity? fmt(S.side[S.t.work]):'—'], ['主業', S.t.work<Infinity? fmt(S.main[S.t.work]):'—']]],
    ['財富自由 FIRE（資產 ≥ 生活/提領率）', S.t.fire, [['達成時間', monthsToText(S.t.fire)], ['資產門檻', fmt(S.fireTarget)], ['達成時資產', S.t.fire<Infinity? fmt(S.A_life[S.t.fire]):'—']]],
    ['財富豐盛 FAT FIRE（資產 ≥ FAT/提領率）', S.t.fat, [['達成時間', monthsToText(S.t.fat)], ['資產門檻', fmt(S.fatTarget)], ['達成時資產', S.t.fat<Infinity? fmt(S.A_life[S.t.fat]):'—']]],
  ];
  el.innerHTML = K.map(([title,t,rows])=>{
    const cls = 'k ' + (t<Infinity? 'ok':'warn');
    const rs = rows.map(([k,v])=>`<p><span style="color:#9ca3af">${k}</span>　${v}</p>`).join('');
    return `<div class="${cls}"><h3>${title}</h3>${rs}</div>`;
  }).join('');
}

// ---- 繪圖工具 ----
function niceMax(max){
  if(max<=0) return 1;
  const pow = Math.pow(10, Math.floor(Math.log10(max)));
  const n = max/pow;
  const base = n<=1?1:n<=2?2:n<=5?5:10;
  return base*pow;
}
function drawLine(ctx, points, color, width=2, dash=null){
  ctx.save();
  ctx.lineWidth=width; ctx.strokeStyle=color; ctx.beginPath();
  if(dash) ctx.setLineDash(dash);
  points.forEach(([x,y],i)=>{ if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.stroke(); ctx.setLineDash([]); ctx.restore();
}

// Tooltip state
let currentTooltip = {canvas: null, tooltip: null, data: null};

function drawChart(canvas, tooltipEl, series, opts){
  // Get actual container width
  const container = canvas.parentElement;
  const isMobile = window.innerWidth <= 900;
  
  // Use container's actual width
  const baseWidth = container.clientWidth;
  const baseHeight = isMobile ? 320 : 380;
  
  // Set canvas size to match container
  canvas.style.width = '100%';
  canvas.style.height = baseHeight + 'px';
  
  // Set internal resolution for sharp rendering
  const dpr = Math.min(2, window.devicePixelRatio || 1); // Cap at 2 for performance
  canvas.width = baseWidth * dpr;
  canvas.height = baseHeight * dpr;
  
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.clearRect(0, 0, baseWidth, baseHeight);
  
  // Adaptive padding based on screen size
  const padL = isMobile ? 50 : 70;
  const padR = isMobile ? 20 : 40;
  const padT = isMobile ? 45 : 30;
  const padB = isMobile ? 35 : 40;
  const plot = {x: padL, y: padT, w: baseWidth - padL - padR, h: baseHeight - padT - padB};

  // X scale
  const N = series[0].data.length;
  const xPos = i => plot.x + plot.w * (i / (N - 1));

  // X-axis ticks - adaptive based on available width
  const yearsTotal = opts.years;
  let step;
  if(isMobile){
    step = yearsTotal <= 10 ? 2 : (yearsTotal <= 20 ? 5 : 10);
  } else {
    step = yearsTotal <= 10 ? 1 : (yearsTotal <= 20 ? 2 : 5);
  }

  // Y scale
  let yMax = 0;
  series.forEach(s => s.data.forEach(v => { if(v > yMax) yMax = v; }));
  if(opts.extraMax) yMax = Math.max(yMax, ...opts.extraMax);
  yMax = niceMax(yMax);
  const yPos = v => plot.y + plot.h * (1 - v / yMax);

  // Grid and axes
  ctx.strokeStyle = '#1f2937';
  ctx.lineWidth = 1;
  ctx.font = isMobile ? '9px system-ui' : '11px system-ui';
  ctx.fillStyle = '#9ca3af';
  ctx.textAlign = 'right';
  ctx.textBaseline = 'middle';
  
  // Y-axis grid and labels
  for(let i = 0; i <= 5; i++){
    const y = plot.y + plot.h * (1 - i / 5);
    ctx.beginPath();
    ctx.moveTo(plot.x, y);
    ctx.lineTo(plot.x + plot.w, y);
    ctx.stroke();
    const val = yMax * i / 5;
    ctx.fillText(fmtAxis(val), padL - 5, y);
  }
  
  // X-axis labels
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  for(let y = 0; y <= yearsTotal; y += step){
    const i = Math.round(N * y / yearsTotal);
    const x = xPos(i);
    if(x >= plot.x && x <= plot.x + plot.w){
      ctx.fillText(y + '年', x, baseHeight - padB + 5);
    }
  }

  // Draw series lines
  series.forEach(s => {
    const pts = s.data.map((v, i) => [xPos(i), yPos(v)]);
    drawLine(ctx, pts, s.color, s.w || 2, s.dash || null);
  });

  // Horizontal threshold labels
  if(opts.hLines){
    ctx.save();
    ctx.font = isMobile ? '10px system-ui' : '12px system-ui';
    ctx.fillStyle = '#cbd5e1';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'bottom';
    
    opts.hLines.forEach(h => {
      const y = yPos(h.y);
      drawLine(ctx, [[plot.x, y], [plot.x + plot.w, y]], h.color, 1.5, [6, 6]);
      ctx.fillText(h.label, plot.x + 3, y - 4);
    });
    ctx.restore();
  }

  // Legend - adaptive layout
  ctx.save();
  ctx.textAlign = 'left';
  ctx.textBaseline = 'top';
  ctx.font = isMobile ? '9px system-ui' : '10px system-ui';
  
  let lx = plot.x;
  let ly = plot.y - (isMobile ? 38 : 24);
  const legendItemSpacing = isMobile ? 4 : 8;
  const legendLineHeight = isMobile ? 12 : 14;
  
  series.forEach((s, idx) => {
    const text = s.name;
    const textWidth = ctx.measureText(text).width;
    const itemWidth = 14 + legendItemSpacing + textWidth + 12; // box + spacing + text + gap
    
    // Wrap to next line if needed (mobile only)
    if(isMobile && idx > 0 && lx + itemWidth > plot.x + plot.w){
      lx = plot.x;
      ly += legendLineHeight;
    }
    
    // Draw legend item
    ctx.fillStyle = s.color;
    ctx.fillRect(lx, ly + 3, 12, 2);
    ctx.fillStyle = '#cbd5e1';
    ctx.fillText(text, lx + 14 + legendItemSpacing, ly);
    
    lx += itemWidth;
  });
  ctx.restore();

  // Store data for tooltip
  currentTooltip = {
    canvas: canvas,
    tooltip: tooltipEl,
    data: {series, plot, xPos, yPos, N, yearsTotal, yMax, baseWidth, baseHeight}
  };
}

// Tooltip handler
function setupTooltip(canvas, tooltipEl){
  function handleMove(e){
    if(!currentTooltip.data || currentTooltip.canvas !== canvas) return;
    
    const rect = canvas.getBoundingClientRect();
    const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
    const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
    
    const x = clientX - rect.left;
    const y = clientY - rect.top;
    const {series, plot, xPos, N, yearsTotal} = currentTooltip.data;
    
    // Check if inside plot area
    if(x < plot.x || x > plot.x + plot.w || y < plot.y || y > plot.y + plot.h){
      tooltipEl.style.display = 'none';
      return;
    }
    
    // Find nearest data point
    let nearestIdx = 0;
    let minDist = Infinity;
    for(let i = 0; i < N; i++){
      const dist = Math.abs(xPos(i) - x);
      if(dist < minDist){
        minDist = dist;
        nearestIdx = i;
      }
    }
    
    // Build tooltip content
    const year = Math.floor(nearestIdx / 12);
    let html = `<div class="tooltip-row"><span class="tooltip-label">年份：</span>${year}年</div>`;
    series.forEach(s => {
      if(!s.dash){ // Only show non-dashed lines in tooltip
        html += `<div class="tooltip-row"><span class="tooltip-label" style="color:${s.color}">${s.name}：</span>${fmt(s.data[nearestIdx])}</div>`;
      }
    });
    
    tooltipEl.innerHTML = html;
    tooltipEl.style.display = 'block';
    
    // Position tooltip - adjust for screen edges
    let tooltipX = clientX + 15;
    let tooltipY = clientY - 10;
    
    // Prevent tooltip from going off screen
    const tooltipRect = tooltipEl.getBoundingClientRect();
    if(tooltipX + tooltipRect.width > window.innerWidth){
      tooltipX = clientX - tooltipRect.width - 15;
    }
    if(tooltipY + tooltipRect.height > window.innerHeight){
      tooltipY = clientY - tooltipRect.height - 10;
    }
    if(tooltipY < 0) tooltipY = clientY + 20;
    
    tooltipEl.style.left = tooltipX + 'px';
    tooltipEl.style.top = tooltipY + 'px';
  }
  
  function handleLeave(){
    tooltipEl.style.display = 'none';
  }
  
  canvas.addEventListener('mousemove', handleMove);
  canvas.addEventListener('touchmove', (e) => {
    handleMove(e);
  }, {passive: true});
  canvas.addEventListener('mouseleave', handleLeave);
  canvas.addEventListener('touchend', handleLeave);
  canvas.addEventListener('touchcancel', handleLeave);
}

// ---- 主流程 ----
function run(){
  const S = simulate();
  renderKPI(S);

  // 現金流圖
  const cashSeries = [
    {name:'主業收入', color:C.blue, data:S.main},
    {name:'副業收入', color:C.teal, data:S.side},
    {name:'總收入',   color:C.orange, data:S.total},
    {name:'生存支出', color:C.sur, data:Array(S.L.length).fill(S.p.survival), dash:[6,6], w:1.5},
    {name:'生活支出', color:C.life, data:Array(S.L.length).fill(S.p.lifestyle), dash:[6,6], w:1.5},
  ];
  drawChart($('#cvCash'), $('#tooltipCash'), cashSeries, {years:S.p.years});

  // 資產圖（三條路徑）
  const assetSeries = [
    {name:'資產（生存支出路徑）', color:C.green, data:S.A_surv},
    {name:'資產（中間支出路徑）', color:'#7aa2ff', data:S.A_mid},
    {name:'資產（生活支出路徑）', color:C.blue, data:S.A_life},
  ];
  drawChart($('#cvAsset'), $('#tooltipAsset'), assetSeries, {
    years:S.p.years,
    extraMax:[S.fireTarget,S.fatTarget],
    hLines:[
      {y:S.fireTarget, label:'FIRE', color:C.fire},
      {y:S.fatTarget,  label:'FAT FIRE', color:C.fat}
    ]
  });
}

// PNG 合併下載
function savePNG(){
  const c1=$('#cvCash'), c2=$('#cvAsset');
  const out = document.createElement('canvas');
  const W = Math.max(c1.width, c2.width)/ (window.devicePixelRatio||1);
  const H = (c1.height + c2.height)/ (window.devicePixelRatio||1) + 60;
  out.width = W*(window.devicePixelRatio||1); out.height = H*(window.devicePixelRatio||1);
  const ctx = out.getContext('2d'); ctx.setTransform(window.devicePixelRatio||1,0,0,window.devicePixelRatio||1,0,0);
  ctx.fillStyle = getComputedStyle(document.body).backgroundColor || '#0f172a';
  ctx.fillRect(0,0,W,H);
  ctx.drawImage(c1,0,0,c1.width/(window.devicePixelRatio||1),c1.height/(window.devicePixelRatio||1));
  ctx.drawImage(c2,0,c1.height/(window.devicePixelRatio||1)+60,c2.width/(window.devicePixelRatio||1),c2.height/(window.devicePixelRatio||1));
  const a=document.createElement('a'); a.download='fire_result.png'; a.href=out.toDataURL('image/png'); a.click();
}

// 事件
$('#calc').addEventListener('click', run);
$('#fatfill').addEventListener('click', ()=>{$('#fat').value=Math.round((+$('#lifestyle').value||0)*1.8); run();});
$('#share').addEventListener('click', shareLink);
$('#savepng').addEventListener('click', savePNG);
$('#reset').addEventListener('click', ()=>{ for(const k in defaults){ const el=document.getElementById(k); if(el) el.value=defaults[k]; } run(); });

// Debounced resize handler for better performance
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(run, 150);
}, {passive: true});

// Setup tooltips
setupTooltip($('#cvCash'), $('#tooltipCash'));
setupTooltip($('#cvAsset'), $('#tooltipAsset'));

applyQuery();
run();
</script>
</body>
</html>
