<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鷹家 - 圖片載入 Debug 工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .section h2 {
            color: #666;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .info-box {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #4CAF50;
        }
        
        .error-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #ff9800;
        }
        
        .success-box {
            background: #d4edda;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
        }
        
        .code {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .test-image {
            max-width: 300px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #4CAF50;
            color: white;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .status-ok {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .loading {
            display: inline-block;
            margin-left: 10px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 鷹家 Fun生買物社 - 圖片載入 Debug 工具</h1>
        
        <!-- 步驟 1: 載入資料 -->
        <div class="section">
            <h2>步驟 1: 檢查 Google Sheets 連接</h2>
            <button onclick="loadData()">🔄 載入 Google Sheets 資料</button>
            <span id="loadingIndicator" class="loading hidden">載入中...</span>
            <div id="sheetStatus"></div>
        </div>
        
        <!-- 步驟 2: 欄位檢查 -->
        <div class="section">
            <h2>步驟 2: 檢查欄位名稱</h2>
            <div id="columnCheck"></div>
        </div>
        
        <!-- 步驟 3: 圖片資料 -->
        <div class="section">
            <h2>步驟 3: 檢查圖片資料</h2>
            <div id="imageData"></div>
        </div>
        
        <!-- 步驟 4: 圖片測試 -->
        <div class="section">
            <h2>步驟 4: 測試圖片載入</h2>
            <button onclick="testImages()">🖼️ 測試所有圖片</button>
            <div id="imageTest"></div>
        </div>
        
        <!-- 步驟 5: 建議 -->
        <div class="section">
            <h2>步驟 5: 修正建議</h2>
            <div id="suggestions"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        const SHEET_ID = '1-RuyD9eCkrDpgFFXGHRWaTF-LYKaDK-MxAw3uNMozeU';
        let sheetsData = [];
        let columns = [];
        
        async function loadData() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const statusDiv = document.getElementById('sheetStatus');
            
            loadingIndicator.classList.remove('hidden');
            statusDiv.innerHTML = '';
            
            try {
                const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
                const response = await fetch(CSV_URL, { credentials: 'omit' });
                const csvText = await response.text();
                
                // 檢查是否是 HTML（表示存取被拒）
                if (csvText.includes('<!DOCTYPE') || csvText.includes('<html')) {
                    statusDiv.innerHTML = `
                        <div class="error-box">
                            <strong>❌ 錯誤：無法存取 Google Sheets</strong>
                            <p>您的 Google Sheets 權限設定為「限制」</p>
                            <p><strong>解決方法：</strong></p>
                            <ol>
                                <li>開啟 Google Sheets</li>
                                <li>點擊右上角「共用」</li>
                                <li>一般存取權改為：<strong>「知道連結的任何人」</strong></li>
                                <li>角色：<strong>檢視者</strong></li>
                                <li>完成後重新執行此工具</li>
                            </ol>
                        </div>
                    `;
                    loadingIndicator.classList.add('hidden');
                    return;
                }
                
                // 解析 CSV
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        sheetsData = results.data;
                        columns = results.meta.fields;
                        
                        statusDiv.innerHTML = `
                            <div class="success-box">
                                <strong>✅ 成功載入資料！</strong>
                                <p>共找到 ${sheetsData.length} 筆團購資料</p>
                                <p>共有 ${columns.length} 個欄位</p>
                            </div>
                        `;
                        
                        checkColumns();
                        checkImageData();
                        loadingIndicator.classList.add('hidden');
                    },
                    error: (error) => {
                        statusDiv.innerHTML = `
                            <div class="error-box">
                                <strong>❌ 解析錯誤</strong>
                                <p>${error.message}</p>
                            </div>
                        `;
                        loadingIndicator.classList.add('hidden');
                    }
                });
                
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="error-box">
                        <strong>❌ 載入失敗</strong>
                        <p>${error.message}</p>
                    </div>
                `;
                loadingIndicator.classList.add('hidden');
            }
        }
        
        function checkColumns() {
            const columnDiv = document.getElementById('columnCheck');
            
            if (columns.length === 0) {
                columnDiv.innerHTML = '<div class="info-box">尚未載入資料</div>';
                return;
            }
            
            // 檢查重要欄位
            const requiredColumns = ['品牌', '連結', '圖片網址'];
            const englishColumns = ['Brand', 'URL', 'Image'];
            
            let html = '<h3>📋 欄位列表：</h3><ul>';
            columns.forEach(col => {
                html += `<li><code>${col}</code></li>`;
            });
            html += '</ul>';
            
            // 檢查圖片欄位
            const imageColumns = columns.filter(col => 
                col.includes('圖') || 
                col.includes('Image') || 
                col.includes('image') || 
                col.includes('IMG') ||
                col.includes('Picture') ||
                col.includes('Photo')
            );
            
            if (imageColumns.length > 0) {
                html += `
                    <div class="success-box">
                        <strong>✅ 找到圖片相關欄位：</strong>
                        <ul>
                            ${imageColumns.map(col => `<li><code>${col}</code></li>`).join('')}
                        </ul>
                    </div>
                `;
            } else {
                html += `
                    <div class="error-box">
                        <strong>❌ 未找到圖片欄位！</strong>
                        <p>您的 Sheets 中沒有包含「圖片」或「Image」的欄位名稱</p>
                        <p><strong>建議：</strong>新增一個名為「圖片網址」的欄位</p>
                    </div>
                `;
            }
            
            // 檢查程式碼期望的欄位
            html += `
                <div class="info-box">
                    <strong>📝 程式碼尋找的欄位名稱：</strong>
                    <ul>
                        <li><code>圖片網址</code> （優先）</li>
                        <li><code>Image</code> （次選）</li>
                    </ul>
                    ${!columns.includes('圖片網址') && !columns.includes('Image') ? 
                        '<p style="color: #ff9800; font-weight: bold;">⚠️ 您的欄位名稱和程式碼不匹配！</p>' : 
                        '<p style="color: #28a745; font-weight: bold;">✅ 欄位名稱正確！</p>'
                    }
                </div>
            `;
            
            columnDiv.innerHTML = html;
        }
        
        function checkImageData() {
            const imageDiv = document.getElementById('imageData');
            
            if (sheetsData.length === 0) {
                imageDiv.innerHTML = '<div class="info-box">尚未載入資料</div>';
                return;
            }
            
            // 找出所有可能的圖片欄位
            const possibleImageColumns = columns.filter(col => 
                col.includes('圖') || 
                col.includes('Image') || 
                col.includes('image') ||
                col.includes('Picture') ||
                col.includes('Photo')
            );
            
            if (possibleImageColumns.length === 0) {
                imageDiv.innerHTML = `
                    <div class="error-box">
                        <strong>❌ 無法找到圖片欄位</strong>
                        <p>請確認 Google Sheets 中有圖片相關的欄位</p>
                    </div>
                `;
                return;
            }
            
            // 分析每個可能的圖片欄位
            let html = '<h3>🔍 圖片欄位分析：</h3>';
            
            possibleImageColumns.forEach(colName => {
                const values = sheetsData.map(row => row[colName]).filter(v => v && v.trim());
                const emptyCount = sheetsData.length - values.length;
                
                html += `
                    <div class="info-box">
                        <h4>欄位：<code>${colName}</code></h4>
                        <p>有值的筆數：${values.length} / ${sheetsData.length}</p>
                        <p>空白筆數：${emptyCount}</p>
                `;
                
                if (values.length > 0) {
                    // 檢查網址格式
                    const validUrls = values.filter(v => v.startsWith('http'));
                    const driveUrls = values.filter(v => v.includes('drive.google.com'));
                    const directUrls = values.filter(v => v.includes('drive.google.com/uc?export=view'));
                    
                    html += `
                        <p>✅ 有效網址：${validUrls.length}</p>
                        <p>📁 Google Drive 連結：${driveUrls.length}</p>
                        <p>🎯 直接連結格式：${directUrls.length}</p>
                    `;
                    
                    if (driveUrls.length > directUrls.length) {
                        html += `
                            <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                                <strong>⚠️ 警告：</strong>
                                <p>有 ${driveUrls.length - directUrls.length} 個連結不是直接連結格式</p>
                                <p>這些連結可能無法正確顯示圖片</p>
                            </div>
                        `;
                    }
                    
                    // 顯示範例
                    html += `
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #4CAF50; font-weight: bold;">
                                點擊查看前 3 個網址範例
                            </summary>
                            <div class="code">
                                ${values.slice(0, 3).map((v, i) => `${i + 1}. ${v}`).join('<br>')}
                            </div>
                        </details>
                    `;
                } else {
                    html += '<p style="color: #dc3545;">❌ 此欄位所有值都是空白！</p>';
                }
                
                html += '</div>';
            });
            
            imageDiv.innerHTML = html;
        }
        
        async function testImages() {
            const testDiv = document.getElementById('imageTest');
            testDiv.innerHTML = '<p>🔄 測試中...</p>';
            
            if (sheetsData.length === 0) {
                testDiv.innerHTML = '<div class="error-box">請先載入資料</div>';
                return;
            }
            
            // 找出圖片欄位
            const imageColumn = columns.find(col => col === '圖片網址') || 
                               columns.find(col => col === 'Image') ||
                               columns.find(col => col.includes('圖')) ||
                               columns.find(col => col.toLowerCase().includes('image'));
            
            if (!imageColumn) {
                testDiv.innerHTML = '<div class="error-box">❌ 找不到圖片欄位</div>';
                return;
            }
            
            // 準備測試
            const imagesToTest = sheetsData
                .filter(row => row[imageColumn] && row[imageColumn].trim())
                .slice(0, 5); // 只測試前 5 個
            
            let html = `
                <h3>🖼️ 測試結果（前 5 個圖片）：</h3>
                <p>使用欄位：<code>${imageColumn}</code></p>
                <table>
                    <thead>
                        <tr>
                            <th>品牌</th>
                            <th>圖片網址</th>
                            <th>狀態</th>
                            <th>預覽</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const row of imagesToTest) {
                const brand = row['品牌'] || row['Brand'] || '未知';
                const imageUrl = row[imageColumn];
                
                html += `
                    <tr>
                        <td>${brand}</td>
                        <td><code style="font-size: 12px;">${imageUrl.substring(0, 50)}...</code></td>
                        <td id="status-${brand}">測試中...</td>
                        <td id="preview-${brand}"></td>
                    </tr>
                `;
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            testDiv.innerHTML = html;
            
            // 實際測試圖片
            for (const row of imagesToTest) {
                const brand = row['品牌'] || row['Brand'] || '未知';
                const imageUrl = row[imageColumn];
                
                try {
                    await testImageLoad(imageUrl, brand);
                } catch (error) {
                    document.getElementById(`status-${brand}`).innerHTML = 
                        `<span class="status-error">❌ 失敗</span>`;
                    document.getElementById(`preview-${brand}`).innerHTML = 
                        error.message;
                }
            }
            
            generateSuggestions();
        }
        
        function testImageLoad(url, brand) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const startTime = Date.now();
                
                img.onload = () => {
                    const loadTime = Date.now() - startTime;
                    document.getElementById(`status-${brand}`).innerHTML = 
                        `<span class="status-ok">✅ 成功 (${loadTime}ms)</span>`;
                    document.getElementById(`preview-${brand}`).innerHTML = 
                        `<img src="${url}" class="test-image" alt="${brand}">`;
                    resolve();
                };
                
                img.onerror = () => {
                    document.getElementById(`status-${brand}`).innerHTML = 
                        `<span class="status-error">❌ 失敗</span>`;
                    document.getElementById(`preview-${brand}`).innerHTML = 
                        '無法載入';
                    reject(new Error('載入失敗'));
                };
                
                // 設定 2 秒超時
                setTimeout(() => {
                    if (!img.complete) {
                        img.src = '';
                        document.getElementById(`status-${brand}`).innerHTML = 
                            `<span class="status-error">⏱️ 超時</span>`;
                        reject(new Error('載入超時'));
                    }
                }, 2000);
                
                img.src = url;
            });
        }
        
        function generateSuggestions() {
            const suggestionsDiv = document.getElementById('suggestions');
            
            let suggestions = [];
            
            // 檢查欄位名稱
            if (!columns.includes('圖片網址') && !columns.includes('Image')) {
                suggestions.push({
                    title: '修正欄位名稱',
                    content: `
                        <p><strong>問題：</strong>欄位名稱不符合程式碼期望</p>
                        <p><strong>解決方法：</strong></p>
                        <ol>
                            <li>開啟 Google Sheets</li>
                            <li>找到圖片欄位的標題</li>
                            <li>改名為：<code>圖片網址</code> 或 <code>Image</code></li>
                            <li>確認沒有多餘空格</li>
                        </ol>
                    `
                });
            }
            
            // 檢查網址格式
            const imageColumn = columns.find(col => col.includes('圖') || col.toLowerCase().includes('image'));
            if (imageColumn) {
                const values = sheetsData.map(row => row[imageColumn]).filter(v => v && v.trim());
                const driveUrls = values.filter(v => v.includes('drive.google.com'));
                const directUrls = values.filter(v => v.includes('drive.google.com/uc?export=view'));
                
                if (driveUrls.length > directUrls.length) {
                    suggestions.push({
                        title: '轉換網址格式',
                        content: `
                            <p><strong>問題：</strong>有 ${driveUrls.length - directUrls.length} 個 Google Drive 連結格式不正確</p>
                            <p><strong>解決方法：</strong></p>
                            <p>將：<code>https://drive.google.com/file/d/檔案ID/view</code></p>
                            <p>改成：<code>https://drive.google.com/uc?export=view&id=檔案ID</code></p>
                            <p><strong>或使用 n8n 自動化工具批次轉換</strong></p>
                        `
                    });
                }
            }
            
            // 檢查空白值
            if (imageColumn) {
                const emptyCount = sheetsData.filter(row => !row[imageColumn] || !row[imageColumn].trim()).length;
                if (emptyCount > 0) {
                    suggestions.push({
                        title: '補充缺少的圖片',
                        content: `
                            <p><strong>問題：</strong>有 ${emptyCount} 筆團購沒有圖片網址</p>
                            <p><strong>解決方法：</strong></p>
                            <ol>
                                <li>為這些團購準備圖片</li>
                                <li>上傳到 Google Drive</li>
                                <li>設定為公開分享</li>
                                <li>取得直接連結</li>
                                <li>填入 Google Sheets</li>
                            </ol>
                        `
                    });
                }
            }
            
            // 顯示建議
            if (suggestions.length === 0) {
                suggestionsDiv.innerHTML = `
                    <div class="success-box">
                        <strong>🎉 太棒了！沒有發現問題！</strong>
                        <p>如果圖片還是無法顯示，可能是瀏覽器快取問題</p>
                        <p>請嘗試：Ctrl + Shift + R 強制重新整理</p>
                    </div>
                `;
            } else {
                let html = '<h3>💡 修正建議：</h3>';
                suggestions.forEach((suggestion, index) => {
                    html += `
                        <div class="error-box">
                            <h4>${index + 1}. ${suggestion.title}</h4>
                            ${suggestion.content}
                        </div>
                    `;
                });
                suggestionsDiv.innerHTML = html;
            }
        }
        
        // 頁面載入時提示
        window.onload = () => {
            document.getElementById('sheetStatus').innerHTML = `
                <div class="info-box">
                    <strong>👋 歡迎使用 Debug 工具！</strong>
                    <p>點擊上方按鈕開始檢查</p>
                </div>
            `;
        };
    </script>
</body>
</html>
