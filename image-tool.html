<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>圖片壓縮 + 浮水印工具 - 鷹家Fun生買物社</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🖼️</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-amber-50 via-orange-50 to-pink-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white/80 backdrop-blur-sm border-b-2 border-amber-200 sticky top-0 z-10 shadow-sm">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-amber-900">🖼️ 圖片壓縮 + 浮水印</h1>
          <p class="text-sm text-amber-700">鷹家Fun生買物社 - 優化圖片，保護版權</p>
        </div>
        <a href="/" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">
          返回首頁
        </a>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    <!-- 說明卡片 -->
    <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6 mb-6">
      <h2 class="text-lg font-bold text-blue-900 mb-2">📚 工具功能</h2>
      <div class="grid md:grid-cols-2 gap-4 text-sm text-blue-800">
        <div>
          <p class="font-semibold mb-1">🗜️ 圖片壓縮</p>
          <p class="text-xs">減少檔案大小，加快網頁載入速度</p>
        </div>
        <div>
          <p class="font-semibold mb-1">💧 浮水印</p>
          <p class="text-xs">自動加上品牌浮水印，防止盜圖</p>
        </div>
      </div>
    </div>

    <!-- 上傳區域 -->
    <div class="bg-white rounded-xl shadow-lg border-2 border-amber-200 overflow-hidden">
      <div class="bg-gradient-to-r from-amber-600 to-pink-600 p-4">
        <h2 class="text-xl font-bold text-white">上傳圖片</h2>
      </div>

      <div class="p-6">
        <!-- 拖拽上傳區 -->
        <div 
          id="dropZone"
          class="border-4 border-dashed border-gray-300 rounded-xl p-12 text-center hover:border-amber-400 transition-colors cursor-pointer bg-gray-50"
          onclick="document.getElementById('fileInput').click()"
        >
          <div class="text-6xl mb-4">📤</div>
          <p class="text-lg font-bold text-gray-700 mb-2">拖曳圖片到這裡或點擊上傳</p>
          <p class="text-sm text-gray-500">支援 JPG、PNG、WebP 格式</p>
          <input 
            type="file" 
            id="fileInput" 
            accept="image/*" 
            class="hidden" 
            onchange="handleFileSelect(event)"
            multiple
          >
        </div>

        <!-- 設定選項 -->
        <div id="optionsPanel" class="mt-6 space-y-5 hidden">
          <!-- 壓縮品質 -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <label class="text-sm font-bold text-gray-700">壓縮品質</label>
              <span id="qualityValue" class="text-sm font-bold text-amber-600">80%</span>
            </div>
            <input 
              type="range" 
              id="qualitySlider" 
              min="10" 
              max="100" 
              value="80" 
              class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
              oninput="updateQuality(this.value)"
            >
            <div class="flex justify-between text-xs text-gray-500 mt-1">
              <span>較小檔案</span>
              <span>較高品質</span>
            </div>
          </div>

          <!-- 最大寬度 -->
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">最大寬度（像素）</label>
            <select 
              id="maxWidth" 
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-amber-400 focus:outline-none"
            >
              <option value="0">保持原尺寸</option>
              <option value="800">800px（適合網頁）</option>
              <option value="1200" selected>1200px（推薦）</option>
              <option value="1920">1920px（高解析度）</option>
              <option value="2400">2400px（超高解析度）</option>
            </select>
          </div>

          <!-- 浮水印選項 -->
          <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4">
            <div class="flex items-center gap-2 mb-3">
              <input 
                type="checkbox" 
                id="addWatermark" 
                class="w-5 h-5 text-purple-600 rounded"
                checked
              >
              <label for="addWatermark" class="text-sm font-bold text-purple-900">加入浮水印</label>
            </div>
            
            <div id="watermarkOptions" class="space-y-3">
              <div>
                <label class="block text-xs font-bold text-purple-700 mb-1">浮水印文字</label>
                <input 
                  type="text" 
                  id="watermarkText" 
                  value="鷹家Fun生買物社"
                  class="w-full px-3 py-2 rounded-lg border-2 border-purple-200 focus:border-purple-400 focus:outline-none text-sm"
                >
              </div>
              
              <div>
                <label class="block text-xs font-bold text-purple-700 mb-1">位置</label>
                <select 
                  id="watermarkPosition" 
                  class="w-full px-3 py-2 rounded-lg border-2 border-purple-200 focus:border-purple-400 focus:outline-none text-sm"
                >
                  <option value="bottom-right">右下角</option>
                  <option value="bottom-left">左下角</option>
                  <option value="top-right">右上角</option>
                  <option value="top-left">左上角</option>
                  <option value="center">中央</option>
                </select>
              </div>
              
              <div>
                <label class="block text-xs font-bold text-purple-700 mb-1">透明度</label>
                <input 
                  type="range" 
                  id="watermarkOpacity" 
                  min="10" 
                  max="100" 
                  value="50" 
                  class="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer"
                >
                <div class="flex justify-between text-xs text-purple-600 mt-1">
                  <span>淡</span>
                  <span id="opacityValue">50%</span>
                  <span>濃</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 處理按鈕 -->
          <button 
            onclick="processImages()" 
            class="w-full bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white py-4 rounded-xl font-bold text-lg transition-all shadow-lg hover:shadow-xl">
            ✨ 開始處理圖片
          </button>
        </div>
      </div>
    </div>

    <!-- 預覽區域 -->
    <div id="previewSection" class="mt-6 hidden">
      <div class="bg-white rounded-xl shadow-lg border-2 border-green-200 overflow-hidden">
        <div class="bg-gradient-to-r from-green-600 to-teal-600 p-4">
          <h2 class="text-xl font-bold text-white">✨ 處理結果</h2>
        </div>
        
        <div id="resultsContainer" class="p-6 space-y-6">
          <!-- 處理後的圖片會動態加入這裡 -->
        </div>
      </div>
    </div>

    <!-- 使用提醒 -->
    <div class="mt-6 bg-amber-50 rounded-xl border-2 border-amber-200 p-6">
      <h3 class="text-lg font-bold text-amber-900 mb-3">💡 使用建議</h3>
      <ul class="text-sm text-amber-800 space-y-2">
        <li>✅ <strong>壓縮品質</strong>：80% 是品質與檔案大小的最佳平衡</li>
        <li>✅ <strong>網頁用圖</strong>：建議最大寬度 1200px，檔案小載入快</li>
        <li>✅ <strong>浮水印</strong>：透明度 40-60% 既能保護版權又不影響觀看</li>
        <li>✅ <strong>批次處理</strong>：可以一次上傳多張圖片同時處理</li>
        <li>✅ <strong>原圖保留</strong>：處理後的圖片不會覆蓋原圖，請放心使用</li>
      </ul>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white/80 border-t-2 border-amber-200 mt-12 py-6">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <p class="text-sm text-amber-700">© 2025 鷹家Fun生買物社 | 圖片壓縮工具</p>
      <p class="text-xs text-amber-600 mt-1">Eaglish Family - 精選團購．優質好物</p>
    </div>
  </footer>

  <!-- Loading Toast -->
  <div id="loadingToast" class="fixed top-20 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50 hidden">
    <div class="flex items-center gap-2">
      <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
      <span>處理中...</span>
    </div>
  </div>

  <script>
    let uploadedFiles = [];

    // 更新品質顯示
    function updateQuality(value) {
      document.getElementById('qualityValue').textContent = value + '%';
    }

    // 更新透明度顯示
    document.getElementById('watermarkOpacity').addEventListener('input', function() {
      document.getElementById('opacityValue').textContent = this.value + '%';
    });

    // 浮水印開關
    document.getElementById('addWatermark').addEventListener('change', function() {
      document.getElementById('watermarkOptions').style.display = this.checked ? 'block' : 'none';
    });

    // 拖拽上傳
    const dropZone = document.getElementById('dropZone');

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('border-amber-400', 'bg-amber-50');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('border-amber-400', 'bg-amber-50');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-amber-400', 'bg-amber-50');
      
      const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
      if (files.length > 0) {
        handleFiles(files);
      }
    });

    // 檔案選擇
    function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      handleFiles(files);
    }

    function handleFiles(files) {
      uploadedFiles = files;
      document.getElementById('optionsPanel').classList.remove('hidden');
      
      // 顯示檔案資訊
      const info = files.length === 1 
        ? `已選擇 1 張圖片` 
        : `已選擇 ${files.length} 張圖片`;
      
      dropZone.innerHTML = `
        <div class="text-6xl mb-4">✓</div>
        <p class="text-lg font-bold text-green-600 mb-2">${info}</p>
        <p class="text-sm text-gray-500">點擊可重新選擇</p>
      `;
    }

    // 處理圖片
    async function processImages() {
      if (uploadedFiles.length === 0) {
        alert('請先上傳圖片！');
        return;
      }

      // 顯示載入提示
      const loadingToast = document.getElementById('loadingToast');
      loadingToast.classList.remove('hidden');
      loadingToast.style.opacity = '1';

      // 取得設定
      const quality = parseInt(document.getElementById('qualitySlider').value) / 100;
      const maxWidth = parseInt(document.getElementById('maxWidth').value);
      const addWatermark = document.getElementById('addWatermark').checked;
      const watermarkText = document.getElementById('watermarkText').value;
      const watermarkPosition = document.getElementById('watermarkPosition').value;
      const watermarkOpacity = parseInt(document.getElementById('watermarkOpacity').value) / 100;

      // 清空結果容器
      const resultsContainer = document.getElementById('resultsContainer');
      resultsContainer.innerHTML = '';

      // 處理每張圖片
      for (let i = 0; i < uploadedFiles.length; i++) {
        const file = uploadedFiles[i];
        const result = await processImage(file, {
          quality,
          maxWidth,
          addWatermark,
          watermarkText,
          watermarkPosition,
          watermarkOpacity
        });

        // 顯示結果
        resultsContainer.innerHTML += createResultCard(file, result, i);
      }

      // 隱藏載入提示
      loadingToast.style.opacity = '0';
      setTimeout(() => loadingToast.classList.add('hidden'), 300);

      // 顯示結果區域
      document.getElementById('previewSection').classList.remove('hidden');
      
      // 滾動到結果
      setTimeout(() => {
        document.getElementById('previewSection').scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });
      }, 100);
    }

    // 處理單張圖片
    function processImage(file, options) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const img = new Image();
          
          img.onload = function() {
            // 計算新尺寸
            let width = img.width;
            let height = img.height;
            
            if (options.maxWidth > 0 && width > options.maxWidth) {
              height = (height * options.maxWidth) / width;
              width = options.maxWidth;
            }

            // 建立 canvas
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            // 繪製圖片
            ctx.drawImage(img, 0, 0, width, height);

            // 加入浮水印
            if (options.addWatermark && options.watermarkText) {
              addWatermarkToCanvas(ctx, width, height, options);
            }

            // 轉換為 blob
            canvas.toBlob((blob) => {
              const url = URL.createObjectURL(blob);
              
              resolve({
                url,
                blob,
                originalSize: file.size,
                newSize: blob.size,
                width,
                height
              });
            }, file.type, options.quality);
          };

          img.src = e.target.result;
        };

        reader.readAsDataURL(file);
      });
    }

    // 在 canvas 上加浮水印
    function addWatermarkToCanvas(ctx, width, height, options) {
      ctx.save();
      
      // 設定文字樣式
      const fontSize = Math.max(width * 0.04, 20);
      ctx.font = `bold ${fontSize}px Arial`;
      ctx.fillStyle = `rgba(255, 255, 255, ${options.watermarkOpacity})`;
      ctx.strokeStyle = `rgba(0, 0, 0, ${options.watermarkOpacity * 0.5})`;
      ctx.lineWidth = 2;

      // 計算文字尺寸
      const textMetrics = ctx.measureText(options.watermarkText);
      const textWidth = textMetrics.width;
      const textHeight = fontSize;

      // 計算位置
      let x, y;
      const padding = 20;

      switch (options.watermarkPosition) {
        case 'bottom-right':
          x = width - textWidth - padding;
          y = height - padding;
          break;
        case 'bottom-left':
          x = padding;
          y = height - padding;
          break;
        case 'top-right':
          x = width - textWidth - padding;
          y = textHeight + padding;
          break;
        case 'top-left':
          x = padding;
          y = textHeight + padding;
          break;
        case 'center':
          x = (width - textWidth) / 2;
          y = height / 2;
          break;
      }

      // 繪製文字（帶陰影）
      ctx.strokeText(options.watermarkText, x, y);
      ctx.fillText(options.watermarkText, x, y);
      
      ctx.restore();
    }

    // 建立結果卡片
    function createResultCard(originalFile, result, index) {
      const compressionRate = ((1 - result.newSize / result.originalSize) * 100).toFixed(1);
      const originalSizeKB = (result.originalSize / 1024).toFixed(1);
      const newSizeKB = (result.newSize / 1024).toFixed(1);

      return `
        <div class="border-2 border-gray-200 rounded-lg overflow-hidden">
          <div class="grid md:grid-cols-2 gap-6 p-6">
            <!-- 預覽圖 -->
            <div>
              <p class="text-sm font-bold text-gray-700 mb-2">處理後預覽</p>
              <img src="${result.url}" alt="處理後" class="w-full rounded-lg border-2 border-gray-300">
            </div>
            
            <!-- 資訊 -->
            <div>
              <p class="text-sm font-bold text-gray-700 mb-3">處理資訊</p>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">檔案名稱：</span>
                  <span class="font-medium text-gray-900">${originalFile.name}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">原始大小：</span>
                  <span class="font-medium text-gray-900">${originalSizeKB} KB</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">壓縮後：</span>
                  <span class="font-medium text-green-600">${newSizeKB} KB</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">節省空間：</span>
                  <span class="font-bold text-green-600">${compressionRate}%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">尺寸：</span>
                  <span class="font-medium text-gray-900">${result.width} x ${result.height} px</span>
                </div>
              </div>
              
              <!-- 下載按鈕 -->
              <button 
                onclick="downloadImage(${index}, '${originalFile.name}')"
                class="w-full mt-6 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white py-3 rounded-lg font-bold transition-all shadow-md hover:shadow-lg">
                📥 下載圖片
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // 下載圖片
    function downloadImage(index, originalName) {
      const resultsContainer = document.getElementById('resultsContainer');
      const img = resultsContainer.querySelectorAll('img')[index];
      
      const link = document.createElement('a');
      const fileName = originalName.replace(/\.[^/.]+$/, '') + '_processed.jpg';
      link.download = fileName;
      link.href = img.src;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
